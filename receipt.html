<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø§Ù„Ø¥ÙŠØµØ§Ù„ - Gift Star</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800;900&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="css/style.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
<header class="site-header" id="mainHeader">
  <div class="header-main">
    <div class="container header-flex">
      <a href="index.html" class="logo">
        <div class="logo-star">â˜…</div>
        <div class="logo-text">
          <span class="logo-gift">Gift</span>
          <span class="logo-star-word">Star</span>
        </div>
      </a>
      <nav class="main-nav">
        <a href="index.html">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
        <a href="shop.html">Ø§Ù„Ù…ØªØ¬Ø±</a>
        <a href="my-orders.html">Ø·Ù„Ø¨Ø§ØªÙŠ</a>
      </nav>
      <div class="header-links">
        <a href="cart.html" class="cart-link">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="9" cy="21" r="1"/>
            <circle cx="20" cy="21" r="1"/>
            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
          </svg>
          <span class="cart-count" id="cartCount">0</span>
        </a>
        <a href="login.html" class="btn-login" id="loginBtn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a>
        <a href="#" class="btn-login" id="logoutBtn" style="display:none" onclick="logout()">Ø®Ø±ÙˆØ¬</a>
      </div>
    </div>
  </div>
</header>

<div class="receipt-page">
  <div class="receipt-card">
    <div class="receipt-header">
      <div class="receipt-check">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3">
          <polyline points="20 6 9 17 4 12"/>
        </svg>
      </div>
      <h2 id="receiptTitle">ØªÙ… Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­!</h2>
      <p id="receiptSubtitle">Ø´ÙƒØ±Ø§Ù‹ Ù„ÙƒØŒ Ø³ÙŠØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ù‚Ø±ÙŠØ¨Ø§Ù‹ Ù„Ù„ØªØ£ÙƒÙŠØ¯</p>
    </div>

    <div class="receipt-number" id="receiptNum"></div>
    <div class="receipt-details" id="receiptDetails"></div>
    <div class="receipt-items" id="receiptItems"></div>
    <div class="receipt-total" id="receiptTotal"></div>
    <div class="receipt-payment" id="receiptPayment"></div>
    <div class="receipt-status" id="receiptStatus"></div>

    <div class="receipt-actions" id="receiptActions">
      <button class="btn-primary" onclick="printPDF()">ğŸ“„ Ø·Ø¨Ø§Ø¹Ø© PDF</button>
      <a href="index.html" class="btn-outline">ğŸ  Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
      <a href="my-orders.html" class="btn-outline">ğŸ“‹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</a>
    </div>
  </div>
</div>

<div class="stars-bg"></div>

<script src="js/data.js"></script>
<script>
// ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø©
async function init() {
  try {
    // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³Ù„Ø©
    updateCartCount();
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ orderId ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·
    const urlParams = new URLSearchParams(window.location.search);
    const orderId = urlParams.get('order');
    
    let order;
    
    if (orderId) {
      // Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      const orders = await giftstar.getData('orders') || [];
      order = orders.find(o => o.id === orderId);
      
      if (order) {
        document.getElementById('receiptTitle').textContent = 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨';
        document.getElementById('receiptSubtitle').textContent = 'Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø³Ø§Ø¨Ù‚';
      }
    } else {
      // Ø¬Ù„Ø¨ Ø¢Ø®Ø± Ø·Ù„Ø¨ Ù…Ù† session
      order = JSON.parse(sessionStorage.getItem('giftstar_last_order') || 'null');
    }
    
    if (!order) {
      showError('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨');
      return;
    }

    // Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø·Ù„Ø¨
    displayOrder(order);
    
  } catch (error) {
    console.error('Error loading order:', error);
    showError('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨');
  }
}

// Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨
function displayOrder(order) {
  // Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨
  document.getElementById('receiptNum').innerHTML = `
    <div class="receipt-row">
      <span>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</span>
      <strong>${order.id}</strong>
    </div>
  `;

  // ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„
  const customer = order.customer || {};
  document.getElementById('receiptDetails').innerHTML = `
    <div class="receipt-row">
      <span>ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…</span>
      <strong>${customer.name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</strong>
    </div>
    <div class="receipt-row">
      <span>ğŸ“ Ø§Ù„Ù‡Ø§ØªÙ</span>
      <strong>${customer.phone || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</strong>
    </div>
    <div class="receipt-row">
      <span>ğŸ“ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</span>
      <strong>${customer.area || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</strong>
    </div>
    <div class="receipt-row">
      <span>ğŸ  Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</span>
      <strong>${customer.address || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</strong>
    </div>
    <div class="receipt-row">
      <span>ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®</span>
      <strong>${order.date || ''} - ${order.time || ''}</strong>
    </div>
  `;

  // Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
  const items = order.items || [];
  document.getElementById('receiptItems').innerHTML = items.map(item => `
    <div class="receipt-row">
      <span>${item.name} <small>(x${item.qty})</small></span>
      <strong>${formatKWD(item.price * item.qty)}</strong>
    </div>
  `).join('') + `
    <div class="receipt-row" style="border-top: 1px dashed var(--border); margin-top: 8px; padding-top: 8px;">
      <span>ğŸšš Ø§Ù„ØªÙˆØµÙŠÙ„</span>
      <strong>${order.delivery === 0 ? 'Ù…Ø¬Ø§Ù†ÙŠ' : formatKWD(order.delivery || 0)}</strong>
    </div>
  `;

  // Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹
  document.getElementById('receiptTotal').innerHTML = `
    <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</span>
    <span class="total-amount">${formatKWD(order.total || 0)}</span>
  `;

  // Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹
  document.getElementById('receiptPayment').innerHTML = `
    <div class="receipt-row">
      <span>ğŸ’³ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</span>
      <strong>${order.paymentMethod || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</strong>
    </div>
  `;

  // Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨
  if (order.status) {
    const statusText = {
      'new': 'Ø¬Ø¯ÙŠØ¯',
      'processing': 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©',
      'delivered': 'ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„',
      'cancelled': 'Ù…Ù„ØºÙŠ'
    }[order.status] || order.status;
    
    document.getElementById('receiptStatus').innerHTML = `
      <div class="receipt-row" style="margin-top: 16px; padding-top: 16px; border-top: 2px solid var(--border);">
        <span>ğŸ“Š Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨</span>
        <span class="status-badge ${order.status}">${statusText}</span>
      </div>
    `;
  }

  // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± (Ù„ÙŠØ³ Ù…Ù† Ø§Ù„Ø³Ø¬Ù„)ØŒ Ù†Ø®ÙÙŠ Ø¨Ø¹Ø¶ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
  if (!orderId) {
    const actions = document.getElementById('receiptActions');
    actions.innerHTML = `
      <button class="btn-primary" onclick="printPDF()">ğŸ“„ Ø·Ø¨Ø§Ø¹Ø© PDF</button>
      <a href="index.html" class="btn-outline">ğŸ  Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
    `;
  }
}

// ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¹Ù…Ù„Ø©
function formatKWD(amount) {
  return Number(amount).toFixed(3) + ' Ø¯.Ùƒ';
}

// Ø·Ø¨Ø§Ø¹Ø© PDF
function printPDF() {
  try {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ 
      orientation: 'portrait', 
      unit: 'mm', 
      format: 'a4' 
    });
    
    // Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„ØµÙØ­Ø©
    const orderId = document.querySelector('#receiptNum strong')?.textContent || '';
    const order = JSON.parse(sessionStorage.getItem('giftstar_last_order') || 'null');
    
    if (!order) {
      alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©');
      return;
    }

    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®Ø·
    doc.setFont('helvetica', 'bold');
    
    // Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
    doc.setFontSize(24);
    doc.setTextColor(200, 169, 110);
    doc.text('Gift Star', 105, 25, { align: 'center' });
    
    doc.setFontSize(12);
    doc.setTextColor(100, 100, 100);
    doc.text('Kuwait Gift Store', 105, 33, { align: 'center' });
    
    // Ø®Ø· ÙØ§ØµÙ„
    doc.setDrawColor(200, 169, 110);
    doc.setLineWidth(0.5);
    doc.line(20, 38, 190, 38);

    // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø·Ù„Ø¨
    doc.setTextColor(0, 0, 0);
    doc.setFontSize(14);
    doc.setFont('helvetica', 'bold');
    doc.text('Order Receipt', 20, 48);
    
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(11);
    doc.text('Order ID: ' + order.id, 20, 56);
    doc.text('Date: ' + order.date + ' ' + order.time, 20, 63);

    // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„
    doc.line(20, 68, 190, 68);
    doc.setFont('helvetica', 'bold');
    doc.text('Customer Information:', 20, 76);
    doc.setFont('helvetica', 'normal');
    doc.text('Name: ' + (order.customer?.name || 'N/A'), 20, 84);
    doc.text('Phone: ' + (order.customer?.phone || 'N/A'), 20, 91);
    doc.text('Area: ' + (order.customer?.area || 'N/A'), 20, 98);
    doc.text('Address: ' + (order.customer?.address || 'N/A'), 20, 105);

    // Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
    doc.line(20, 110, 190, 110);
    doc.setFont('helvetica', 'bold');
    doc.text('Order Items:', 20, 118);
    doc.setFont('helvetica', 'normal');

    let y = 126;
    let subtotal = 0;
    
    (order.items || []).forEach(item => {
      const itemTotal = item.price * item.qty;
      subtotal += itemTotal;
      
      doc.text(item.name + ' x' + item.qty, 20, y);
      doc.text(formatKWD(itemTotal), 170, y, { align: 'right' });
      y += 8;
      
      if (y > 270) {
        doc.addPage();
        y = 20;
      }
    });

    // Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹
    doc.line(20, y + 2, 190, y + 2);
    y += 8;
    
    doc.text('Subtotal:', 20, y);
    doc.text(formatKWD(subtotal), 170, y, { align: 'right' });
    
    y += 8;
    doc.text('Delivery:', 20, y);
    doc.text(order.delivery === 0 ? 'Free' : formatKWD(order.delivery), 170, y, { align: 'right' });
    
    y += 8;
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(13);
    doc.text('TOTAL:', 20, y);
    doc.text(formatKWD(order.total || 0), 170, y, { align: 'right' });

    // Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹
    y += 10;
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(10);
    doc.text('Payment Method: ' + (order.paymentMethod || 'N/A'), 20, y);

    // ØªØ°ÙŠÙŠÙ„
    y += 15;
    doc.line(20, y, 190, y);
    y += 8;
    doc.setFontSize(10);
    doc.setTextColor(150, 150, 150);
    doc.text('Thank you for shopping at Gift Star', 105, y, { align: 'center' });
    doc.text('www.giftstar.com.kw', 105, y + 6, { align: 'center' });

    // Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù
    doc.save('GiftStar-Receipt-' + order.id + '.pdf');
    
  } catch (error) {
    console.error('Error generating PDF:', error);
    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù PDF');
  }
}

// Ø¹Ø±Ø¶ Ø®Ø·Ø£
function showError(message) {
  const container = document.querySelector('.receipt-card');
  container.innerHTML = `
    <div style="text-align: center; padding: 40px 20px;">
      <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="var(--danger)" stroke-width="2">
        <circle cx="12" cy="12" r="10"/>
        <line x1="12" y1="8" x2="12" y2="12"/>
        <circle cx="12" cy="16" r="1" fill="var(--danger)"/>
      </svg>
      <h3 style="margin: 20px 0 10px; color: var(--text);">Ø¹Ø°Ø±Ø§Ù‹</h3>
      <p style="color: var(--text-muted); margin-bottom: 30px;">${message}</p>
      <a href="index.html" class="btn-primary">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
    </div>
  `;
}

// ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³Ù„Ø©
function updateCartCount() {
  const cart = giftstar.getCart();
  const total = cart.reduce((sum, item) => sum + item.qty, 0);
  document.querySelectorAll('.cart-count').forEach(el => {
    if (el) el.textContent = total;
  });
}

// ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
function logout() {
  giftstar.logout();
}

// ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
