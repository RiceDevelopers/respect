<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø§Ù„Ø¥ÙŠØµØ§Ù„ - Gift Star</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800;900&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="css/style.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
  /* Ù†ÙØ³ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© */
  .receipt-page { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 40px 20px; background: linear-gradient(135deg, var(--secondary) 0%, #0a0e1a 100%); }
  .receipt-card { background: linear-gradient(135deg, var(--secondary-light) 0%, #1a1f2f 100%); border-radius: 30px; padding: 50px; width: 100%; max-width: 700px; box-shadow: 0 30px 60px rgba(0,0,0,0.5); border: 1px solid var(--border); position: relative; overflow: hidden; }
  .receipt-card::before { content: 'â˜…'; position: absolute; top: -20px; right: -20px; font-size: 200px; color: rgba(200,169,110,0.05); transform: rotate(15deg); pointer-events: none; }
  .receipt-header { text-align: center; margin-bottom: 40px; }
  .receipt-check { width: 90px; height: 90px; background: linear-gradient(135deg, #5ec98a, #3fa86a); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 25px; animation: scaleIn 0.5s ease; box-shadow: 0 10px 30px rgba(94,201,138,0.3); }
  .receipt-check svg { width: 45px; height: 45px; color: white; }
  .receipt-header h2 { font-size: 32px; font-weight: 900; color: var(--success); margin-bottom: 10px; font-family: 'Playfair Display', serif; }
  .receipt-header p { color: var(--text-muted); font-size: 16px; }
  .receipt-number { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); border-radius: 50px; padding: 15px 25px; text-align: center; margin-bottom: 30px; font-weight: 800; color: var(--secondary); font-size: 20px; box-shadow: 0 5px 15px rgba(200,169,110,0.3); }
  .receipt-details { background: rgba(0,0,0,0.2); border-radius: 20px; padding: 20px; margin-bottom: 25px; border: 1px solid var(--border); }
  .receipt-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border); color: var(--text-muted); }
  .receipt-row strong { color: var(--text); }
  .receipt-items { background: rgba(0,0,0,0.2); border-radius: 20px; padding: 20px; margin: 20px 0; }
  .receipt-items-title { font-size: 18px; font-weight: 800; color: var(--primary); margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
  .receipt-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed var(--border); }
  .receipt-item-name { display: flex; align-items: center; gap: 10px; }
  .receipt-item-qty { background: var(--primary); color: var(--secondary); width: 25px; height: 25px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 800; }
  .receipt-total { display: flex; justify-content: space-between; align-items: center; padding: 25px; background: linear-gradient(135deg, rgba(200,169,110,0.1) 0%, rgba(200,169,110,0.2) 100%); border-radius: 20px; margin: 25px 0; border: 1px solid var(--primary); }
  .receipt-total-label { font-size: 20px; font-weight: 800; color: var(--text); }
  .receipt-total-amount { font-size: 32px; font-weight: 900; color: var(--primary); }
  .receipt-payment { background: rgba(200,169,110,0.05); border-radius: 15px; padding: 15px; margin: 15px 0; border: 1px solid var(--border); }
  .status-badge { display: inline-block; padding: 8px 25px; border-radius: 30px; font-size: 16px; font-weight: 700; }
  .status-badge.new { background: rgba(94,201,138,0.2); color: #5ec98a; }
  .receipt-actions { display: flex; gap: 15px; margin-top: 40px; }
  .receipt-actions .btn-primary, .receipt-actions .btn-outline { flex: 1; text-align: center; padding: 15px; border-radius: 15px; }
  .company-signature { text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border); color: var(--text-muted); }
  .company-signature .gold { color: var(--primary); font-weight: 700; }
  .error-container { text-align: center; padding: 60px; }
  .loading { text-align: center; padding: 60px; }
  .spinner { width: 50px; height: 50px; border: 4px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 20px; }
  @keyframes spin { to { transform: rotate(360deg); } }
  @keyframes scaleIn { from { transform: scale(0); } to { transform: scale(1); } }
</style>
</head>
<body>
<header class="site-header">[Ù†ÙØ³ Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø³Ø§Ø¨Ù‚]</header>

<div class="receipt-page">
  <div class="receipt-card" id="receiptContent">
    <div class="loading"><div class="spinner"></div>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨...</div>
  </div>
</div>

<div class="stars-bg"></div>

<script src="js/data.js"></script>
<script>
function findOrder(orderId) {
    try {
        const orders = JSON.parse(localStorage.getItem('giftstar_orders') || '[]');
        return orders.find(o => o.id === orderId);
    } catch { return null; }
}

function displayOrder(order) {
    if (!order) { showError('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨'); return; }
    
    order.customer = order.customer || {};
    order.items = order.items || [];
    
    const subtotal = order.items.reduce((s,i) => s + (i.price||0)*(i.qty||1), 0);
    const delivery = order.delivery ?? (subtotal > 15 ? 0 : 1.5);
    const total = order.total || (subtotal + delivery);
    const format = window.formatKWD || (a => a.toFixed(3) + ' Ø¯.Ùƒ');
    
    document.getElementById('receiptContent').innerHTML = `
        <div class="receipt-header">
            <div class="receipt-check"><svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg></div>
            <h2>${window.location.search.includes('order=') ? 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨' : 'ØªÙ… Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­!'}</h2>
            <p>${window.location.search.includes('order=') ? 'Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨' : 'Ø´ÙƒØ±Ø§Ù‹ Ù„Ùƒ'}</p>
        </div>
        <div class="receipt-number">Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: ${order.id}</div>
        <div class="receipt-details">
            <div class="receipt-row"><span>ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…</span><strong>${order.customer.name||''}</strong></div>
            <div class="receipt-row"><span>ğŸ“ Ø§Ù„Ù‡Ø§ØªÙ</span><strong>+965 ${order.customer.phone||''}</strong></div>
            <div class="receipt-row"><span>ğŸ“ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</span><strong>${order.customer.area||''}</strong></div>
            <div class="receipt-row"><span>ğŸ  Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</span><strong>${order.customer.address||''}</strong></div>
            <div class="receipt-row"><span>ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®</span><strong>${order.date||''} ${order.time||''}</strong></div>
        </div>
        <div class="receipt-items">
            <div class="receipt-items-title"><span>ğŸ›ï¸</span><span>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</span></div>
            ${order.items.map(i => `
                <div class="receipt-item">
                    <div class="receipt-item-name"><span class="receipt-item-qty">${i.qty}</span> ${i.name}</div>
                    <span>${format(i.price * i.qty)}</span>
                </div>
            `).join('')}
        </div>
        <div class="receipt-total">
            <span class="receipt-total-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</span>
            <span class="receipt-total-amount">${format(total)}</span>
        </div>
        <div class="receipt-payment">
            <div class="receipt-row"><span>ğŸ’³ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</span><strong>${order.paymentMethod||''}</strong></div>
            <div class="receipt-row"><span>ğŸšš Ø§Ù„ØªÙˆØµÙŠÙ„</span><strong>${delivery===0?'Ù…Ø¬Ø§Ù†ÙŠ':format(delivery)}</strong></div>
        </div>
        <div class="company-signature">
            <span class="gold">Gift Star</span> - Ù…ØªØ¬Ø± Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ø§Ù„ÙƒÙˆÙŠØªÙŠ Ø§Ù„Ø£ÙˆÙ„<br>
            <small>Ù†Ø´ÙƒØ±Ùƒ Ø¹Ù„Ù‰ Ø«Ù‚ØªÙƒ âœ¨</small>
        </div>
        <div class="receipt-actions" id="receiptActions">
            <button class="btn-primary" onclick="generatePDF()">ğŸ“„ ØªØ­Ù…ÙŠÙ„ PDF</button>
            <a href="index.html" class="btn-outline">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
            <a href="my-orders.html" class="btn-outline">Ø·Ù„Ø¨Ø§ØªÙŠ</a>
        </div>
    `;
}

function showError(m) {
    document.getElementById('receiptContent').innerHTML = `
        <div class="error-container">
            <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="var(--danger)" stroke-width="2">
                <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><circle cx="12" cy="16" r="1" fill="var(--danger)"/>
            </svg>
            <h3 style="color:var(--danger);">Ø¹Ø°Ø±Ø§Ù‹</h3>
            <p>${m}</p>
            <div style="margin-top:30px;"><a href="index.html" class="btn-primary">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></div>
        </div>
    `;
}

window.generatePDF = async () => {
    const { jsPDF } = window.jspdf;
    const element = document.getElementById('receiptContent');
    const actions = document.getElementById('receiptActions');
    if (actions) actions.style.display = 'none';
    
    const canvas = await html2canvas(element, { scale: 2, backgroundColor: '#0f1326' });
    if (actions) actions.style.display = 'flex';
    
    const imgData = canvas.toDataURL('image/png');
    const pdf = new jsPDF();
    pdf.addImage(imgData, 'PNG', 0, 0, 210, (canvas.height * 210) / canvas.width);
    pdf.save(`GiftStar-${document.querySelector('.receipt-number')?.textContent.replace('Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: ','')}.pdf`);
}

document.addEventListener('DOMContentLoaded', () => {
    if (window.updateHeader) window.updateHeader();
    
    const urlParams = new URLSearchParams(window.location.search);
    const orderId = urlParams.get('order');
    let order = null;
    
    if (orderId && window.getOrderById) {
        window.getOrderById(orderId).then(o => { if(o) displayOrder(o); });
    } else {
        try {
            order = JSON.parse(sessionStorage.getItem('giftstar_last_order') || 
                              localStorage.getItem('giftstar_last_order') || 'null');
        } catch {}
        order ? displayOrder(order) : showError('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨');
    }
});

window.logout = () => { if (window.logout) window.logout(); }
</script>

<!-- ========================================= -->
<!-- ÙƒÙˆØ¯ Firebase - ÙŠØ¶Ø§Ù ÙÙŠ Ù†Ù‡Ø§ÙŠØ© ÙƒÙ„ ØµÙØ­Ø© -->
<!-- ========================================= -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { 
  getFirestore,
  collection,
  addDoc,
  onSnapshot,
  doc,
  updateDoc,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCtHnYZT8yq9tp7xaA7AyJQV4Ag4Wi1Yks",
  authDomain: "gift-star-abf48.firebaseapp.com",
  projectId: "gift-star-abf48",
  storageBucket: "gift-star-abf48.firebasestorage.app",
  messagingSenderId: "546782076914",
  appId: "1:546782076914:web:3fb957a03c7e0501fc556b"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

window.db = db;
window.fb = {
  collection,
  addDoc,
  onSnapshot,
  doc,
  updateDoc,
  serverTimestamp
};

console.log('âœ… Firebase loaded in receipt.html');
</script>

<!-- Firebase Messaging -->
<script>
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/firebase-messaging-sw.js')
        .then((registration) => {
            console.log('âœ… Service Worker registered:', registration);
        })
        .catch((error) => {
            console.error('âŒ Service Worker registration failed:', error);
        });
}
</script>
</body>
</html>
