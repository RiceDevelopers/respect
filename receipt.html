<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø§Ù„Ø¥ÙŠØµØ§Ù„ - Gift Star</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800;900&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="css/style.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
  .receipt-page {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 40px 20px;
    background: linear-gradient(135deg, var(--secondary) 0%, #0a0e1a 100%);
  }
  
  .receipt-card {
    background: linear-gradient(135deg, var(--secondary-light) 0%, #1a1f2f 100%);
    border-radius: 30px;
    padding: 50px;
    width: 100%;
    max-width: 700px;
    box-shadow: 0 30px 60px rgba(0,0,0,0.5);
    border: 1px solid var(--border);
    position: relative;
    overflow: hidden;
  }
  
  .receipt-card::before {
    content: 'â˜…';
    position: absolute;
    top: -20px;
    right: -20px;
    font-size: 200px;
    color: rgba(200,169,110,0.05);
    transform: rotate(15deg);
    pointer-events: none;
  }
  
  .receipt-header {
    text-align: center;
    margin-bottom: 40px;
    position: relative;
  }
  
  .receipt-check {
    width: 90px;
    height: 90px;
    background: linear-gradient(135deg, #5ec98a, #3fa86a);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 25px;
    animation: scaleIn 0.5s ease;
    box-shadow: 0 10px 30px rgba(94,201,138,0.3);
  }
  
  .receipt-check svg {
    width: 45px;
    height: 45px;
    color: white;
  }
  
  .receipt-header h2 {
    font-size: 32px;
    font-weight: 900;
    color: var(--success);
    margin-bottom: 10px;
    font-family: 'Playfair Display', serif;
  }
  
  .receipt-header p {
    color: var(--text-muted);
    font-size: 16px;
  }
  
  .receipt-number {
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    border-radius: 50px;
    padding: 15px 25px;
    text-align: center;
    margin-bottom: 30px;
    font-weight: 800;
    color: var(--secondary);
    font-size: 20px;
    letter-spacing: 1px;
    box-shadow: 0 5px 15px rgba(200,169,110,0.3);
  }
  
  .receipt-details {
    background: rgba(0,0,0,0.2);
    border-radius: 20px;
    padding: 20px;
    margin-bottom: 25px;
    border: 1px solid var(--border);
  }
  
  .receipt-row {
    display: flex;
    justify-content: space-between;
    padding: 10px 0;
    border-bottom: 1px solid var(--border);
    color: var(--text-muted);
    font-size: 15px;
  }
  
  .receipt-row:last-of-type {
    border: none;
  }
  
  .receipt-row strong {
    color: var(--text);
    font-weight: 700;
  }
  
  .receipt-items {
    background: rgba(0,0,0,0.2);
    border-radius: 20px;
    padding: 20px;
    margin: 20px 0;
  }
  
  .receipt-items-title {
    font-size: 18px;
    font-weight: 800;
    color: var(--primary);
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .receipt-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px dashed var(--border);
  }
  
  .receipt-item:last-child {
    border-bottom: none;
  }
  
  .receipt-item-name {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .receipt-item-qty {
    background: var(--primary);
    color: var(--secondary);
    width: 25px;
    height: 25px;
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 800;
  }
  
  .receipt-item-price {
    font-weight: 700;
    color: var(--text);
  }
  
  .receipt-total {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 25px;
    background: linear-gradient(135deg, rgba(200,169,110,0.1) 0%, rgba(200,169,110,0.2) 100%);
    border-radius: 20px;
    margin: 25px 0;
    border: 1px solid var(--primary);
  }
  
  .receipt-total-label {
    font-size: 20px;
    font-weight: 800;
    color: var(--text);
  }
  
  .receipt-total-amount {
    font-size: 32px;
    font-weight: 900;
    color: var(--primary);
    text-shadow: 0 0 20px rgba(200,169,110,0.3);
  }
  
  .receipt-payment {
    background: rgba(200,169,110,0.05);
    border-radius: 15px;
    padding: 15px;
    margin: 15px 0;
    border: 1px solid var(--border);
  }
  
  .receipt-status {
    margin: 20px 0;
  }
  
  .status-badge {
    display: inline-block;
    padding: 8px 25px;
    border-radius: 30px;
    font-size: 16px;
    font-weight: 700;
    background: rgba(94,201,138,0.2);
    color: #5ec98a;
    border: 1px solid rgba(94,201,138,0.3);
  }
  
  .status-badge.processing { background: rgba(243,156,18,0.2); color: #f39c12; }
  .status-badge.delivered { background: rgba(52,152,219,0.2); color: #3498db; }
  .status-badge.cancelled { background: rgba(224,85,85,0.2); color: #e05555; }
  
  .receipt-actions {
    display: flex;
    gap: 15px;
    margin-top: 40px;
  }
  
  .receipt-actions .btn-primary,
  .receipt-actions .btn-outline {
    flex: 1;
    text-align: center;
    padding: 15px;
    font-size: 16px;
    font-weight: 700;
    border-radius: 15px;
  }
  
  .company-signature {
    text-align: center;
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid var(--border);
    font-size: 14px;
    color: var(--text-muted);
  }
  
  .company-signature .gold {
    color: var(--primary);
    font-weight: 700;
  }
  
  .error-container {
    text-align: center;
    padding: 60px 20px;
  }
  
  .error-container svg {
    width: 80px;
    height: 80px;
    margin-bottom: 20px;
  }
  
  .error-container h3 {
    font-size: 24px;
    color: var(--danger);
    margin-bottom: 10px;
  }
  
  .error-container p {
    color: var(--text-muted);
    margin-bottom: 30px;
  }
  
  @media print {
    .site-header,
    .receipt-actions,
    .stars-bg {
      display: none !important;
    }
    
    .receipt-page {
      padding: 0;
      background: white;
    }
    
    .receipt-card {
      box-shadow: none;
      border: 1px solid #ddd;
      background: white;
    }
    
    .receipt-number {
      background: #f0f0f0;
      color: #333;
      box-shadow: none;
    }
  }
  
  @media (max-width: 768px) {
    .receipt-actions {
      flex-direction: column;
    }
  }
</style>
</head>
<body>
<header class="site-header" id="mainHeader">
  <div class="header-main">
    <div class="container header-flex">
      <a href="index.html" class="logo">
        <div class="logo-star">â˜…</div>
        <div class="logo-text">
          <span class="logo-gift">Gift</span>
          <span class="logo-star-word">Star</span>
        </div>
      </a>
      <nav class="main-nav">
        <a href="index.html">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
        <a href="shop.html">Ø§Ù„Ù…ØªØ¬Ø±</a>
        <a href="my-orders.html">Ø·Ù„Ø¨Ø§ØªÙŠ</a>
      </nav>
      <div class="header-links">
        <a href="cart.html" class="cart-link">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="9" cy="21" r="1"/>
            <circle cx="20" cy="21" r="1"/>
            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
          </svg>
          <span class="cart-count" id="cartCount">0</span>
        </a>
        <a href="login.html" class="btn-login" id="loginBtn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a>
        <a href="#" class="btn-login" id="logoutBtn" style="display:none" onclick="logout()">Ø®Ø±ÙˆØ¬</a>
      </div>
    </div>
  </div>
</header>

<div class="receipt-page">
  <div class="receipt-card" id="receiptContent">
    <div class="loading">
      <div class="spinner"></div>
      Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨...
    </div>
  </div>
</div>

<div class="stars-bg"></div>

<script>
// =========================================
// Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ø£Ø³Ø§Ø³ÙŠØ©
// =========================================

// Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
function getCurrentUser() {
  try {
    const userStr = sessionStorage.getItem('giftstar_user');
    return userStr ? JSON.parse(userStr) : null;
  } catch (e) {
    console.error('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', e);
    return null;
  }
}

// Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³Ù„Ø©
function updateCartBadge() {
  try {
    const user = getCurrentUser();
    let cart = [];
    
    if (user) {
      const cartStr = localStorage.getItem('giftstar_cart_' + user.id);
      cart = cartStr ? JSON.parse(cartStr) : [];
    } else {
      const cartStr = localStorage.getItem('giftstar_cart');
      cart = cartStr ? JSON.parse(cartStr) : [];
    }
    
    const total = cart.reduce((sum, item) => sum + (item.qty || 0), 0);
    document.querySelectorAll('.cart-count, #cartCount').forEach(el => {
      if (el) {
        el.textContent = total;
        el.style.display = total > 0 ? 'flex' : 'none';
      }
    });
  } catch (e) {
    console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³Ù„Ø©:', e);
  }
}

// Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‡ÙŠØ¯Ø±
function updateHeader() {
  const user = getCurrentUser();
  const loginBtn = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  
  if (!loginBtn) return;
  
  if (user) {
    loginBtn.style.display = 'none';
    if (logoutBtn) logoutBtn.style.display = 'inline-block';
  } else {
    loginBtn.style.display = 'inline-block';
    if (logoutBtn) logoutBtn.style.display = 'none';
  }
  
  updateCartBadge();
}

// Ø¯Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
function logout() {
  sessionStorage.removeItem('giftstar_user');
  window.location.href = 'index.html';
}

// Ø¯Ø§Ù„Ø© ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¹Ù…Ù„Ø©
function formatKWD(amount) {
  try {
    return Number(amount || 0).toFixed(3) + ' Ø¯.Ùƒ';
  } catch {
    return '0.000 Ø¯.Ùƒ';
  }
}

// Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
function showNotification(msg, type = 'success') {
  const el = document.createElement('div');
  el.className = 'notification ' + type;
  el.textContent = msg;
  el.style.cssText = `
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: ${type === 'success' ? '#5ec98a' : '#e05555'};
    color: white;
    padding: 12px 30px;
    border-radius: 50px;
    font-size: 14px;
    font-weight: 600;
    z-index: 10000;
    box-shadow: 0 5px 20px rgba(0,0,0,0.2);
    animation: slideDown 0.3s ease;
  `;
  
  document.body.appendChild(el);
  
  setTimeout(() => {
    el.style.animation = 'slideUp 0.3s ease';
    setTimeout(() => el.remove(), 300);
  }, 3000);
}

// =========================================
// Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¥ÙŠØµØ§Ù„
// =========================================

// Ø¯Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØµØ§Ø¯Ø±
function findOrder(orderId) {
  console.log('Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø·Ù„Ø¨:', orderId);
  
  // 1. Ø§Ù„Ø¨Ø­Ø« ÙÙŠ localStorage (giftstar_orders)
  try {
    const ordersStr = localStorage.getItem('giftstar_orders');
    if (ordersStr) {
      const orders = JSON.parse(ordersStr);
      const order = orders.find(o => o.id === orderId);
      if (order) {
        console.log('ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ giftstar_orders');
        return order;
      }
    }
  } catch (e) {
    console.error('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© giftstar_orders:', e);
  }
  
  // 2. Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø¢Ø®Ø± Ø·Ù„Ø¨
  try {
    const lastOrderStr = localStorage.getItem('giftstar_last_order');
    if (lastOrderStr) {
      const lastOrder = JSON.parse(lastOrderStr);
      if (lastOrder.id === orderId || !orderId) {
        console.log('ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¢Ø®Ø± Ø·Ù„Ø¨');
        return lastOrder;
      }
    }
  } catch (e) {
    console.error('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø¢Ø®Ø± Ø·Ù„Ø¨:', e);
  }
  
  // 3. Ø§Ù„Ø¨Ø­Ø« ÙÙŠ sessionStorage
  try {
    const sessionOrderStr = sessionStorage.getItem('giftstar_last_order');
    if (sessionOrderStr) {
      const sessionOrder = JSON.parse(sessionOrderStr);
      if (sessionOrder.id === orderId || !orderId) {
        console.log('ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ sessionStorage');
        return sessionOrder;
      }
    }
  } catch (e) {
    console.error('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© sessionStorage:', e);
  }
  
  // 4. Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ ØªØ¬Ø±ÙŠØ¨ÙŠ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
  if (!orderId) {
    console.log('Ù„Ø§ ÙŠÙˆØ¬Ø¯ orderIdØŒ Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ ØªØ¬Ø±ÙŠØ¨ÙŠ');
    return createTestOrder();
  }
  
  return null;
}

// Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ ØªØ¬Ø±ÙŠØ¨ÙŠ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
function createTestOrder() {
  return {
    id: 'GS' + Date.now() + '-TEST',
    customer: {
      name: 'Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯',
      phone: '51234567',
      area: 'Ø­ÙˆÙ„ÙŠ',
      address: 'Ø´Ø§Ø±Ø¹ Ø³Ø§Ù„Ù… Ø§Ù„Ù…Ø¨Ø§Ø±ÙƒØŒ Ù…Ø¨Ù†Ù‰ 12ØŒ Ø´Ù‚Ø© 5',
      notes: 'ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§ØªØµØ§Ù„ Ù‚Ø¨Ù„ Ø§Ù„ØªÙˆØµÙŠÙ„'
    },
    items: [
      {
        id: 1,
        name: 'ÙƒÙŠÙƒ Ø§Ù„ÙØ±Ø§ÙˆÙ„Ø© Ø§Ù„ÙØ§Ø®Ø±',
        price: 12.500,
        qty: 1,
        image: 'https://images.unsplash.com/photo-1565958011703-44f9829ba187?w=400&h=400&fit=crop'
      },
      {
        id: 2,
        name: 'Ø¨Ø§Ù‚Ø© ÙˆØ±Ø¯ Ø­Ù…Ø±Ø§Ø¡ ÙƒÙ„Ø§Ø³ÙŠÙƒÙŠØ©',
        price: 8.750,
        qty: 2,
        image: 'https://images.unsplash.com/photo-1518621736915-f3b1c41bfd00?w=400&h=400&fit=crop'
      }
    ],
    subtotal: 30.000,
    delivery: 1.500,
    total: 31.500,
    paymentMethod: 'Ù†Ù‚Ø¯Ø§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…',
    paymentIcon: 'cash',
    userEmail: 'ahmed@test.com',
    status: 'new',
    date: new Date().toLocaleDateString('ar-KW'),
    time: new Date().toLocaleTimeString('ar-KW'),
    createdAt: new Date().toISOString()
  };
}

// Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨
function displayOrder(order) {
  try {
    console.log('Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨:', order);
    
    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    order.customer = order.customer || {};
    order.items = order.items || [];
    
    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª
    const subtotal = order.items.reduce((sum, item) => sum + ((item.price || 0) * (item.qty || 1)), 0);
    const delivery = order.delivery !== undefined ? order.delivery : (subtotal > 15 ? 0 : 1.500);
    const total = order.total || (subtotal + delivery);
    
    // ØªØ±Ø¬Ù…Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨
    const statusMap = {
      'new': 'Ø¬Ø¯ÙŠØ¯',
      'processing': 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©',
      'delivered': 'ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„',
      'cancelled': 'Ù…Ù„ØºÙŠ'
    };
    
    const statusText = statusMap[order.status] || order.status || 'Ø¬Ø¯ÙŠØ¯';
    
    // Ø¥Ù†Ø´Ø§Ø¡ HTML
    const html = `
      <div class="receipt-header">
        <div class="receipt-check">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
            <polyline points="20 6 9 17 4 12"/>
          </svg>
        </div>
        <h2>${window.location.search.includes('order=') ? 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨' : 'ØªÙ… Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­!'}</h2>
        <p>${window.location.search.includes('order=') ? 'Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø³Ø§Ø¨Ù‚' : 'Ø´ÙƒØ±Ø§Ù‹ Ù„ÙƒØŒ Ø³ÙŠØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ù‚Ø±ÙŠØ¨Ø§Ù‹ Ù„Ù„ØªØ£ÙƒÙŠØ¯'}</p>
      </div>

      <div class="receipt-number">
        Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: ${order.id || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
      </div>

      <div class="receipt-details">
        <div class="receipt-row">
          <span>ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…</span>
          <strong>${order.customer.name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</strong>
        </div>
        <div class="receipt-row">
          <span>ğŸ“ Ø§Ù„Ù‡Ø§ØªÙ</span>
          <strong>+965 ${order.customer.phone || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</strong>
        </div>
        <div class="receipt-row">
          <span>ğŸ“ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</span>
          <strong>${order.customer.area || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</strong>
        </div>
        <div class="receipt-row">
          <span>ğŸ  Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</span>
          <strong>${order.customer.address || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</strong>
        </div>
        <div class="receipt-row">
          <span>ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª</span>
          <strong>${order.date || ''} ${order.time || ''}</strong>
        </div>
        ${order.customer.notes ? `
        <div class="receipt-row">
          <span>ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª</span>
          <strong>${order.customer.notes}</strong>
        </div>
        ` : ''}
      </div>

      <div class="receipt-items">
        <div class="receipt-items-title">
          <span>ğŸ›ï¸</span>
          <span>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</span>
        </div>
        ${order.items.map(item => `
          <div class="receipt-item">
            <div class="receipt-item-name">
              <span class="receipt-item-qty">${item.qty || 1}</span>
              <span>${item.name || 'Ù…Ù†ØªØ¬'}</span>
            </div>
            <span class="receipt-item-price">${formatKWD((item.price || 0) * (item.qty || 1))}</span>
          </div>
        `).join('')}
      </div>

      <div class="receipt-total">
        <span class="receipt-total-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</span>
        <span class="receipt-total-amount">${formatKWD(total)}</span>
      </div>

      <div class="receipt-payment">
        <div class="receipt-row">
          <span>ğŸ’³ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</span>
          <strong>${order.paymentMethod || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</strong>
        </div>
        <div class="receipt-row">
          <span>ğŸšš Ø±Ø³ÙˆÙ… Ø§Ù„ØªÙˆØµÙŠÙ„</span>
          <strong>${delivery === 0 ? 'Ù…Ø¬Ø§Ù†ÙŠ' : formatKWD(delivery)}</strong>
        </div>
      </div>

      ${order.status ? `
        <div class="receipt-status">
          <span class="status-badge ${order.status || 'new'}">${statusText}</span>
        </div>
      ` : ''}

      <div class="company-signature">
        <span class="gold">Gift Star</span> - Ù…ØªØ¬Ø± Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ø§Ù„ÙƒÙˆÙŠØªÙŠ Ø§Ù„Ø£ÙˆÙ„<br>
        <small>Ù†Ø´ÙƒØ±Ùƒ Ø¹Ù„Ù‰ Ø«Ù‚ØªÙƒØŒ ÙˆÙ†ØªØ·Ù„Ø¹ Ù„Ø®Ø¯Ù…ØªÙƒ Ø¯Ø§Ø¦Ù…Ø§Ù‹ âœ¨</small>
      </div>

      <div class="receipt-actions" id="receiptActions">
        <button class="btn-primary" onclick="generatePDF()">
          <span style="display:flex; align-items:center; justify-content:center; gap:10px">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
              <polyline points="7 10 12 15 17 10"/>
              <line x1="12" y1="15" x2="12" y2="3"/>
            </svg>
            ØªØ­Ù…ÙŠÙ„ PDF
          </span>
        </button>
        <a href="index.html" class="btn-outline">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
        <a href="my-orders.html" class="btn-outline">Ø·Ù„Ø¨Ø§ØªÙŠ</a>
      </div>
    `;
    
    document.getElementById('receiptContent').innerHTML = html;
    
  } catch (error) {
    console.error('Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨:', error);
    showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨');
  }
}

// Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø®Ø·Ø£
function showError(message) {
  const container = document.getElementById('receiptContent');
  if (!container) return;
  
  container.innerHTML = `
    <div class="error-container">
      <svg viewBox="0 0 24 24" fill="none" stroke="var(--danger)" stroke-width="2">
        <circle cx="12" cy="12" r="10"/>
        <line x1="12" y1="8" x2="12" y2="12"/>
        <circle cx="12" cy="16" r="1" fill="var(--danger)"/>
      </svg>
      <h3>Ø¹Ø°Ø±Ø§Ù‹</h3>
      <p>${message}</p>
      <div style="display:flex; gap:15px; justify-content:center; margin-top:30px;">
        <a href="index.html" class="btn-primary">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
        <a href="my-orders.html" class="btn-outline">Ø·Ù„Ø¨Ø§ØªÙŠ</a>
      </div>
    </div>
  `;
}

// Ø¯Ø§Ù„Ø© ØªÙˆÙ„ÙŠØ¯ PDF
async function generatePDF() {
  try {
    const { jsPDF } = window.jspdf;
    const element = document.getElementById('receiptContent');
    
    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù…Ø¤Ù‚ØªØ§Ù‹
    const actions = document.getElementById('receiptActions');
    if (actions) actions.style.display = 'none';
    
    // Ø§Ù„ØªÙ‚Ø§Ø· ØµÙˆØ±Ø© Ù„Ù„Ø¹Ù†ØµØ±
    const canvas = await html2canvas(element, {
      scale: 2,
      backgroundColor: '#0f1326',
      logging: false,
      allowTaint: true,
      useCORS: true
    });
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
    if (actions) actions.style.display = 'flex';
    
    const imgData = canvas.toDataURL('image/png');
    const pdf = new jsPDF({
      orientation: 'portrait',
      unit: 'mm',
      format: 'a4'
    });
    
    const pdfWidth = pdf.internal.pageSize.getWidth();
    const pdfHeight = pdf.internal.pageSize.getHeight();
    const imgWidth = canvas.width;
    const imgHeight = canvas.height;
    const ratio = Math.min(pdfWidth / imgWidth, pdfHeight / imgHeight);
    const width = imgWidth * ratio;
    const height = imgHeight * ratio;
    
    pdf.addImage(imgData, 'PNG', (pdfWidth - width) / 2, 0, width, height);
    
    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨
    const orderIdElement = document.querySelector('.receipt-number');
    const orderId = orderIdElement ? orderIdElement.textContent.replace('Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: ', '').trim() : 'order';
    
    pdf.save(`GiftStar-${orderId}.pdf`);
    
    showNotification('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù PDF Ø¨Ù†Ø¬Ø§Ø­', 'success');
    
  } catch (error) {
    console.error('Ø®Ø·Ø£ ÙÙŠ ØªÙˆÙ„ÙŠØ¯ PDF:', error);
    showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù PDF', 'error');
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
    const actions = document.getElementById('receiptActions');
    if (actions) actions.style.display = 'flex';
  }
}

// =========================================
// Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
// =========================================
function init() {
  console.log('Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ ØµÙØ­Ø© Ø§Ù„Ø¥ÙŠØµØ§Ù„...');
  
  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‡ÙŠØ¯Ø±
  updateHeader();
  
  // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ orderId Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
  const urlParams = new URLSearchParams(window.location.search);
  const orderId = urlParams.get('order');
  
  console.log('orderId Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·:', orderId);
  
  // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø·Ù„Ø¨
  const order = findOrder(orderId);
  
  if (order) {
    console.log('ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨:', order);
    displayOrder(order);
  } else {
    console.log('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨');
    showError('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨');
  }
}

// ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
document.addEventListener('DOMContentLoaded', init);

// Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
const style = document.createElement('style');
style.textContent = `
  @keyframes slideDown {
    from { opacity: 0; transform: translateX(-50%) translateY(-20px); }
    to { opacity: 1; transform: translateX(-50%) translateY(0); }
  }
  @keyframes slideUp {
    from { opacity: 1; transform: translateX(-50%) translateY(0); }
    to { opacity: 0; transform: translateX(-50%) translateY(-20px); }
  }
`;
document.head.appendChild(style);
</script>
</body>
</html>
