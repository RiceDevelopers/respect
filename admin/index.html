<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>لوحة التحكم - Gift Star</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800;900&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="../css/style.css">
</head>
<body style="background:#f4f6f9">

<div class="admin-layout">
  <!-- Sidebar -->
  <aside class="admin-sidebar">
    <div class="admin-logo">
      <div class="logo">
        <div class="logo-star">★</div>
        <div class="logo-text">
          <span class="logo-gift" style="color:white">Gift</span>
          <span class="logo-star-word">Star</span>
        </div>
      </div>
      <div style="font-size:12px;color:rgba(255,255,255,0.5);margin-top:6px">لوحة التحكم</div>
    </div>

    <nav class="admin-menu">
      <div class="admin-menu-item active" onclick="showSection('dashboard', this)">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
        الرئيسية
      </div>
      <div class="admin-menu-item" onclick="showSection('products', this)">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 01-8 0"/></svg>
        المنتجات
      </div>
      <div class="admin-menu-item" onclick="showSection('promos', this)">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
        العروض والإعلانات
      </div>
      <div class="admin-menu-item" onclick="showSection('orders', this)">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg>
        الطلبات
      </div>
      <div class="admin-menu-item" onclick="showSection('payments', this)">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
        طرق الدفع
      </div>
      <div class="admin-menu-item" onclick="showSection('users', this)">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>
        المستخدمون
      </div>
      <div style="margin-top:auto;padding:16px 0">
        <div class="admin-menu-item" onclick="doLogout()">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
          تسجيل الخروج
        </div>
      </div>
    </nav>
  </aside>

  <!-- Main -->
  <div class="admin-main">
    <div class="admin-topbar">
      <h2 id="pageTitle">الرئيسية</h2>
      <div class="admin-user">
        <span id="adminName"></span>
        <div style="width:36px;height:36px;background:var(--primary);border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:14px" id="adminInitial">م</div>
      </div>
    </div>

    <div class="admin-content">

      <!-- Dashboard -->
      <div class="admin-section active" id="sec_dashboard">
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-number" id="statProducts">0</div>
            <div class="stat-label">المنتجات</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="statOrders">0</div>
            <div class="stat-label">الطلبات</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="statRevenue">0</div>
            <div class="stat-label">الإيرادات (د.ك)</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="statUsers">0</div>
            <div class="stat-label">المستخدمون</div>
          </div>
        </div>

        <div class="admin-table-wrap">
          <div class="admin-table-header">
            <h3>آخر الطلبات</h3>
          </div>
          <table>
            <thead>
              <tr>
                <th>رقم الطلب</th>
                <th>العميل</th>
                <th>المبلغ</th>
                <th>الحالة</th>
                <th>التاريخ</th>
              </tr>
            </thead>
            <tbody id="recentOrdersTbl"></tbody>
          </table>
        </div>
      </div>

      <!-- Products -->
      <div class="admin-section" id="sec_products">
        <div class="admin-table-wrap">
          <div class="admin-table-header">
            <h3>إدارة المنتجات</h3>
            <button class="btn-add" onclick="openAddProduct()">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
              إضافة منتج
            </button>
          </div>
          <table>
            <thead>
              <tr>
                <th>الصورة</th>
                <th>الاسم</th>
                <th>الفئة</th>
                <th>السعر</th>
                <th>المخزون</th>
                <th>الحالة</th>
                <th>إجراءات</th>
              </tr>
            </thead>
            <tbody id="productsTbl"></tbody>
          </table>
        </div>
      </div>

      <!-- Promos -->
      <div class="admin-section" id="sec_promos">
        <div class="admin-table-wrap">
          <div class="admin-table-header">
            <h3>إدارة العروض والإعلانات</h3>
            <button class="btn-add" onclick="openAddPromo()">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
              إضافة عرض
            </button>
          </div>
          <table>
            <thead>
              <tr>
                <th>الصورة</th>
                <th>العنوان</th>
                <th>الوصف</th>
                <th>الشارة</th>
                <th>الحالة</th>
                <th>إجراءات</th>
              </tr>
            </thead>
            <tbody id="promosTbl"></tbody>
          </table>
        </div>
      </div>

      <!-- Orders -->
      <div class="admin-section" id="sec_orders">
        <div class="admin-table-wrap">
          <div class="admin-table-header">
            <h3>الطلبات</h3>
          </div>
          <table>
            <thead>
              <tr>
                <th>رقم الطلب</th>
                <th>العميل</th>
                <th>المنطقة</th>
                <th>المبلغ</th>
                <th>طريقة الدفع</th>
                <th>الحالة</th>
                <th>التاريخ</th>
                <th>إجراءات</th>
              </tr>
            </thead>
            <tbody id="ordersTbl"></tbody>
          </table>
        </div>
      </div>

      <!-- Payments -->
      <div class="admin-section" id="sec_payments">
        <div class="admin-table-wrap">
          <div class="admin-table-header">
            <h3>إدارة طرق الدفع</h3>
          </div>
          <table>
            <thead>
              <tr>
                <th>طريقة الدفع</th>
                <th>الوصف</th>
                <th>الحالة</th>
                <th>تغيير</th>
              </tr>
            </thead>
            <tbody id="paymentsTbl"></tbody>
          </table>
        </div>
      </div>

      <!-- Users -->
      <div class="admin-section" id="sec_users">
        <div class="admin-table-wrap">
          <div class="admin-table-header">
            <h3>المستخدمون</h3>
          </div>
          <table>
            <thead>
              <tr>
                <th>الاسم</th>
                <th>البريد الإلكتروني</th>
                <th>الصلاحية</th>
                <th>الحالة</th>
                <th>إجراءات</th>
              </tr>
            </thead>
            <tbody id="usersTbl"></tbody>
          </table>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Product Modal -->
<div class="modal-overlay" id="productModal">
  <div class="modal-card">
    <div class="modal-header">
      <h3 id="productModalTitle">إضافة منتج</h3>
      <button class="modal-close" onclick="closeModal('productModal')">×</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="pId">
      <div class="form-group">
        <label class="form-label">اسم المنتج</label>
        <input type="text" id="pName" class="form-input">
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
        <div class="form-group">
          <label class="form-label">الفئة</label>
          <select id="pCat" class="form-select">
            <option value="cakes">كيك</option>
            <option value="flowers">ورد</option>
            <option value="gifts">هدايا</option>
            <option value="chocolate">شوكولاتة</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">السعر (د.ك)</label>
          <input type="number" id="pPrice" class="form-input" step="0.001" min="0">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">رابط الصورة (URL)</label>
        <input type="url" id="pImage" class="form-input" placeholder="https://..." dir="ltr">
      </div>
      <div id="pImgPreview" style="margin-bottom:12px"></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
        <div class="form-group">
          <label class="form-label">المخزون</label>
          <input type="number" id="pStock" class="form-input" min="0">
        </div>
        <div class="form-group">
          <label class="form-label">الشارة (اختياري)</label>
          <input type="text" id="pBadge" class="form-input" placeholder="مثال: جديد">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">الوصف</label>
        <textarea id="pDesc" class="form-textarea" rows="3"></textarea>
      </div>
      <div style="display:flex;gap:20px">
        <label style="display:flex;align-items:center;gap:8px;font-size:14px;cursor:pointer">
          <input type="checkbox" id="pFeatured"> مميز (يظهر في الصفحة الرئيسية)
        </label>
        <label style="display:flex;align-items:center;gap:8px;font-size:14px;cursor:pointer">
          <input type="checkbox" id="pActive" checked> مفعّل
        </label>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-primary" onclick="saveProduct()">حفظ</button>
      <button class="btn-outline" style="padding:11px 20px" onclick="closeModal('productModal')">إلغاء</button>
    </div>
  </div>
</div>

<!-- Promo Modal -->
<div class="modal-overlay" id="promoModal">
  <div class="modal-card">
    <div class="modal-header">
      <h3 id="promoModalTitle">إضافة عرض</h3>
      <button class="modal-close" onclick="closeModal('promoModal')">×</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="prId">
      <div class="form-group">
        <label class="form-label">عنوان العرض</label>
        <input type="text" id="prTitle" class="form-input">
      </div>
      <div class="form-group">
        <label class="form-label">الوصف</label>
        <input type="text" id="prDesc" class="form-input">
      </div>
      <div class="form-group">
        <label class="form-label">رابط الصورة</label>
        <input type="url" id="prImage" class="form-input" dir="ltr" placeholder="https://...">
      </div>
      <div class="form-group">
        <label class="form-label">نص الشارة</label>
        <input type="text" id="prBadge" class="form-input" placeholder="مثال: رمضان كريم">
      </div>
      <label style="display:flex;align-items:center;gap:8px;font-size:14px;cursor:pointer">
        <input type="checkbox" id="prActive" checked> مفعّل
      </label>
    </div>
    <div class="modal-footer">
      <button class="btn-primary" onclick="savePromo()">حفظ</button>
      <button class="btn-outline" style="padding:11px 20px" onclick="closeModal('promoModal')">إلغاء</button>
    </div>
  </div>
</div>

<!-- Order Detail Modal -->
<div class="modal-overlay" id="orderModal">
  <div class="modal-card">
    <div class="modal-header">
      <h3>تفاصيل الطلب</h3>
      <button class="modal-close" onclick="closeModal('orderModal')">×</button>
    </div>
    <div class="modal-body" id="orderModalContent"></div>
  </div>
</div>

<script src="../js/data.js"></script>
<script>
function checkAdmin() {
  const user = getCurrentUser();
  if (!user || user.role !== 'admin') {
    window.location.href = '../login.html';
    return false;
  }
  document.getElementById('adminName').textContent = user.name;
  document.getElementById('adminInitial').textContent = user.name.charAt(0);
  return true;
}

function showSection(id, el) {
  document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.admin-menu-item').forEach(m => m.classList.remove('active'));
  document.getElementById('sec_' + id).classList.add('active');
  el.classList.add('active');
  const titles = {
    dashboard: 'الرئيسية', products: 'المنتجات', promos: 'العروض والإعلانات',
    orders: 'الطلبات', payments: 'طرق الدفع', users: 'المستخدمون'
  };
  document.getElementById('pageTitle').textContent = titles[id];
  loadSection(id);
}

function loadSection(id) {
  if (id === 'dashboard') loadDashboard();
  else if (id === 'products') loadProducts();
  else if (id === 'promos') loadPromos();
  else if (id === 'orders') loadOrders();
  else if (id === 'payments') loadPayments();
  else if (id === 'users') loadUsers();
}

function loadDashboard() {
  const products = getData('products', []);
  const orders = getData('orders', []);
  const users = getData('users', []);
  const revenue = orders.reduce((s, o) => s + (o.total || 0), 0);

  document.getElementById('statProducts').textContent = products.length;
  document.getElementById('statOrders').textContent = orders.length;
  document.getElementById('statRevenue').textContent = revenue.toFixed(3);
  document.getElementById('statUsers').textContent = users.length;

  const tbody = document.getElementById('recentOrdersTbl');
  const recent = orders.slice(0, 10);
  tbody.innerHTML = recent.length ? recent.map(o => `
    <tr>
      <td>${o.id}</td>
      <td>${o.customer?.name || '-'}</td>
      <td>${(o.total||0).toFixed(3)} د.ك</td>
      <td><span class="badge badge-success">${o.status}</span></td>
      <td>${o.date || '-'}</td>
    </tr>
  `).join('') : '<tr><td colspan="5" style="text-align:center;color:var(--text-muted)">لا توجد طلبات</td></tr>';
}

function loadProducts() {
  const products = getData('products', []);
  const cats = { cakes: 'كيك', flowers: 'ورد', gifts: 'هدايا', chocolate: 'شوكولاتة' };
  document.getElementById('productsTbl').innerHTML = products.map(p => `
    <tr>
      <td><img src="${p.image}" class="table-img" onerror="this.src='https://images.unsplash.com/photo-1549465220-1a8b9238cd48?w=50&h=50&fit=crop'"></td>
      <td>${p.name}</td>
      <td>${cats[p.category] || p.category}</td>
      <td>${p.price.toFixed(3)} د.ك</td>
      <td>${p.stock}</td>
      <td><span class="badge ${p.active ? 'badge-success' : 'badge-danger'}">${p.active ? 'مفعّل' : 'موقف'}</span></td>
      <td>
        <button class="btn-icon" onclick="openEditProduct(${p.id})" title="تعديل">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
        </button>
        <button class="btn-icon danger" onclick="deleteProduct(${p.id})" title="حذف">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/><path d="M10 11v6M14 11v6"/><path d="M9 6V4h6v2"/></svg>
        </button>
      </td>
    </tr>
  `).join('') || '<tr><td colspan="7" style="text-align:center;color:var(--text-muted)">لا توجد منتجات</td></tr>';
}

function loadPromos() {
  const promos = getData('promos', []);
  document.getElementById('promosTbl').innerHTML = promos.map(p => `
    <tr>
      <td><img src="${p.image}" class="table-img" style="width:80px;border-radius:6px;height:45px;object-fit:cover"></td>
      <td>${p.title}</td>
      <td>${p.description}</td>
      <td>${p.badge || '-'}</td>
      <td><span class="badge ${p.active ? 'badge-success' : 'badge-danger'}">${p.active ? 'مفعّل' : 'موقف'}</span></td>
      <td>
        <button class="btn-icon" onclick="openEditPromo(${p.id})">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
        </button>
        <button class="btn-icon danger" onclick="deletePromo(${p.id})">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/><path d="M10 11v6M14 11v6"/><path d="M9 6V4h6v2"/></svg>
        </button>
      </td>
    </tr>
  `).join('') || '<tr><td colspan="6" style="text-align:center;color:var(--text-muted)">لا توجد عروض</td></tr>';
}

function loadOrders() {
  const orders = getData('orders', []);
  const statuses = ['جديد', 'قيد التحضير', 'جاري التوصيل', 'تم التوصيل', 'ملغي'];
  document.getElementById('ordersTbl').innerHTML = orders.length ? orders.map(o => `
    <tr>
      <td>${o.id}</td>
      <td>${o.customer?.name || '-'}</td>
      <td>${o.customer?.area || '-'}</td>
      <td>${(o.total||0).toFixed(3)} د.ك</td>
      <td>${o.paymentMethod || '-'}</td>
      <td>
        <select style="padding:4px 8px;border:1px solid var(--border);border-radius:6px;font-size:13px;font-family:var(--font)" onchange="updateOrderStatus('${o.id}', this.value)">
          ${statuses.map(s => `<option ${s===o.status?'selected':''}>${s}</option>`).join('')}
        </select>
      </td>
      <td>${o.date || '-'}</td>
      <td>
        <button class="btn-icon" onclick="viewOrder('${o.id}')">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
        </button>
      </td>
    </tr>
  `).join('') : '<tr><td colspan="8" style="text-align:center;color:var(--text-muted)">لا توجد طلبات</td></tr>';
}

function loadPayments() {
  const methods = getData('payment_methods', []);
  document.getElementById('paymentsTbl').innerHTML = methods.map(m => `
    <tr>
      <td><strong>${m.name}</strong></td>
      <td>${m.description}</td>
      <td><span class="badge ${m.active ? 'badge-success' : 'badge-danger'}">${m.active ? 'مفعّل' : 'موقف'}</span></td>
      <td>
        <button class="btn-icon" onclick="togglePayment(${m.id})" title="${m.active ? 'إيقاف' : 'تفعيل'}">
          ${m.active 
            ? '<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="var(--danger)" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>'
            : '<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="var(--success)" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg>'
          }
        </button>
      </td>
    </tr>
  `).join('');
}

function loadUsers() {
  const users = getData('users', []);
  document.getElementById('usersTbl').innerHTML = users.map(u => `
    <tr>
      <td>${u.name}</td>
      <td>${u.email}</td>
      <td><span class="badge ${u.role==='admin'?'badge-warning':'badge-success'}">${u.role==='admin'?'مدير':'عميل'}</span></td>
      <td><span class="badge ${u.verified?'badge-success':'badge-danger'}">${u.verified?'مفعّل':'غير مفعّل'}</span></td>
      <td>
        ${u.role !== 'admin' ? `<button class="btn-icon danger" onclick="deleteUser(${u.id})">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/></svg>
        </button>` : '<span style="color:var(--text-muted);font-size:12px">محمي</span>'}
      </td>
    </tr>
  `).join('');
}

// ---- Product CRUD ----
function openAddProduct() {
  document.getElementById('productModalTitle').textContent = 'إضافة منتج';
  document.getElementById('pId').value = '';
  document.getElementById('pName').value = '';
  document.getElementById('pCat').value = 'cakes';
  document.getElementById('pPrice').value = '';
  document.getElementById('pImage').value = '';
  document.getElementById('pStock').value = '10';
  document.getElementById('pBadge').value = '';
  document.getElementById('pDesc').value = '';
  document.getElementById('pFeatured').checked = false;
  document.getElementById('pActive').checked = true;
  document.getElementById('pImgPreview').innerHTML = '';
  document.getElementById('productModal').classList.add('open');
}

function openEditProduct(id) {
  const p = getData('products', []).find(x => x.id === id);
  if (!p) return;
  document.getElementById('productModalTitle').textContent = 'تعديل المنتج';
  document.getElementById('pId').value = p.id;
  document.getElementById('pName').value = p.name;
  document.getElementById('pCat').value = p.category;
  document.getElementById('pPrice').value = p.price;
  document.getElementById('pImage').value = p.image;
  document.getElementById('pStock').value = p.stock;
  document.getElementById('pBadge').value = p.badge || '';
  document.getElementById('pDesc').value = p.description;
  document.getElementById('pFeatured').checked = p.featured;
  document.getElementById('pActive').checked = p.active;
  document.getElementById('pImgPreview').innerHTML = `<img src="${p.image}" style="width:100%;height:120px;object-fit:cover;border-radius:8px;margin-bottom:8px">`;
  document.getElementById('productModal').classList.add('open');
}

document.getElementById('pImage').addEventListener('input', function() {
  if (this.value) {
    document.getElementById('pImgPreview').innerHTML = `<img src="${this.value}" style="width:100%;height:120px;object-fit:cover;border-radius:8px;margin-bottom:8px" onerror="this.style.display='none'">`;
  }
});

function saveProduct() {
  const name = document.getElementById('pName').value.trim();
  const price = parseFloat(document.getElementById('pPrice').value);
  const image = document.getElementById('pImage').value.trim();
  if (!name || !price || !image) {
    showNotification('يرجى ملء الحقول المطلوبة', 'error'); return;
  }
  const products = getData('products', []);
  const editId = parseInt(document.getElementById('pId').value);
  const productData = {
    name,
    category: document.getElementById('pCat').value,
    price,
    image,
    stock: parseInt(document.getElementById('pStock').value) || 0,
    badge: document.getElementById('pBadge').value || null,
    description: document.getElementById('pDesc').value,
    featured: document.getElementById('pFeatured').checked,
    active: document.getElementById('pActive').checked
  };

  if (editId) {
    const idx = products.findIndex(p => p.id === editId);
    products[idx] = { ...products[idx], ...productData };
  } else {
    products.push({ id: Date.now(), ...productData });
  }
  setData('products', products);
  closeModal('productModal');
  loadProducts();
  showNotification('تم حفظ المنتج بنجاح', 'success');
}

function deleteProduct(id) {
  if (!confirm('هل تريد حذف هذا المنتج؟')) return;
  const products = getData('products', []).filter(p => p.id !== id);
  setData('products', products);
  loadProducts();
  showNotification('تم حذف المنتج', 'success');
}

// ---- Promo CRUD ----
function openAddPromo() {
  document.getElementById('promoModalTitle').textContent = 'إضافة عرض';
  document.getElementById('prId').value = '';
  document.getElementById('prTitle').value = '';
  document.getElementById('prDesc').value = '';
  document.getElementById('prImage').value = '';
  document.getElementById('prBadge').value = '';
  document.getElementById('prActive').checked = true;
  document.getElementById('promoModal').classList.add('open');
}

function openEditPromo(id) {
  const p = getData('promos', []).find(x => x.id === id);
  if (!p) return;
  document.getElementById('promoModalTitle').textContent = 'تعديل العرض';
  document.getElementById('prId').value = p.id;
  document.getElementById('prTitle').value = p.title;
  document.getElementById('prDesc').value = p.description;
  document.getElementById('prImage').value = p.image;
  document.getElementById('prBadge').value = p.badge || '';
  document.getElementById('prActive').checked = p.active;
  document.getElementById('promoModal').classList.add('open');
}

function savePromo() {
  const title = document.getElementById('prTitle').value.trim();
  if (!title) { showNotification('يرجى إدخال العنوان', 'error'); return; }
  const promos = getData('promos', []);
  const editId = parseInt(document.getElementById('prId').value);
  const data = {
    title,
    description: document.getElementById('prDesc').value,
    image: document.getElementById('prImage').value,
    badge: document.getElementById('prBadge').value,
    active: document.getElementById('prActive').checked
  };
  if (editId) {
    const idx = promos.findIndex(p => p.id === editId);
    promos[idx] = { ...promos[idx], ...data };
  } else {
    promos.push({ id: Date.now(), ...data });
  }
  setData('promos', promos);
  closeModal('promoModal');
  loadPromos();
  showNotification('تم حفظ العرض بنجاح', 'success');
}

function deletePromo(id) {
  if (!confirm('حذف هذا العرض؟')) return;
  setData('promos', getData('promos', []).filter(p => p.id !== id));
  loadPromos();
  showNotification('تم حذف العرض', 'success');
}

// ---- Orders ----
function updateOrderStatus(id, status) {
  const orders = getData('orders', []);
  const o = orders.find(x => x.id === id);
  if (o) { o.status = status; setData('orders', orders); showNotification('تم تحديث الحالة', 'success'); }
}

function viewOrder(id) {
  const order = getData('orders', []).find(o => o.id === id);
  if (!order) return;
  document.getElementById('orderModalContent').innerHTML = `
    <div style="font-size:14px">
      <div style="margin-bottom:12px"><strong>رقم الطلب:</strong> ${order.id}</div>
      <div style="margin-bottom:12px"><strong>العميل:</strong> ${order.customer?.name}</div>
      <div style="margin-bottom:12px"><strong>الهاتف:</strong> ${order.customer?.phone}</div>
      <div style="margin-bottom:12px"><strong>المنطقة:</strong> ${order.customer?.area}</div>
      <div style="margin-bottom:12px"><strong>العنوان:</strong> ${order.customer?.address}</div>
      <div style="margin-bottom:12px"><strong>طريقة الدفع:</strong> ${order.paymentMethod}</div>
      <div style="margin-bottom:16px"><strong>التاريخ:</strong> ${order.date} ${order.time}</div>
      <div style="border-top:1px solid var(--border);padding-top:12px">
        ${order.items?.map(i => `<div style="display:flex;justify-content:space-between;margin-bottom:8px"><span>${i.name} x${i.qty}</span><strong>${(i.price*i.qty).toFixed(3)} د.ك</strong></div>`).join('')}
      </div>
      <div style="border-top:2px solid var(--border);padding-top:12px;font-size:16px;display:flex;justify-content:space-between">
        <strong>الإجمالي</strong>
        <strong style="color:var(--primary)">${(order.total||0).toFixed(3)} د.ك</strong>
      </div>
    </div>
  `;
  document.getElementById('orderModal').classList.add('open');
}

// ---- Payments ----
function togglePayment(id) {
  const methods = getData('payment_methods', []);
  const m = methods.find(x => x.id === id);
  if (m) { m.active = !m.active; setData('payment_methods', methods); loadPayments(); showNotification('تم تحديث طريقة الدفع', 'success'); }
}

// ---- Users ----
function deleteUser(id) {
  if (!confirm('حذف هذا المستخدم؟')) return;
  setData('users', getData('users', []).filter(u => u.id !== id));
  loadUsers();
  showNotification('تم حذف المستخدم', 'success');
}

// ---- Modal helpers ----
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

document.querySelectorAll('.modal-overlay').forEach(m => {
  m.addEventListener('click', e => { if (e.target === m) m.classList.remove('open'); });
});

function doLogout() { logout(); }

// ---- Init ----
if (checkAdmin()) { loadDashboard(); }
</script>
</body>
</html>
