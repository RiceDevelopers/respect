<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Gift Star</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800;900&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="../css/style.css">
<style>
.admin-layout { display: flex; min-height: 100vh; background: var(--secondary); }
.admin-sidebar {
    width: 280px;
    background: linear-gradient(180deg, var(--secondary) 0%, #000000 100%);
    position: fixed; top: 0; bottom: 0; right: 0;
    border-left: 1px solid var(--border);
    overflow-y: auto;
}
.admin-main { margin-right: 280px; flex: 1; }
.admin-content { padding: 35px; }
.admin-topbar {
    background: var(--secondary-light);
    padding: 20px 35px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--border);
    position: sticky; top: 0; z-index: 50;
}
.admin-menu { padding: 20px 0; }
.admin-menu-item {
    display: flex; align-items: center; gap: 15px;
    padding: 15px 25px; color: var(--text-muted);
    cursor: pointer; transition: var(--transition);
    border-right: 3px solid transparent;
}
.admin-menu-item:hover, .admin-menu-item.active {
    background: rgba(200,169,110,0.1);
    color: var(--primary);
    border-right-color: var(--primary);
}
.stats-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 25px;
    margin-bottom: 40px;
}
.stat-card {
    background: var(--secondary-light);
    border-radius: var(--radius);
    padding: 30px;
    border: 1px solid var(--border);
}
.stat-number { font-size: 38px; font-weight: 900; color: var(--text); }
.admin-table-wrap {
    background: var(--secondary-light);
    border-radius: var(--radius);
    border: 1px solid var(--border);
    margin-top: 20px;
    overflow: hidden;
}
.admin-table-header {
    padding: 20px 25px;
    border-bottom: 1px solid var(--border);
    background: var(--secondary);
    display: flex;
    justify-content: space-between;
    align-items: center;
}
table { width: 100%; border-collapse: collapse; }
th {
    background: var(--secondary);
    padding: 15px 20px;
    text-align: right;
    border-bottom: 1px solid var(--border);
    font-weight: 700;
}
td {
    padding: 15px 20px;
    border-bottom: 1px solid var(--border);
    color: var(--text-muted);
}
.status-badge {
    display: inline-block;
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 12px;
}
.status-badge.new { background: rgba(94,201,138,0.2); color: #5ec98a; }
.action-btn {
    padding: 6px 12px;
    border-radius: 20px;
    border: 1px solid var(--border);
    background: var(--secondary);
    color: var(--text);
    cursor: pointer;
    margin: 0 3px;
}
.btn-add {
    background: linear-gradient(135deg, var(--primary), var(--primary-light));
    color: var(--secondary);
    border: none;
    padding: 10px 22px;
    border-radius: 30px;
    font-size: 14px;
    font-weight: 700;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
}
.modal-overlay {
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.8);
    backdrop-filter: blur(8px);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 2000;
}
.modal-card {
    background: var(--secondary-light);
    border-radius: var(--radius-lg);
    max-width: 600px;
    width: 100%;
    border: 1px solid var(--border);
    max-height: 90vh;
    overflow-y: auto;
}
.modal-header { padding: 30px 30px 0; display: flex; justify-content: space-between; }
.modal-body { padding: 20px 30px; }
.modal-footer { padding: 0 30px 30px; display: flex; gap: 15px; justify-content: flex-end; }
.loading { text-align: center; padding: 60px; }
.spinner {
    width: 50px; height: 50px;
    border: 4px solid var(--border);
    border-top-color: var(--primary);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin: 0 auto 20px;
}
@keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>
<div class="admin-layout">
    <aside class="admin-sidebar">
        <div class="admin-logo" style="padding:35px 25px; border-bottom:1px solid var(--border);">
            <div class="logo">
                <div class="logo-star">â˜…</div>
                <div class="logo-text">
                    <span class="logo-gift">Gift</span>
                    <span class="logo-star-word">Star</span>
                </div>
            </div>
            <div style="color:var(--primary); font-size:13px; margin-top:5px;">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</div>
        </div>
        <div class="admin-menu">
            <div class="admin-menu-item active" onclick="showPanel('dashboard')">ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</div>
            <div class="admin-menu-item" onclick="showPanel('orders')">ğŸ“¦ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
            <div class="admin-menu-item" onclick="showPanel('products')">ğŸ›ï¸ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div>
            <div class="admin-menu-item" onclick="showPanel('users')">ğŸ‘¥ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</div>
            <div class="admin-menu-item" onclick="showPanel('promos')">ğŸ Ø§Ù„Ø¹Ø±ÙˆØ¶</div>
            <div class="admin-menu-item" onclick="logout()">ğŸšª Ø®Ø±ÙˆØ¬</div>
        </div>
    </aside>

    <main class="admin-main">
        <div class="admin-topbar">
            <h2 id="panelTitle">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</h2>
            <div class="admin-user">Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ <span id="adminName"></span></div>
        </div>

        <div class="admin-content" id="adminContent">
            <div class="loading"><div class="spinner"></div>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
        </div>
    </main>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ -->
<div class="modal-overlay" id="orderModal">
    <div class="modal-card">
        <div class="modal-header">
            <h3>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ <span id="modalOrderId"></span></h3>
            <button class="modal-close" onclick="closeOrderModal()" style="background:none; border:none; font-size:24px; color:var(--text-muted);">âœ•</button>
        </div>
        <div class="modal-body" id="orderModalBody"></div>
        <div class="modal-footer">
            <select id="orderStatusSelect" style="padding:10px; border-radius:30px; background:var(--secondary); color:var(--text); border:1px solid var(--border);">
                <option value="new">Ø¬Ø¯ÙŠØ¯</option>
                <option value="processing">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</option>
                <option value="delivered">ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„</option>
                <option value="cancelled">Ù…Ù„ØºÙŠ</option>
            </select>
            <button class="action-btn" onclick="updateOrderStatus()">ØªØ­Ø¯ÙŠØ«</button>
            <button class="action-btn" onclick="printOrder()">Ø·Ø¨Ø§Ø¹Ø©</button>
        </div>
    </div>
</div>

<script src="../js/data.js"></script>
<script src="../js/main.js"></script>
<script>
let currentPanel = 'dashboard';
let allOrders = [], allProducts = [], allUsers = [], allPromos = [];

function checkAdmin() {
    const user = JSON.parse(sessionStorage.getItem('giftstar_user') || 'null');
    if (!user || user.role !== 'admin') { window.location.href = '../login.html'; return false; }
    document.getElementById('adminName').textContent = user.name;
    return true;
}

function showPanel(panel) {
    document.querySelectorAll('.admin-menu-item').forEach(i => i.classList.remove('active'));
    event.currentTarget.classList.add('active');
    currentPanel = panel;

    const titles = {
        dashboard: 'Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª',
        orders: 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª',
        products: 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª',
        users: 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†',
        promos: 'Ø§Ù„Ø¹Ø±ÙˆØ¶'
    };
    document.getElementById('panelTitle').textContent = titles[panel];

    if (panel === 'dashboard') loadDashboard();
    else if (panel === 'orders') loadOrders();
    else if (panel === 'products') loadProducts();
    else if (panel === 'users') loadUsers();
    else if (panel === 'promos') loadPromos();
}

function loadDashboard() {
    const orders = JSON.parse(localStorage.getItem('giftstar_orders') || '[]');
    const products = JSON.parse(localStorage.getItem('giftstar_products') || '[]');
    const users = JSON.parse(localStorage.getItem('giftstar_users') || '[]');
    const totalRevenue = orders.reduce((s, o) => s + (o.total || 0), 0);

    document.getElementById('adminContent').innerHTML = `
        <div class="stats-grid">
            <div class="stat-card"><div class="stat-number">${orders.length}</div><div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div></div>
            <div class="stat-card"><div class="stat-number">${products.filter(p => p.active).length}</div><div class="stat-label">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div></div>
            <div class="stat-card"><div class="stat-number">${users.filter(u => u.role === 'customer').length}</div><div class="stat-label">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div></div>
            <div class="stat-card"><div class="stat-number">${totalRevenue.toFixed(3)} Ø¯.Ùƒ</div><div class="stat-label">Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</div></div>
        </div>
        <div class="admin-table-wrap">
            <div class="admin-table-header"><h3>Ø¢Ø®Ø± Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h3></div>
            <table><thead><tr><th>Ø§Ù„Ø·Ù„Ø¨</th><th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead>
            <tbody>${orders.slice(0, 5).map(o => `
                <tr><td>${o.id}</td><td>${o.customer?.name || ''}</td>
                <td>${(o.total || 0).toFixed(3)} Ø¯.Ùƒ</td>
                <td><span class="status-badge ${o.status || 'new'}">${o.status || 'Ø¬Ø¯ÙŠØ¯'}</span></td></tr>
            `).join('')}</tbody></table>
        </div>
    `;
}

function loadOrders() {
    allOrders = JSON.parse(localStorage.getItem('giftstar_orders') || '[]');
    document.getElementById('adminContent').innerHTML = `
        <div class="admin-table-header"><h3>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h3></div>
        <div class="admin-table-wrap">
            <table><thead><tr><th>Ø§Ù„Ø·Ù„Ø¨</th><th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th></th></tr></thead>
            <tbody>${allOrders.map(o => `
                <tr><td>${o.id}</td><td>${o.customer?.name || ''}</td><td>${o.customer?.phone || ''}</td>
                <td>${(o.total || 0).toFixed(3)} Ø¯.Ùƒ</td>
                <td><span class="status-badge ${o.status || 'new'}">${o.status || 'Ø¬Ø¯ÙŠØ¯'}</span></td>
                <td>${o.date || ''}</td>
                <td><button class="action-btn" onclick="viewOrderDetails('${o.id}')">Ø¹Ø±Ø¶</button></td></tr>
            `).join('')}</tbody></table>
        </div>
    `;
}

function loadProducts() {
    allProducts = JSON.parse(localStorage.getItem('giftstar_products') || '[]');
    document.getElementById('adminContent').innerHTML = `
        <div class="admin-table-header"><h3>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h3><button class="btn-add" onclick="showAddProduct()">+ Ø¥Ø¶Ø§ÙØ©</button></div>
        <div class="admin-table-wrap" id="productsTable"></div>
    `;
    renderProductsTable();
}

function renderProductsTable() {
    document.getElementById('productsTable').innerHTML = `
        <table><thead><tr><th>Ø§Ù„ØµÙˆØ±Ø©</th><th>Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø§Ù„ÙØ¦Ø©</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th></th></tr></thead>
        <tbody>${allProducts.map(p => `
            <tr><td><img src="${p.image}" style="width:50px; height:50px; border-radius:8px; object-fit:cover;"></td>
            <td>${p.name}</td><td>${p.category}</td><td>${p.price.toFixed(3)} Ø¯.Ùƒ</td>
            <td><span class="status-badge ${p.active ? 'new' : 'cancelled'}">${p.active ? 'Ù†Ø´Ø·' : 'ØºÙŠØ± Ù†Ø´Ø·'}</span></td>
            <td><button class="action-btn" onclick="deleteProduct(${p.id})">Ø­Ø°Ù</button></td></tr>
        `).join('')}</tbody></table>
    `;
}

function showAddProduct() {
    const name = prompt('Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬:');
    if (!name) return;
    const price = parseFloat(prompt('Ø§Ù„Ø³Ø¹Ø±:'));
    if (!price) return;

    allProducts.push({
        id: Date.now(),
        name, price,
        category: 'gifts',
        image: 'https://images.unsplash.com/photo-1549465220-1a8b9238cd48?w=400&h=400&fit=crop',
        description: 'Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯',
        active: true
    });
    localStorage.setItem('giftstar_products', JSON.stringify(allProducts));
    renderProductsTable();
}

function deleteProduct(id) {
    if (!confirm('Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ØŸ')) return;
    allProducts = allProducts.filter(p => p.id !== id);
    localStorage.setItem('giftstar_products', JSON.stringify(allProducts));
    renderProductsTable();
}

function loadUsers() {
    allUsers = JSON.parse(localStorage.getItem('giftstar_users') || '[]');
    document.getElementById('adminContent').innerHTML = `
        <div class="admin-table-header"><h3>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3></div>
        <div class="admin-table-wrap">
            <table><thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø¨Ø±ÙŠØ¯</th><th>Ø§Ù„Ø¯ÙˆØ±</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead>
            <tbody>${allUsers.map(u => `
                <tr><td>${u.name}</td><td>${u.email}</td>
                <td><span class="status-badge ${u.role === 'admin' ? 'processing' : 'new'}">${u.role === 'admin' ? 'Ù…Ø¯ÙŠØ±' : 'Ø¹Ù…ÙŠÙ„'}</span></td>
                <td><span class="status-badge ${u.verified ? 'new' : 'cancelled'}">${u.verified ? 'Ù…ÙØ¹Ù„' : 'ØºÙŠØ± Ù…ÙØ¹Ù„'}</span></td></tr>
            `).join('')}</tbody></table>
        </div>
    `;
}

function loadPromos() {
    allPromos = JSON.parse(localStorage.getItem('giftstar_promos') || '[]');
    document.getElementById('adminContent').innerHTML = `
        <div class="admin-table-header"><h3>Ø§Ù„Ø¹Ø±ÙˆØ¶</h3><button class="btn-add" onclick="showAddPromo()">+ Ø¥Ø¶Ø§ÙØ©</button></div>
        <div class="admin-table-wrap" id="promosTable"></div>
    `;
    renderPromosTable();
}

function renderPromosTable() {
    document.getElementById('promosTable').innerHTML = `
        <table><thead><tr><th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th><th>Ø§Ù„ÙˆØµÙ</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th></th></tr></thead>
        <tbody>${allPromos.map(p => `
            <tr><td>${p.title}</td><td>${p.description}</td>
            <td><span class="status-badge ${p.active ? 'new' : 'cancelled'}">${p.active ? 'Ù†Ø´Ø·' : 'ØºÙŠØ± Ù†Ø´Ø·'}</span></td>
            <td><button class="action-btn" onclick="deletePromo(${p.id})">Ø­Ø°Ù</button></td></tr>
        `).join('')}</tbody></table>
    `;
}

function showAddPromo() {
    const title = prompt('Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ø±Ø¶:');
    if (!title) return;
    const desc = prompt('Ø§Ù„ÙˆØµÙ:');
    if (!desc) return;

    allPromos.push({
        id: Date.now(),
        title, description: desc,
        image: 'https://images.unsplash.com/photo-1549465220-1a8b9238cd48?w=600&h=300&fit=crop',
        active: true
    });
    localStorage.setItem('giftstar_promos', JSON.stringify(allPromos));
    renderPromosTable();
}

function deletePromo(id) {
    if (!confirm('Ø­Ø°Ù Ø§Ù„Ø¹Ø±Ø¶ØŸ')) return;
    allPromos = allPromos.filter(p => p.id !== id);
    localStorage.setItem('giftstar_promos', JSON.stringify(allPromos));
    renderPromosTable();
}

function viewOrderDetails(orderId) {
    const order = allOrders.find(o => o.id === orderId);
    if (!order) return;

    document.getElementById('modalOrderId').textContent = order.id;
    document.getElementById('orderModalBody').innerHTML = `
        <p><strong>Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> ${order.customer?.name}</p>
        <p><strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${order.customer?.phone}</p>
        <p><strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> ${order.customer?.address}</p>
        <p><strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</strong> ${(order.total || 0).toFixed(3)} Ø¯.Ùƒ</p>
    `;
    document.getElementById('orderStatusSelect').value = order.status || 'new';
    document.getElementById('orderModal').style.display = 'flex';
}

function closeOrderModal() {
    document.getElementById('orderModal').style.display = 'none';
}

function updateOrderStatus() {
    const orderId = document.getElementById('modalOrderId').textContent;
    const newStatus = document.getElementById('orderStatusSelect').value;

    const index = allOrders.findIndex(o => o.id === orderId);
    if (index !== -1) {
        allOrders[index].status = newStatus;
        localStorage.setItem('giftstar_orders', JSON.stringify(allOrders));
        alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©');
        closeOrderModal();
        loadOrders();
    }
}

function printOrder() {
    const orderId = document.getElementById('modalOrderId').textContent;
    window.open(`../receipt.html?order=${orderId}`, '_blank');
}

function logout() {
    sessionStorage.removeItem('giftstar_user');
    window.location.href = '../index.html';
}

document.addEventListener('DOMContentLoaded', () => {
    if (!checkAdmin()) return;
    loadDashboard();
});
</script>

<!-- ÙƒÙˆØ¯ Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getFirestore } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyCtHnYZT8yq9tp7xaA7AyJQV4Ag4Wi1Yks",
    authDomain: "gift-star-abf48.firebaseapp.com",
    projectId: "gift-star-abf48",
    storageBucket: "gift-star-abf48.firebasestorage.app",
    messagingSenderId: "546782076914",
    appId: "1:546782076914:web:3fb957a03c7e0501fc556b"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

window.db = db;
console.log('âœ… Firebase loaded');
</script>

<!-- Firebase Messaging -->
<script>
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/firebase-messaging-sw.js').catch(console.error);
}
</script>
</body>
</html>
