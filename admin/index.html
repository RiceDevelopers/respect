<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>لوحة التحكم - Gift Star</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800;900&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="../css/style.css">
<style>
  /* أنماط إضافية للوحة التحكم */
  .admin-stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
  }
  
  .admin-stat-card {
    background: var(--secondary-light);
    border-radius: var(--radius);
    padding: 25px;
    border: 1px solid var(--border);
    transition: var(--transition);
  }
  
  .admin-stat-card:hover {
    transform: translateY(-5px);
    border-color: var(--primary);
    box-shadow: var(--shadow-hover);
  }
  
  .admin-stat-icon {
    width: 48px;
    height: 48px;
    background: rgba(200,169,110,0.1);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 15px;
    color: var(--primary);
  }
  
  .admin-stat-value {
    font-size: 32px;
    font-weight: 900;
    color: var(--text);
    margin-bottom: 5px;
  }
  
  .admin-stat-label {
    color: var(--text-muted);
    font-size: 14px;
  }
  
  .admin-stat-change {
    margin-top: 10px;
    font-size: 13px;
    color: var(--success);
  }
  
  .admin-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 30px;
    border-bottom: 1px solid var(--border);
    padding-bottom: 15px;
  }
  
  .admin-tab {
    padding: 12px 25px;
    border-radius: 30px;
    background: var(--secondary);
    color: var(--text-muted);
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    border: 1px solid transparent;
  }
  
  .admin-tab:hover,
  .admin-tab.active {
    background: var(--primary);
    color: var(--secondary);
    border-color: var(--primary);
  }
  
  .admin-panel {
    display: none;
  }
  
  .admin-panel.active {
    display: block;
  }
  
  .admin-table {
    width: 100%;
    background: var(--secondary-light);
    border-radius: var(--radius);
    border: 1px solid var(--border);
    overflow: hidden;
  }
  
  .admin-table th {
    background: var(--secondary);
    padding: 15px 20px;
    text-align: right;
    font-weight: 700;
    color: var(--text);
    border-bottom: 1px solid var(--border);
  }
  
  .admin-table td {
    padding: 15px 20px;
    border-bottom: 1px solid var(--border);
    color: var(--text-muted);
  }
  
  .admin-table tr:last-child td {
    border-bottom: none;
  }
  
  .admin-table tr:hover td {
    background: var(--secondary);
  }
  
  .status-badge {
    display: inline-block;
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
  }
  
  .status-badge.new { background: rgba(94,201,138,0.2); color: #5ec98a; }
  .status-badge.processing { background: rgba(243,156,18,0.2); color: #f39c12; }
  .status-badge.delivered { background: rgba(52,152,219,0.2); color: #3498db; }
  .status-badge.cancelled { background: rgba(224,85,85,0.2); color: #e05555; }
  
  .action-btn {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    border: 1px solid var(--border);
    background: var(--secondary);
    color: var(--text);
    margin: 0 3px;
  }
  
  .action-btn:hover {
    background: var(--primary);
    color: var(--secondary);
    border-color: var(--primary);
  }
  
  .action-btn.danger:hover {
    background: var(--danger);
    border-color: var(--danger);
    color: white;
  }
  
  .product-form {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
    background: var(--secondary-light);
    border-radius: var(--radius);
    padding: 30px;
    border: 1px solid var(--border);
    margin-bottom: 30px;
  }
  
  .product-form .full-width {
    grid-column: span 2;
  }
  
  .form-actions {
    grid-column: span 2;
    display: flex;
    gap: 15px;
    justify-content: flex-end;
    margin-top: 20px;
  }
  
  .order-detail-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.8);
    backdrop-filter: blur(8px);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 2000;
    padding: 20px;
  }
  
  .order-detail-modal.open {
    display: flex;
  }
  
  .order-detail-content {
    background: var(--secondary-light);
    border-radius: var(--radius-lg);
    padding: 40px;
    max-width: 600px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    border: 1px solid var(--border);
  }
  
  .order-timeline {
    margin-top: 20px;
    padding: 20px;
    background: var(--secondary);
    border-radius: var(--radius);
  }
  
  .timeline-item {
    display: flex;
    gap: 15px;
    padding: 10px 0;
    border-bottom: 1px solid var(--border);
  }
  
  .timeline-item:last-child {
    border-bottom: none;
  }
  
  .timeline-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: var(--primary);
    margin-top: 8px;
  }
  
  .timeline-content {
    flex: 1;
  }
  
  .timeline-date {
    font-size: 12px;
    color: var(--text-muted);
  }
</style>
</head>
<body>
<div class="admin-layout">
  <!-- Sidebar -->
  <aside class="admin-sidebar">
    <div class="admin-logo">
      <div class="logo">
        <div class="logo-star">★</div>
        <div class="logo-text">
          <span class="logo-gift">Gift</span>
          <span class="logo-star-word">Star</span>
        </div>
      </div>
      <div style="color:var(--primary);font-size:13px;margin-top:5px">لوحة التحكم</div>
    </div>
    
    <div class="admin-menu">
      <div class="admin-menu-item active" onclick="showPanel('dashboard')">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="7" height="7"></rect>
          <rect x="14" y="3" width="7" height="7"></rect>
          <rect x="14" y="14" width="7" height="7"></rect>
          <rect x="3" y="14" width="7" height="7"></rect>
        </svg>
        لوحة المعلومات
      </div>
      <div class="admin-menu-item" onclick="showPanel('orders')">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path>
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <path d="M16 10a4 4 0 0 1-8 0"></path>
        </svg>
        الطلبات
      </div>
      <div class="admin-menu-item" onclick="showPanel('products')">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
          <line x1="7" y1="7" x2="7.01" y2="7"></line>
        </svg>
        المنتجات
      </div>
      <div class="admin-menu-item" onclick="showPanel('users')">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
          <circle cx="12" cy="7" r="4"></circle>
        </svg>
        المستخدمين
      </div>
      <div class="admin-menu-item" onclick="showPanel('promos')">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 2v4M12 22v-4M4 12H2M22 12h-2M19.07 4.93l-2.83 2.83M6.9 17.1l-2.82 2.82M17.1 6.9l2.82-2.82M4.93 19.07l2.83-2.83"></path>
          <circle cx="12" cy="12" r="3"></circle>
        </svg>
        العروض
      </div>
      <div class="admin-menu-item" onclick="logout()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
          <polyline points="16 17 21 12 16 7"></polyline>
          <line x1="21" y1="12" x2="9" y2="12"></line>
        </svg>
        خروج
      </div>
    </div>
  </aside>
  
  <!-- Main Content -->
  <main class="admin-main">
    <div class="admin-topbar">
      <h2 id="panelTitle">لوحة المعلومات</h2>
      <div class="admin-user" id="adminUser">
        <span>مرحباً، <span id="adminName"></span></span>
        <span class="status-dot"></span>
      </div>
    </div>
    
    <div class="admin-content">
      <!-- Dashboard Panel -->
      <div id="dashboardPanel" class="admin-panel active">
        <div class="admin-stats-grid" id="statsGrid">
          <div class="loading"><div class="spinner"></div>جاري التحميل...</div>
        </div>
        
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:30px">
          <div class="admin-table-wrap">
            <div class="admin-table-header">
              <h3>آخر الطلبات</h3>
              <button class="btn-add" onclick="showPanel('orders')">
                <span>عرض الكل</span>
              </button>
            </div>
            <div id="recentOrdersTable"></div>
          </div>
          
          <div class="admin-table-wrap">
            <div class="admin-table-header">
              <h3>المنتجات الأكثر مبيعاً</h3>
            </div>
            <div id="topProducts"></div>
          </div>
        </div>
      </div>
      
      <!-- Orders Panel -->
      <div id="ordersPanel" class="admin-panel">
        <div class="admin-table-wrap">
          <div class="admin-table-header">
            <h3>جميع الطلبات</h3>
            <div style="display:flex;gap:10px">
              <select class="form-select" id="orderFilter" style="width:150px" onchange="filterOrders()">
                <option value="all">جميع الطلبات</option>
                <option value="new">جديد</option>
                <option value="processing">قيد المعالجة</option>
                <option value="delivered">تم التوصيل</option>
                <option value="cancelled">ملغي</option>
              </select>
              <input type="text" class="form-input" id="orderSearch" placeholder="بحث برقم الطلب أو البريد" style="width:200px" onkeyup="searchOrders()">
            </div>
          </div>
          <table class="admin-table">
            <thead>
              <tr>
                <th>رقم الطلب</th>
                <th>العميل</th>
                <th>التاريخ</th>
                <th>المبلغ</th>
                <th>الحالة</th>
                <th>الإجراءات</th>
              </tr>
            </thead>
            <tbody id="ordersTableBody">
              <tr><td colspan="6" class="loading">جاري التحميل...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Products Panel -->
      <div id="productsPanel" class="admin-panel">
        <div class="admin-table-header" style="margin-bottom:20px">
          <h3>إدارة المنتجات</h3>
          <button class="btn-add" onclick="showAddProductForm()">
            <span>+ إضافة منتج جديد</span>
          </button>
        </div>
        
        <div id="addProductForm" style="display:none">
          <form class="product-form" id="productForm">
            <div class="full-width">
              <label class="form-label">اسم المنتج</label>
              <input type="text" id="productName" class="form-input" required>
            </div>
            
            <div>
              <label class="form-label">الفئة</label>
              <select id="productCategory" class="form-select" required>
                <option value="cakes">كيك</option>
                <option value="flowers">ورد</option>
                <option value="gifts">هدايا</option>
                <option value="chocolate">شوكولاتة</option>
              </select>
            </div>
            
            <div>
              <label class="form-label">السعر (د.ك)</label>
              <input type="number" id="productPrice" class="form-input" step="0.001" min="0" required>
            </div>
            
            <div>
              <label class="form-label">الكمية المتاحة</label>
              <input type="number" id="productStock" class="form-input" min="0" value="10" required>
            </div>
            
            <div class="full-width">
              <label class="form-label">رابط الصورة</label>
              <input type="url" id="productImage" class="form-input" required>
            </div>
            
            <div class="full-width">
              <label class="form-label">وصف المنتج</label>
              <textarea id="productDescription" class="form-textarea" rows="3" required></textarea>
            </div>
            
            <div>
              <label class="form-label">
                <input type="checkbox" id="productFeatured"> منتج مميز
              </label>
            </div>
            
            <div>
              <label class="form-label">
                <input type="checkbox" id="productActive" checked> متاح
              </label>
            </div>
            
            <div class="form-actions">
              <button type="button" class="action-btn" onclick="cancelAddProduct()">إلغاء</button>
              <button type="submit" class="action-btn" onclick="saveProduct(event)">حفظ المنتج</button>
            </div>
          </form>
        </div>
        
        <div class="admin-table-wrap">
          <table class="admin-table">
            <thead>
              <tr>
                <th>الصورة</th>
                <th>المنتج</th>
                <th>الفئة</th>
                <th>السعر</th>
                <th>المخزون</th>
                <th>الحالة</th>
                <th>الإجراءات</th>
              </tr>
            </thead>
            <tbody id="productsTableBody">
              <tr><td colspan="7" class="loading">جاري التحميل...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Users Panel -->
      <div id="usersPanel" class="admin-panel">
        <div class="admin-table-wrap">
          <div class="admin-table-header">
            <h3>المستخدمين</h3>
            <input type="text" class="form-input" placeholder="بحث..." style="width:200px" onkeyup="searchUsers(this.value)">
          </div>
          <table class="admin-table">
            <thead>
              <tr>
                <th>الاسم</th>
                <th>البريد الإلكتروني</th>
                <th>رقم الهاتف</th>
                <th>الدور</th>
                <th>تاريخ التسجيل</th>
                <th>عدد الطلبات</th>
                <th>الحالة</th>
              </tr>
            </thead>
            <tbody id="usersTableBody">
              <tr><td colspan="7" class="loading">جاري التحميل...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Promos Panel -->
      <div id="promosPanel" class="admin-panel">
        <div class="admin-table-header" style="margin-bottom:20px">
          <h3>العروض</h3>
          <button class="btn-add" onclick="showAddPromoForm()">
            <span>+ إضافة عرض جديد</span>
          </button>
        </div>
        
        <div id="addPromoForm" style="display:none;margin-bottom:20px">
          <!-- نموذج إضافة عرض -->
        </div>
        
        <div class="admin-table-wrap">
          <table class="admin-table">
            <thead>
              <tr>
                <th>العنوان</th>
                <th>الوصف</th>
                <th>الوسام</th>
                <th>الحالة</th>
                <th>الإجراءات</th>
              </tr>
            </thead>
            <tbody id="promosTableBody">
              <tr><td colspan="5" class="loading">جاري التحميل...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>
</div>

<!-- Order Detail Modal -->
<div class="order-detail-modal" id="orderModal">
  <div class="order-detail-content">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
      <h3 style="font-size:20px">تفاصيل الطلب <span id="modalOrderId"></span></h3>
      <button class="modal-close" onclick="closeOrderModal()">✕</button>
    </div>
    
    <div id="orderDetailContent"></div>
    
    <div style="margin-top:20px">
      <label class="form-label">تحديث حالة الطلب</label>
      <div style="display:flex;gap:10px">
        <select class="form-select" id="orderStatusSelect" style="flex:1">
          <option value="new">جديد</option>
          <option value="processing">قيد المعالجة</option>
          <option value="delivered">تم التوصيل</option>
          <option value="cancelled">ملغي</option>
        </select>
        <button class="action-btn" onclick="updateOrderStatus()">تحديث</button>
      </div>
    </div>
    
    <div class="order-timeline" id="orderTimeline"></div>
  </div>
</div>

<script src="../js/data.js"></script>
<script>
let currentPanel = 'dashboard';
let allOrders = [];
let allProducts = [];
let allUsers = [];
let allPromos = [];

// التحقق من صلاحيات المدير
async function checkAdmin() {
  const user = giftstar.getCurrentUser();
  if (!user || user.role !== 'admin') {
    window.location.href = '../login.html';
    return false;
  }
  document.getElementById('adminName').textContent = user.name;
  return true;
}

// تبديل اللوحات
function showPanel(panel) {
  document.querySelectorAll('.admin-panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.admin-menu-item').forEach(i => i.classList.remove('active'));
  
  document.getElementById(panel + 'Panel').classList.add('active');
  event.currentTarget.classList.add('active');
  
  const titles = {
    dashboard: 'لوحة المعلومات',
    orders: 'إدارة الطلبات',
    products: 'إدارة المنتجات',
    users: 'المستخدمين',
    promos: 'العروض'
  };
  
  document.getElementById('panelTitle').textContent = titles[panel];
  currentPanel = panel;
  
  // تحميل البيانات حسب اللوحة
  if (panel === 'dashboard') loadDashboard();
  else if (panel === 'orders') loadOrders();
  else if (panel === 'products') loadProducts();
  else if (panel === 'users') loadUsers();
  else if (panel === 'promos') loadPromos();
}

// تحميل لوحة المعلومات
async function loadDashboard() {
  const stats = await giftstar.getDashboardStats();
  const orders = await giftstar.getData('orders') || [];
  
  const statsGrid = document.getElementById('statsGrid');
  statsGrid.innerHTML = `
    <div class="admin-stat-card">
      <div class="admin-stat-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path>
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <path d="M16 10a4 4 0 0 1-8 0"></path>
        </svg>
      </div>
      <div class="admin-stat-value">${stats.totalOrders}</div>
      <div class="admin-stat-label">إجمالي الطلبات</div>
      <div class="admin-stat-change">+${stats.todayOrders} اليوم</div>
    </div>
    
    <div class="admin-stat-card">
      <div class="admin-stat-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
          <line x1="7" y1="7" x2="7.01" y2="7"></line>
        </svg>
      </div>
      <div class="admin-stat-value">${stats.totalProducts}</div>
      <div class="admin-stat-label">المنتجات النشطة</div>
    </div>
    
    <div class="admin-stat-card">
      <div class="admin-stat-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
          <circle cx="12" cy="7" r="4"></circle>
        </svg>
      </div>
      <div class="admin-stat-value">${stats.totalUsers}</div>
      <div class="admin-stat-label">العملاء</div>
    </div>
    
    <div class="admin-stat-card">
      <div class="admin-stat-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="12" y1="1" x2="12" y2="23"></line>
          <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
        </svg>
      </div>
      <div class="admin-stat-value">${giftstar.formatKWD(stats.totalRevenue)}</div>
      <div class="admin-stat-label">إجمالي الإيرادات</div>
      <div class="admin-stat-change">+${giftstar.formatKWD(stats.todayRevenue)} اليوم</div>
    </div>
  `;
  
  // آخر 5 طلبات
  const recentOrders = orders.slice(0, 5);
  document.getElementById('recentOrdersTable').innerHTML = `
    <table class="admin-table">
      <tbody>
        ${recentOrders.map(order => `
          <tr>
            <td><strong>${order.id}</strong></td>
            <td>${order.customer?.name || 'غير محدد'}</td>
            <td>${order.total ? giftstar.formatKWD(order.total) : '0.000 د.ك'}</td>
            <td><span class="status-badge ${order.status || 'new'}">${order.status || 'جديد'}</span></td>
            <td><button class="action-btn" onclick="viewOrderDetails('${order.id}')">عرض</button></td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;
}

// تحميل الطلبات
async function loadOrders() {
  allOrders = await giftstar.getData('orders') || [];
  renderOrdersTable(allOrders);
}

function renderOrdersTable(orders) {
  const tbody = document.getElementById('ordersTableBody');
  
  if (!orders.length) {
    tbody.innerHTML = '<tr><td colspan="6" class="loading">لا توجد طلبات</td></tr>';
    return;
  }
  
  tbody.innerHTML = orders.map(order => `
    <tr>
      <td><strong>${order.id}</strong></td>
      <td>${order.customer?.name || 'غير محدد'}<br><small>${order.userEmail || ''}</small></td>
      <td>${order.date || ''}<br><small>${order.time || ''}</small></td>
      <td>${order.total ? giftstar.formatKWD(order.total) : '0.000 د.ك'}</td>
      <td><span class="status-badge ${order.status || 'new'}">${order.status || 'جديد'}</span></td>
      <td>
        <button class="action-btn" onclick="viewOrderDetails('${order.id}')">عرض</button>
        <button class="action-btn" onclick="printOrder('${order.id}')">طباعة</button>
      </td>
    </tr>
  `).join('');
}

function filterOrders() {
  const filter = document.getElementById('orderFilter').value;
  if (filter === 'all') {
    renderOrdersTable(allOrders);
  } else {
    const filtered = allOrders.filter(o => o.status === filter);
    renderOrdersTable(filtered);
  }
}

function searchOrders() {
  const search = document.getElementById('orderSearch').value.toLowerCase();
  if (!search) {
    renderOrdersTable(allOrders);
    return;
  }
  
  const filtered = allOrders.filter(o => 
    o.id.toLowerCase().includes(search) || 
    o.userEmail?.toLowerCase().includes(search) ||
    o.customer?.name?.toLowerCase().includes(search)
  );
  renderOrdersTable(filtered);
}

// عرض تفاصيل الطلب
async function viewOrderDetails(orderId) {
  const orders = await giftstar.getData('orders') || [];
  const order = orders.find(o => o.id === orderId);
  
  if (!order) return;
  
  document.getElementById('modalOrderId').textContent = order.id;
  
  const itemsHTML = order.items?.map(item => `
    <div style="display:flex;justify-content:space-between;margin-bottom:8px">
      <span>${item.name} x${item.qty}</span>
      <span>${giftstar.formatKWD(item.price * item.qty)}</span>
    </div>
  `).join('') || '';
  
  document.getElementById('orderDetailContent').innerHTML = `
    <div style="margin-bottom:20px">
      <h4 style="margin-bottom:10px">معلومات العميل</h4>
      <p><strong>الاسم:</strong> ${order.customer?.name || 'غير محدد'}</p>
      <p><strong>الهاتف:</strong> ${order.customer?.phone || 'غير محدد'}</p>
      <p><strong>العنوان:</strong> ${order.customer?.address || 'غير محدد'}</p>
    </div>
    
    <div style="margin-bottom:20px">
      <h4 style="margin-bottom:10px">المنتجات</h4>
      ${itemsHTML}
      <div style="border-top:1px solid var(--border);margin-top:10px;padding-top:10px">
        <div style="display:flex;justify-content:space-between">
          <span>المجموع الفرعي:</span>
          <span>${giftstar.formatKWD(order.subtotal || 0)}</span>
        </div>
        <div style="display:flex;justify-content:space-between">
          <span>التوصيل:</span>
          <span>${order.delivery === 0 ? 'مجاني' : giftstar.formatKWD(order.delivery || 0)}</span>
        </div>
        <div style="display:flex;justify-content:space-between;font-weight:700;margin-top:5px">
          <span>الإجمالي:</span>
          <span>${giftstar.formatKWD(order.total || 0)}</span>
        </div>
      </div>
    </div>
    
    <div>
      <h4 style="margin-bottom:10px">طريقة الدفع</h4>
      <p>${order.paymentMethod || 'غير محدد'}</p>
    </div>
  `;
  
  // عرض الجدول الزمني
  const timelineHTML = order.statusHistory?.map(history => `
    <div class="timeline-item">
      <div class="timeline-dot"></div>
      <div class="timeline-content">
        <strong>${history.status}</strong>
        <p>${history.note || ''}</p>
        <div class="timeline-date">${new Date(history.date).toLocaleString('ar-KW')}</div>
      </div>
    </div>
  `).join('') || '<p>لا يوجد سجل للطلبات</p>';
  
  document.getElementById('orderTimeline').innerHTML = timelineHTML;
  document.getElementById('orderStatusSelect').value = order.status || 'new';
  
  document.getElementById('orderModal').classList.add('open');
}

function closeOrderModal() {
  document.getElementById('orderModal').classList.remove('open');
}

async function updateOrderStatus() {
  const orderId = document.getElementById('modalOrderId').textContent;
  const newStatus = document.getElementById('orderStatusSelect').value;
  
  const success = await giftstar.updateOrderStatus(orderId, newStatus, 'تم التحديث بواسطة المدير');
  
  if (success) {
    giftstar.showNotification('تم تحديث حالة الطلب', 'success');
    closeOrderModal();
    loadOrders();
    loadDashboard();
  }
}

function printOrder(orderId) {
  window.open(`../receipt.html?order=${orderId}`, '_blank');
}

// تحميل المنتجات
async function loadProducts() {
  allProducts = await giftstar.getData('products') || [];
  renderProductsTable(allProducts);
}

function renderProductsTable(products) {
  const tbody = document.getElementById('productsTableBody');
  
  if (!products.length) {
    tbody.innerHTML = '<tr><td colspan="7" class="loading">لا توجد منتجات</td></tr>';
    return;
  }
  
  tbody.innerHTML = products.map(product => `
    <tr>
      <td><img src="${product.image}" alt="${product.name}" style="width:50px;height:50px;border-radius:8px;object-fit:cover"></td>
      <td>${product.name}</td>
      <td>${product.category}</td>
      <td>${giftstar.formatKWD(product.price)}</td>
      <td>${product.stock || 0}</td>
      <td><span class="badge ${product.active ? 'badge-success' : 'badge-danger'}">${product.active ? 'نشط' : 'غير نشط'}</span></td>
      <td>
        <button class="action-btn" onclick="editProduct(${product.id})">تعديل</button>
        <button class="action-btn danger" onclick="deleteProduct(${product.id})">حذف</button>
      </td>
    </tr>
  `).join('');
}

function showAddProductForm() {
  document.getElementById('addProductForm').style.display = 'block';
  document.getElementById('productForm').reset();
  document.getElementById('productActive').checked = true;
}

function cancelAddProduct() {
  document.getElementById('addProductForm').style.display = 'none';
}

async function saveProduct(event) {
  event.preventDefault();
  
  const product = {
    name: document.getElementById('productName').value,
    category: document.getElementById('productCategory').value,
    price: parseFloat(document.getElementById('productPrice').value),
    stock: parseInt(document.getElementById('productStock').value),
    image: document.getElementById('productImage').value,
    description: document.getElementById('productDescription').value,
    featured: document.getElementById('productFeatured').checked,
    active: document.getElementById('productActive').checked
  };
  
  const result = await giftstar.addProduct(product);
  
  if (result.success) {
    giftstar.showNotification('تم إضافة المنتج بنجاح', 'success');
    cancelAddProduct();
    loadProducts();
  } else {
    giftstar.showNotification('حدث خطأ: ' + result.error, 'error');
  }
}

async function deleteProduct(productId) {
  if (!confirm('هل أنت متأكد من حذف هذا المنتج؟')) return;
  
  const result = await giftstar.deleteProduct(productId);
  
  if (result.success) {
    giftstar.showNotification('تم حذف المنتج', 'success');
    loadProducts();
  }
}

// تحميل المستخدمين
async function loadUsers() {
  allUsers = await giftstar.getData('users') || [];
  const orders = await giftstar.getData('orders') || [];
  
  const usersWithOrders = allUsers.map(user => ({
    ...user,
    orderCount: orders.filter(o => o.userId === user.id || o.userEmail === user.email).length
  }));
  
  renderUsersTable(usersWithOrders);
}

function renderUsersTable(users) {
  const tbody = document.getElementById('usersTableBody');
  
  if (!users.length) {
    tbody.innerHTML = '<tr><td colspan="7" class="loading">لا يوجد مستخدمين</td></tr>';
    return;
  }
  
  tbody.innerHTML = users.map(user => `
    <tr>
      <td>${user.name || 'غير محدد'}</td>
      <td>${user.email}</td>
      <td>${user.phone || 'غير محدد'}</td>
      <td><span class="badge ${user.role === 'admin' ? 'badge-warning' : 'badge-success'}">${user.role === 'admin' ? 'مدير' : 'عميل'}</span></td>
      <td>${user.createdAt ? new Date(user.createdAt).toLocaleDateString('ar-KW') : 'غير محدد'}</td>
      <td>${user.orderCount || 0}</td>
      <td><span class="badge ${user.verified ? 'badge-success' : 'badge-danger'}">${user.verified ? 'مفعل' : 'غير مفعل'}</span></td>
    </tr>
  `).join('');
}

function searchUsers(query) {
  if (!query) {
    renderUsersTable(allUsers);
    return;
  }
  
  const filtered = allUsers.filter(u => 
    u.name?.toLowerCase().includes(query.toLowerCase()) ||
    u.email?.toLowerCase().includes(query.toLowerCase()) ||
    u.phone?.includes(query)
  );
  renderUsersTable(filtered);
}

// تحميل العروض
async function loadPromos() {
  allPromos = await giftstar.getData('promos') || [];
  renderPromosTable(allPromos);
}

function renderPromosTable(promos) {
  const tbody = document.getElementById('promosTableBody');
  
  if (!promos.length) {
    tbody.innerHTML = '<tr><td colspan="5" class="loading">لا توجد عروض</td></tr>';
    return;
  }
  
  tbody.innerHTML = promos.map(promo => `
    <tr>
      <td>${promo.title}</td>
      <td>${promo.description}</td>
      <td>${promo.badge || 'عرض'}</td>
      <td><span class="badge ${promo.active ? 'badge-success' : 'badge-danger'}">${promo.active ? 'نشط' : 'غير نشط'}</span></td>
      <td>
        <button class="action-btn" onclick="editPromo(${promo.id})">تعديل</button>
        <button class="action-btn danger" onclick="deletePromo(${promo.id})">حذف</button>
      </td>
    </tr>
  `).join('');
}

// تهيئة الصفحة
async function init() {
  const isAdmin = await checkAdmin();
  if (!isAdmin) return;
  
  await loadDashboard();
  
  // تحديث البيانات كل 30 ثانية
  setInterval(() => {
    if (currentPanel === 'dashboard') loadDashboard();
    else if (currentPanel === 'orders') loadOrders();
  }, 30000);
}

// بدء التطبيق
init();
</script>
</body>
</html>
