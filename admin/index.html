<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>لوحة التحكم - Gift Star</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800;900&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="../css/style.css">
<style>
  .admin-layout {
    display: flex;
    min-height: 100vh;
    background: var(--secondary);
  }

  .admin-sidebar {
    width: 280px;
    background: linear-gradient(180deg, var(--secondary) 0%, #000000 100%);
    color: var(--text);
    position: fixed;
    top: 0;
    bottom: 0;
    right: 0;
    overflow-y: auto;
    z-index: 100;
    box-shadow: var(--shadow-lg);
    border-left: 1px solid var(--border);
  }

  .admin-logo {
    padding: 35px 25px;
    border-bottom: 1px solid var(--border);
    text-align: center;
  }

  .admin-menu {
    padding: 20px 0;
  }

  .admin-menu-item {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 15px 25px;
    color: var(--text-muted);
    cursor: pointer;
    transition: var(--transition);
    font-size: 15px;
    border-right: 3px solid transparent;
  }

  .admin-menu-item:hover,
  .admin-menu-item.active {
    background: rgba(200,169,110,0.1);
    color: var(--primary);
    border-right-color: var(--primary);
  }

  .admin-main {
    margin-right: 280px;
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  .admin-topbar {
    background: var(--secondary-light);
    padding: 20px 35px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: var(--shadow-sm);
    position: sticky;
    top: 0;
    z-index: 50;
    border-bottom: 1px solid var(--border);
  }

  .admin-topbar h2 {
    font-size: 22px;
    font-weight: 800;
    color: var(--text);
  }

  .admin-user {
    display: flex;
    align-items: center;
    gap: 15px;
    color: var(--text-muted);
  }

  .admin-content {
    padding: 35px;
  }

  .admin-panel {
    display: none;
  }

  .admin-panel.active {
    display: block;
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 25px;
    margin-bottom: 40px;
  }

  .stat-card {
    background: var(--secondary-light);
    border-radius: var(--radius);
    padding: 30px;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border);
    transition: var(--transition);
  }

  .stat-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-hover);
  }

  .stat-number {
    font-size: 38px;
    font-weight: 900;
    color: var(--text);
    line-height: 1;
    margin-bottom: 8px;
  }

  .stat-label {
    font-size: 14px;
    color: var(--text-muted);
  }

  .admin-table-wrap {
    background: var(--secondary-light);
    border-radius: var(--radius);
    box-shadow: var(--shadow-sm);
    overflow: hidden;
    border: 1px solid var(--border);
    margin-top: 20px;
  }

  .admin-table-header {
    padding: 20px 25px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--border);
    background: var(--secondary);
  }

  .admin-table-header h3 {
    font-size: 18px;
    font-weight: 800;
    color: var(--text);
  }

  .btn-add {
    background: linear-gradient(135deg, var(--primary), var(--primary-light));
    color: var(--secondary);
    border: none;
    padding: 10px 22px;
    border-radius: 30px;
    font-size: 14px;
    font-weight: 700;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
  }

  th {
    background: var(--secondary);
    padding: 15px 20px;
    text-align: right;
    font-weight: 700;
    color: var(--text);
    font-size: 13px;
    border-bottom: 1px solid var(--border);
  }

  td {
    padding: 15px 20px;
    border-bottom: 1px solid var(--border);
    color: var(--text-muted);
  }

  tr:hover td {
    background: var(--secondary);
  }

  .status-badge {
    display: inline-block;
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
  }

  .status-badge.new { background: rgba(94,201,138,0.2); color: #5ec98a; }
  .status-badge.processing { background: rgba(243,156,18,0.2); color: #f39c12; }
  .status-badge.delivered { background: rgba(52,152,219,0.2); color: #3498db; }
  .status-badge.cancelled { background: rgba(224,85,85,0.2); color: #e05555; }

  .action-btn {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    border: 1px solid var(--border);
    background: var(--secondary);
    color: var(--text);
    margin: 0 3px;
  }

  .action-btn:hover {
    background: var(--primary);
    color: var(--secondary);
    border-color: var(--primary);
  }

  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.8);
    backdrop-filter: blur(8px);
    z-index: 2000;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }

  .modal-overlay.open {
    display: flex;
  }

  .modal-card {
    background: var(--secondary-light);
    border-radius: var(--radius-lg);
    width: 100%;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: var(--shadow-lg);
    border: 1px solid var(--border);
  }

  .modal-header {
    padding: 30px 30px 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .modal-header h3 {
    font-size: 22px;
    font-weight: 800;
    color: var(--text);
  }

  .modal-close {
    background: none;
    border: none;
    font-size: 28px;
    cursor: pointer;
    color: var(--text-muted);
  }

  .modal-body {
    padding: 20px 30px;
  }

  .modal-footer {
    padding: 0 30px 30px;
    display: flex;
    gap: 15px;
    justify-content: flex-end;
  }

  .product-form {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
  }

  .product-form .full-width {
    grid-column: span 2;
  }

  .order-timeline {
    margin-top: 20px;
    padding: 20px;
    background: var(--secondary);
    border-radius: var(--radius);
  }

  .timeline-item {
    display: flex;
    gap: 15px;
    padding: 10px 0;
    border-bottom: 1px solid var(--border);
  }

  .timeline-item:last-child {
    border-bottom: none;
  }

  .timeline-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: var(--primary);
    margin-top: 8px;
  }

  .timeline-date {
    font-size: 12px;
    color: var(--text-muted);
  }

  .search-box {
    display: flex;
    gap: 10px;
    align-items: center;
  }

  .search-box input {
    padding: 10px 15px;
    border-radius: 30px;
    border: 1px solid var(--border);
    background: var(--secondary);
    color: var(--text);
    width: 250px;
  }

  @media (max-width: 1024px) {
    .admin-sidebar { width: 240px; }
    .admin-main { margin-right: 240px; }
    .stats-grid { grid-template-columns: repeat(2, 1fr); }
  }

  @media (max-width: 768px) {
    .admin-sidebar { display: none; }
    .admin-main { margin-right: 0; }
    .stats-grid { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>
<div class="admin-layout">
  <!-- القائمة الجانبية -->
  <aside class="admin-sidebar">
    <div class="admin-logo">
      <div class="logo">
        <div class="logo-star">★</div>
        <div class="logo-text">
          <span class="logo-gift">Gift</span>
          <span class="logo-star-word">Star</span>
        </div>
      </div>
      <div style="color:var(--primary); font-size:13px; margin-top:5px">لوحة التحكم</div>
    </div>
    
    <div class="admin-menu">
      <div class="admin-menu-item active" onclick="showPanel('dashboard')">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="7" height="7"></rect>
          <rect x="14" y="3" width="7" height="7"></rect>
          <rect x="14" y="14" width="7" height="7"></rect>
          <rect x="3" y="14" width="7" height="7"></rect>
        </svg>
        لوحة المعلومات
      </div>
      <div class="admin-menu-item" onclick="showPanel('orders')">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path>
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <path d="M16 10a4 4 0 0 1-8 0"></path>
        </svg>
        الطلبات
      </div>
      <div class="admin-menu-item" onclick="showPanel('products')">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
          <line x1="7" y1="7" x2="7.01" y2="7"></line>
        </svg>
        المنتجات
      </div>
      <div class="admin-menu-item" onclick="showPanel('users')">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
          <circle cx="12" cy="7" r="4"></circle>
        </svg>
        المستخدمين
      </div>
      <div class="admin-menu-item" onclick="showPanel('promos')">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 2v4M12 22v-4M4 12H2M22 12h-2M19.07 4.93l-2.83 2.83M6.9 17.1l-2.82 2.82M17.1 6.9l2.82-2.82M4.93 19.07l2.83-2.83"></path>
          <circle cx="12" cy="12" r="3"></circle>
        </svg>
        العروض
      </div>
      <div class="admin-menu-item" onclick="logout()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
          <polyline points="16 17 21 12 16 7"></polyline>
          <line x1="21" y1="2" x2="9" y2="12"></line>
        </svg>
        خروج
      </div>
    </div>
  </aside>
  
  <!-- المحتوى الرئيسي -->
  <main class="admin-main">
    <div class="admin-topbar">
      <h2 id="panelTitle">لوحة المعلومات</h2>
      <div class="admin-user" id="adminUser">
        <span>مرحباً، <span id="adminName"></span></span>
        <span class="status-dot"></span>
      </div>
    </div>
    
    <div class="admin-content">
      <!-- لوحة المعلومات -->
      <div id="dashboardPanel" class="admin-panel active">
        <div class="stats-grid" id="statsGrid">
          <div class="loading">جاري التحميل...</div>
        </div>
        
        <div class="admin-table-wrap">
          <div class="admin-table-header">
            <h3>آخر الطلبات</h3>
            <button class="btn-add" onclick="showPanel('orders')">عرض الكل</button>
          </div>
          <table id="recentOrdersTable">
            <thead>
              <tr>
                <th>رقم الطلب</th>
                <th>العميل</th>
                <th>المبلغ</th>
                <th>الحالة</th>
                <th>التاريخ</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      
      <!-- الطلبات -->
      <div id="ordersPanel" class="admin-panel">
        <div class="admin-table-header">
          <h3>جميع الطلبات</h3>
          <div class="search-box">
            <input type="text" id="orderSearch" placeholder="بحث برقم الطلب أو البريد..." onkeyup="searchOrders()">
            <select id="orderFilter" onchange="filterOrders()" style="padding:10px; border-radius:30px; background:var(--secondary); color:var(--text); border:1px solid var(--border);">
              <option value="all">جميع الحالات</option>
              <option value="new">جديد</option>
              <option value="processing">قيد المعالجة</option>
              <option value="delivered">تم التوصيل</option>
              <option value="cancelled">ملغي</option>
            </select>
          </div>
        </div>
        <div class="admin-table-wrap">
          <table>
            <thead>
              <tr>
                <th>رقم الطلب</th>
                <th>العميل</th>
                <th>الهاتف</th>
                <th>المبلغ</th>
                <th>الحالة</th>
                <th>التاريخ</th>
                <th>الإجراءات</th>
              </tr>
            </thead>
            <tbody id="ordersTableBody"></tbody>
          </table>
        </div>
      </div>
      
      <!-- المنتجات -->
      <div id="productsPanel" class="admin-panel">
        <div class="admin-table-header">
          <h3>المنتجات</h3>
          <button class="btn-add" onclick="showAddProductForm()">+ إضافة منتج</button>
        </div>
        
        <!-- نموذج إضافة منتج -->
        <div id="addProductForm" style="display:none; margin-bottom:20px;">
          <div class="admin-table-wrap">
            <div class="admin-table-header">
              <h3>إضافة منتج جديد</h3>
            </div>
            <div style="padding:20px;">
              <div class="product-form">
                <div class="full-width">
                  <label class="form-label">اسم المنتج</label>
                  <input type="text" id="productName" class="form-input" placeholder="اسم المنتج">
                </div>
                <div>
                  <label class="form-label">الفئة</label>
                  <select id="productCategory" class="form-select">
                    <option value="cakes">كيك</option>
                    <option value="flowers">ورد</option>
                    <option value="gifts">هدايا</option>
                    <option value="chocolate">شوكولاتة</option>
                  </select>
                </div>
                <div>
                  <label class="form-label">السعر (د.ك)</label>
                  <input type="number" id="productPrice" class="form-input" step="0.001" min="0">
                </div>
                <div>
                  <label class="form-label">المخزون</label>
                  <input type="number" id="productStock" class="form-input" min="0" value="10">
                </div>
                <div class="full-width">
                  <label class="form-label">رابط الصورة</label>
                  <input type="url" id="productImage" class="form-input" placeholder="https://...">
                </div>
                <div class="full-width">
                  <label class="form-label">الوصف</label>
                  <textarea id="productDescription" class="form-textarea" rows="3"></textarea>
                </div>
                <div>
                  <label>
                    <input type="checkbox" id="productFeatured"> منتج مميز
                  </label>
                </div>
                <div>
                  <label>
                    <input type="checkbox" id="productActive" checked> متاح
                  </label>
                </div>
              </div>
              <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:20px;">
                <button class="action-btn" onclick="cancelAddProduct()">إلغاء</button>
                <button class="action-btn" onclick="saveProduct()">حفظ المنتج</button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- جدول المنتجات -->
        <div class="admin-table-wrap">
          <table>
            <thead>
              <tr>
                <th>الصورة</th>
                <th>المنتج</th>
                <th>الفئة</th>
                <th>السعر</th>
                <th>المخزون</th>
                <th>الحالة</th>
                <th>الإجراءات</th>
              </tr>
            </thead>
            <tbody id="productsTableBody"></tbody>
          </table>
        </div>
      </div>
      
      <!-- المستخدمين -->
      <div id="usersPanel" class="admin-panel">
        <div class="admin-table-header">
          <h3>المستخدمين</h3>
          <div class="search-box">
            <input type="text" id="userSearch" placeholder="بحث بالاسم أو البريد..." onkeyup="searchUsers()">
          </div>
        </div>
        <div class="admin-table-wrap">
          <table>
            <thead>
              <tr>
                <th>الاسم</th>
                <th>البريد الإلكتروني</th>
                <th>رقم الهاتف</th>
                <th>الدور</th>
                <th>تاريخ التسجيل</th>
                <th>الحالة</th>
              </tr>
            </thead>
            <tbody id="usersTableBody"></tbody>
          </table>
        </div>
      </div>
      
      <!-- العروض -->
      <div id="promosPanel" class="admin-panel">
        <div class="admin-table-header">
          <h3>العروض</h3>
          <button class="btn-add" onclick="showAddPromoForm()">+ إضافة عرض</button>
        </div>
        
        <!-- نموذج إضافة عرض -->
        <div id="addPromoForm" style="display:none; margin-bottom:20px;">
          <div class="admin-table-wrap">
            <div class="admin-table-header">
              <h3>إضافة عرض جديد</h3>
            </div>
            <div style="padding:20px;">
              <div style="display:grid; gap:15px;">
                <div>
                  <label class="form-label">عنوان العرض</label>
                  <input type="text" id="promoTitle" class="form-input">
                </div>
                <div>
                  <label class="form-label">الوصف</label>
                  <input type="text" id="promoDescription" class="form-input">
                </div>
                <div>
                  <label class="form-label">الوسام</label>
                  <input type="text" id="promoBadge" class="form-input" placeholder="مثلاً: عرض خاص">
                </div>
                <div>
                  <label class="form-label">رابط الصورة</label>
                  <input type="url" id="promoImage" class="form-input">
                </div>
                <div>
                  <label>
                    <input type="checkbox" id="promoActive" checked> فعال
                  </label>
                </div>
              </div>
              <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:20px;">
                <button class="action-btn" onclick="cancelAddPromo()">إلغاء</button>
                <button class="action-btn" onclick="savePromo()">حفظ العرض</button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- جدول العروض -->
        <div class="admin-table-wrap">
          <table>
            <thead>
              <tr>
                <th>العنوان</th>
                <th>الوصف</th>
                <th>الوسام</th>
                <th>الحالة</th>
                <th>الإجراءات</th>
              </tr>
            </thead>
            <tbody id="promosTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </main>
</div>

<!-- نافذة تفاصيل الطلب -->
<div class="modal-overlay" id="orderModal">
  <div class="modal-card">
    <div class="modal-header">
      <h3>تفاصيل الطلب <span id="modalOrderId"></span></h3>
      <button class="modal-close" onclick="closeOrderModal()">✕</button>
    </div>
    <div class="modal-body" id="orderModalBody"></div>
    <div class="modal-footer">
      <select id="orderStatusSelect" style="padding:10px; border-radius:30px; background:var(--secondary); color:var(--text); border:1px solid var(--border);">
        <option value="new">جديد</option>
        <option value="processing">قيد المعالجة</option>
        <option value="delivered">تم التوصيل</option>
        <option value="cancelled">ملغي</option>
      </select>
      <button class="action-btn" onclick="updateOrderStatus()">تحديث الحالة</button>
      <button class="action-btn" onclick="printOrder()">طباعة</button>
    </div>
    <div class="order-timeline" id="orderTimeline"></div>
  </div>
</div>

<!-- نافذة تعديل منتج -->
<div class="modal-overlay" id="editProductModal">
  <div class="modal-card">
    <div class="modal-header">
      <h3>تعديل المنتج</h3>
      <button class="modal-close" onclick="closeEditProductModal()">✕</button>
    </div>
    <div class="modal-body" id="editProductModalBody"></div>
  </div>
</div>

<script src="../js/data.js"></script>
<script>
// =========================================
// المتغيرات العامة
// =========================================
let currentPanel = 'dashboard';
let allOrders = [];
let allProducts = [];
let allUsers = [];
let allPromos = [];

// =========================================
// التحقق من صلاحيات المدير
// =========================================
function checkAdmin() {
  const user = giftstar.getCurrentUser();
  if (!user || user.role !== 'admin') {
    window.location.href = '../login.html';
    return false;
  }
  document.getElementById('adminName').textContent = user.name;
  return true;
}

// =========================================
// تبديل اللوحات
// =========================================
function showPanel(panel) {
  document.querySelectorAll('.admin-panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.admin-menu-item').forEach(i => i.classList.remove('active'));
  
  document.getElementById(panel + 'Panel').classList.add('active');
  event.currentTarget.classList.add('active');
  
  const titles = {
    dashboard: 'لوحة المعلومات',
    orders: 'إدارة الطلبات',
    products: 'إدارة المنتجات',
    users: 'المستخدمين',
    promos: 'العروض'
  };
  
  document.getElementById('panelTitle').textContent = titles[panel];
  currentPanel = panel;
  
  // تحميل البيانات
  if (panel === 'dashboard') loadDashboard();
  else if (panel === 'orders') loadOrders();
  else if (panel === 'products') loadProducts();
  else if (panel === 'users') loadUsers();
  else if (panel === 'promos') loadPromos();
}

// =========================================
// لوحة المعلومات
// =========================================
function loadDashboard() {
  const stats = giftstar.getDashboardStats();
  const orders = giftstar.getAllOrders();
  
  // عرض الإحصائيات
  document.getElementById('statsGrid').innerHTML = `
    <div class="stat-card">
      <div class="stat-number">${stats.totalOrders}</div>
      <div class="stat-label">إجمالي الطلبات</div>
      <div style="color:var(--success); font-size:13px; margin-top:5px;">+${stats.todayOrders} اليوم</div>
    </div>
    <div class="stat-card">
      <div class="stat-number">${stats.totalProducts}</div>
      <div class="stat-label">المنتجات النشطة</div>
    </div>
    <div class="stat-card">
      <div class="stat-number">${stats.totalUsers}</div>
      <div class="stat-label">العملاء</div>
    </div>
    <div class="stat-card">
      <div class="stat-number">${giftstar.formatKWD(stats.totalRevenue)}</div>
      <div class="stat-label">إجمالي الإيرادات</div>
      <div style="color:var(--success); font-size:13px; margin-top:5px;">+${giftstar.formatKWD(stats.todayRevenue)} اليوم</div>
    </div>
  `;
  
  // آخر 5 طلبات
  const recentOrders = orders.slice(0, 5);
  const tbody = document.querySelector('#recentOrdersTable tbody');
  
  if (recentOrders.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center">لا توجد طلبات</td></tr>';
  } else {
    tbody.innerHTML = recentOrders.map(o => `
      <tr onclick="viewOrderDetails('${o.id}')" style="cursor:pointer">
        <td><strong>${o.id}</strong></td>
        <td>${o.customer?.name || 'غير محدد'}</td>
        <td>${giftstar.formatKWD(o.total || 0)}</td>
        <td><span class="status-badge ${o.status || 'new'}">${o.status || 'جديد'}</span></td>
        <td>${o.date || ''}</td>
      </tr>
    `).join('');
  }
}

// =========================================
// إدارة الطلبات
// =========================================
function loadOrders() {
  allOrders = giftstar.getAllOrders();
  renderOrdersTable(allOrders);
}

function renderOrdersTable(orders) {
  const tbody = document.getElementById('ordersTableBody');
  
  if (!orders || orders.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center">لا توجد طلبات</td></tr>';
    return;
  }
  
  tbody.innerHTML = orders.map(o => `
    <tr>
      <td><strong>${o.id}</strong></td>
      <td>${o.customer?.name || 'غير محدد'}</td>
      <td>${o.customer?.phone || 'غير محدد'}</td>
      <td>${giftstar.formatKWD(o.total || 0)}</td>
      <td><span class="status-badge ${o.status || 'new'}">${o.status || 'جديد'}</span></td>
      <td>${o.date || ''}</td>
      <td>
        <button class="action-btn" onclick="viewOrderDetails('${o.id}')">عرض</button>
      </td>
    </tr>
  `).join('');
}

function filterOrders() {
  const filter = document.getElementById('orderFilter').value;
  if (filter === 'all') {
    renderOrdersTable(allOrders);
  } else {
    const filtered = allOrders.filter(o => o.status === filter);
    renderOrdersTable(filtered);
  }
}

function searchOrders() {
  const search = document.getElementById('orderSearch').value.toLowerCase();
  if (!search) {
    renderOrdersTable(allOrders);
    return;
  }
  
  const filtered = allOrders.filter(o => 
    o.id.toLowerCase().includes(search) || 
    (o.customer?.name && o.customer.name.toLowerCase().includes(search)) ||
    (o.userEmail && o.userEmail.toLowerCase().includes(search))
  );
  renderOrdersTable(filtered);
}

// =========================================
// تفاصيل الطلب
// =========================================
function viewOrderDetails(orderId) {
  const order = giftstar.getOrderById(orderId);
  if (!order) return;
  
  document.getElementById('modalOrderId').textContent = order.id;
  
  const itemsHTML = (order.items || []).map(item => `
    <div style="display:flex; justify-content:space-between; margin-bottom:5px">
      <span>${item.name} x${item.qty}</span>
      <span>${giftstar.formatKWD(item.price * item.qty)}</span>
    </div>
  `).join('');
  
  document.getElementById('orderModalBody').innerHTML = `
    <div style="margin-bottom:20px">
      <h4>معلومات العميل</h4>
      <p><strong>الاسم:</strong> ${order.customer?.name || 'غير محدد'}</p>
      <p><strong>الهاتف:</strong> ${order.customer?.phone || 'غير محدد'}</p>
      <p><strong>العنوان:</strong> ${order.customer?.address || 'غير محدد'}</p>
    </div>
    <div style="margin-bottom:20px">
      <h4>المنتجات</h4>
      ${itemsHTML}
      <div style="border-top:1px solid var(--border); margin-top:10px; padding-top:10px">
        <p><strong>المجموع:</strong> ${giftstar.formatKWD(order.total || 0)}</p>
        <p><strong>طريقة الدفع:</strong> ${order.paymentMethod || 'غير محدد'}</p>
      </div>
    </div>
  `;
  
  // الجدول الزمني
  const timelineHTML = (order.statusHistory || []).map(h => `
    <div class="timeline-item">
      <div class="timeline-dot"></div>
      <div class="timeline-content">
        <strong>${h.status}</strong>
        <p>${h.note || ''}</p>
        <div class="timeline-date">${new Date(h.date).toLocaleString('ar-KW')}</div>
      </div>
    </div>
  `).join('');
  
  document.getElementById('orderTimeline').innerHTML = timelineHTML || '<p>لا يوجد سجل للطلبات</p>';
  document.getElementById('orderStatusSelect').value = order.status || 'new';
  
  document.getElementById('orderModal').classList.add('open');
}

function closeOrderModal() {
  document.getElementById('orderModal').classList.remove('open');
}

function updateOrderStatus() {
  const orderId = document.getElementById('modalOrderId').textContent;
  const newStatus = document.getElementById('orderStatusSelect').value;
  
  const success = giftstar.updateOrderStatus(orderId, newStatus, 'تم التحديث بواسطة المدير');
  
  if (success) {
    giftstar.showNotification('تم تحديث حالة الطلب', 'success');
    closeOrderModal();
    loadOrders();
    loadDashboard();
  }
}

function printOrder() {
  const orderId = document.getElementById('modalOrderId').textContent;
  window.open(`../receipt.html?order=${orderId}`, '_blank');
}

// =========================================
// إدارة المنتجات
// =========================================
function loadProducts() {
  allProducts = giftstar.getProducts({ active: true });
  renderProductsTable(allProducts);
}

function renderProductsTable(products) {
  const tbody = document.getElementById('productsTableBody');
  
  if (!products || products.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center">لا توجد منتجات</td></tr>';
    return;
  }
  
  tbody.innerHTML = products.map(p => `
    <tr>
      <td><img src="${p.image}" style="width:50px; height:50px; border-radius:8px; object-fit:cover;"></td>
      <td>${p.name}</td>
      <td>${p.category}</td>
      <td>${giftstar.formatKWD(p.price)}</td>
      <td>${p.stock || 0}</td>
      <td><span class="status-badge ${p.active ? 'new' : 'cancelled'}">${p.active ? 'نشط' : 'غير نشط'}</span></td>
      <td>
        <button class="action-btn" onclick="editProduct(${p.id})">تعديل</button>
        <button class="action-btn" onclick="deleteProduct(${p.id})">حذف</button>
      </td>
    </tr>
  `).join('');
}

function showAddProductForm() {
  document.getElementById('addProductForm').style.display = 'block';
}

function cancelAddProduct() {
  document.getElementById('addProductForm').style.display = 'none';
  document.getElementById('productName').value = '';
  document.getElementById('productPrice').value = '';
  document.getElementById('productImage').value = '';
  document.getElementById('productDescription').value = '';
  document.getElementById('productFeatured').checked = false;
  document.getElementById('productActive').checked = true;
  document.getElementById('productStock').value = 10;
}

function saveProduct() {
  const product = {
    name: document.getElementById('productName').value,
    category: document.getElementById('productCategory').value,
    price: parseFloat(document.getElementById('productPrice').value),
    stock: parseInt(document.getElementById('productStock').value),
    image: document.getElementById('productImage').value,
    description: document.getElementById('productDescription').value,
    featured: document.getElementById('productFeatured').checked,
    active: document.getElementById('productActive').checked
  };
  
  if (!product.name || !product.price || !product.image) {
    giftstar.showNotification('يرجى ملء جميع الحقول المطلوبة', 'error');
    return;
  }
  
  const result = giftstar.addProduct(product);
  
  if (result.success) {
    giftstar.showNotification('تم إضافة المنتج', 'success');
    cancelAddProduct();
    loadProducts();
  }
}

function editProduct(id) {
  const product = giftstar.getProductById(id);
  if (!product) return;
  
  // تعبئة النموذج
  document.getElementById('productName').value = product.name;
  document.getElementById('productCategory').value = product.category;
  document.getElementById('productPrice').value = product.price;
  document.getElementById('productStock').value = product.stock || 10;
  document.getElementById('productImage').value = product.image;
  document.getElementById('productDescription').value = product.description;
  document.getElementById('productFeatured').checked = product.featured || false;
  document.getElementById('productActive').checked = product.active;
  
  // تغيير زر الحفظ ليكون تعديل
  document.getElementById('addProductForm').style.display = 'block';
  
  // حفظ مؤقت للـ id
  window.editingProductId = id;
  
  // تغيير دالة الحفظ مؤقتاً
  const saveBtn = document.querySelector('#addProductForm .action-btn:last-child');
  saveBtn.onclick = function() {
    const updatedProduct = {
      id: window.editingProductId,
      name: document.getElementById('productName').value,
      category: document.getElementById('productCategory').value,
      price: parseFloat(document.getElementById('productPrice').value),
      stock: parseInt(document.getElementById('productStock').value),
      image: document.getElementById('productImage').value,
      description: document.getElementById('productDescription').value,
      featured: document.getElementById('productFeatured').checked,
      active: document.getElementById('productActive').checked
    };
    
    const result = giftstar.updateProduct(updatedProduct);
    
    if (result.success) {
      giftstar.showNotification('تم تحديث المنتج', 'success');
      cancelAddProduct();
      loadProducts();
      saveBtn.onclick = saveProduct; // إعادة الدالة الأصلية
    }
  };
}

function deleteProduct(id) {
  if (!confirm('هل أنت متأكد من حذف هذا المنتج؟')) return;
  
  const result = giftstar.deleteProduct(id);
  
  if (result.success) {
    giftstar.showNotification('تم حذف المنتج', 'success');
    loadProducts();
  }
}

// =========================================
// إدارة المستخدمين
// =========================================
function loadUsers() {
  allUsers = giftstar.getAllUsers();
  renderUsersTable(allUsers);
}

function renderUsersTable(users) {
  const tbody = document.getElementById('usersTableBody');
  
  if (!users || users.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center">لا يوجد مستخدمين</td></tr>';
    return;
  }
  
  tbody.innerHTML = users.map(u => `
    <tr>
      <td>${u.name || 'غير محدد'}</td>
      <td>${u.email}</td>
      <td>${u.phone || 'غير محدد'}</td>
      <td><span class="status-badge ${u.role === 'admin' ? 'processing' : 'new'}">${u.role === 'admin' ? 'مدير' : 'عميل'}</span></td>
      <td>${u.createdAt ? new Date(u.createdAt).toLocaleDateString('ar-KW') : 'غير محدد'}</td>
      <td><span class="status-badge ${u.verified ? 'new' : 'cancelled'}">${u.verified ? 'مفعل' : 'غير مفعل'}</span></td>
    </tr>
  `).join('');
}

function searchUsers() {
  const search = document.getElementById('userSearch').value.toLowerCase();
  if (!search) {
    renderUsersTable(allUsers);
    return;
  }
  
  const filtered = allUsers.filter(u => 
    (u.name && u.name.toLowerCase().includes(search)) ||
    (u.email && u.email.toLowerCase().includes(search)) ||
    (u.phone && u.phone.includes(search))
  );
  renderUsersTable(filtered);
}

// =========================================
// إدارة العروض
// =========================================
function loadPromos() {
  allPromos = giftstar.getPromos();
  renderPromosTable(allPromos);
}

function renderPromosTable(promos) {
  const tbody = document.getElementById('promosTableBody');
  
  if (!promos || promos.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center">لا توجد عروض</td></tr>';
    return;
  }
  
  tbody.innerHTML = promos.map(p => `
    <tr>
      <td>${p.title}</td>
      <td>${p.description}</td>
      <td>${p.badge || 'عرض'}</td>
      <td><span class="status-badge ${p.active ? 'new' : 'cancelled'}">${p.active ? 'نشط' : 'غير نشط'}</span></td>
      <td>
        <button class="action-btn" onclick="editPromo(${p.id})">تعديل</button>
        <button class="action-btn" onclick="deletePromo(${p.id})">حذف</button>
      </td>
    </tr>
  `).join('');
}

function showAddPromoForm() {
  document.getElementById('addPromoForm').style.display = 'block';
}

function cancelAddPromo() {
  document.getElementById('addPromoForm').style.display = 'none';
  document.getElementById('promoTitle').value = '';
  document.getElementById('promoDescription').value = '';
  document.getElementById('promoBadge').value = '';
  document.getElementById('promoImage').value = '';
  document.getElementById('promoActive').checked = true;
}

function savePromo() {
  const promo = {
    title: document.getElementById('promoTitle').value,
    description: document.getElementById('promoDescription').value,
    badge: document.getElementById('promoBadge').value,
    image: document.getElementById('promoImage').value || 'https://images.unsplash.com/photo-1549465220-1a8b9238cd48?w=600&h=300&fit=crop',
    active: document.getElementById('promoActive').checked
  };
  
  if (!promo.title || !promo.description) {
    giftstar.showNotification('يرجى ملء جميع الحقول', 'error');
    return;
  }
  
  const result = giftstar.addPromo(promo);
  
  if (result.success) {
    giftstar.showNotification('تم إضافة العرض', 'success');
    cancelAddPromo();
    loadPromos();
  }
}

function deletePromo(id) {
  if (!confirm('هل أنت متأكد من حذف هذا العرض؟')) return;
  
  const result = giftstar.deletePromo(id);
  
  if (result.success) {
    giftstar.showNotification('تم حذف العرض', 'success');
    loadPromos();
  }
}

// =========================================
// تسجيل الخروج
// =========================================
function logout() {
  giftstar.logout();
}

// =========================================
// تهيئة الصفحة
// =========================================
function init() {
  if (!checkAdmin()) return;
  loadDashboard();
  
  // تحديث البيانات كل 30 ثانية
  setInterval(() => {
    if (currentPanel === 'dashboard') loadDashboard();
    else if (currentPanel === 'orders') loadOrders();
  }, 30000);
}

// بدء التطبيق
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
