<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>لوحة التحكم - Gift Star</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800;900&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="../css/style.css">
<style>
  /* نفس التنسيقات السابقة للوحة التحكم */
  .admin-layout { display: flex; min-height: 100vh; background: var(--secondary); }
  .admin-sidebar { width: 280px; background: linear-gradient(180deg, var(--secondary) 0%, #000000 100%); position: fixed; top: 0; bottom: 0; right: 0; border-left: 1px solid var(--border); }
  .admin-main { margin-right: 280px; flex: 1; }
  .admin-content { padding: 35px; }
  .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 25px; margin-bottom: 40px; }
  .stat-card { background: var(--secondary-light); border-radius: var(--radius); padding: 30px; border: 1px solid var(--border); }
  .stat-number { font-size: 38px; font-weight: 900; color: var(--text); }
  .admin-table-wrap { background: var(--secondary-light); border-radius: var(--radius); border: 1px solid var(--border); margin-top: 20px; }
  .admin-table-header { padding: 20px 25px; border-bottom: 1px solid var(--border); background: var(--secondary); display: flex; justify-content: space-between; }
  table { width: 100%; border-collapse: collapse; }
  th { background: var(--secondary); padding: 15px 20px; text-align: right; border-bottom: 1px solid var(--border); }
  td { padding: 15px 20px; border-bottom: 1px solid var(--border); color: var(--text-muted); }
  .status-badge { display: inline-block; padding: 5px 12px; border-radius: 20px; font-size: 12px; }
  .status-badge.new { background: rgba(94,201,138,0.2); color: #5ec98a; }
  .action-btn { padding: 6px 12px; border-radius: 20px; border: 1px solid var(--border); background: var(--secondary); color: var(--text); margin: 0 3px; cursor: pointer; }
  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 2000; }
  .modal-card { background: var(--secondary-light); border-radius: var(--radius-lg); max-width: 600px; width: 100%; border: 1px solid var(--border); }
  .loading { text-align: center; padding: 60px; }
  .spinner { width: 50px; height: 50px; border: 4px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto; }
  @keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>
<div class="admin-layout">
  <aside class="admin-sidebar">[نفس القائمة الجانبية السابقة]</aside>
  <main class="admin-main">
    <div class="admin-topbar">
      <h2 id="panelTitle">لوحة المعلومات</h2>
      <div class="admin-user">مرحباً، <span id="adminName"></span></div>
    </div>
    <div class="admin-content" id="adminContent">
      <div class="loading"><div class="spinner"></div>جاري التحميل...</div>
    </div>
  </main>
</div>

<script src="../js/data.js"></script>
<script>
let currentPanel = 'dashboard';

function checkAdmin() {
    const user = JSON.parse(sessionStorage.getItem('giftstar_user') || 'null');
    if (!user || user.role !== 'admin') { window.location.href = '../login.html'; return false; }
    document.getElementById('adminName').textContent = user.name;
    return true;
}

function loadDashboard() {
    const orders = JSON.parse(localStorage.getItem('giftstar_orders') || '[]');
    const products = JSON.parse(localStorage.getItem('giftstar_products') || '[]');
    const users = JSON.parse(localStorage.getItem('giftstar_users') || '[]');
    
    const totalRevenue = orders.reduce((s,o) => s + (o.total||0), 0);
    
    document.getElementById('adminContent').innerHTML = `
        <div class="stats-grid">
            <div class="stat-card"><div class="stat-number">${orders.length}</div><div class="stat-label">إجمالي الطلبات</div></div>
            <div class="stat-card"><div class="stat-number">${products.filter(p=>p.active).length}</div><div class="stat-label">المنتجات</div></div>
            <div class="stat-card"><div class="stat-number">${users.filter(u=>u.role==='customer').length}</div><div class="stat-label">العملاء</div></div>
            <div class="stat-card"><div class="stat-number">${(totalRevenue).toFixed(3)} د.ك</div><div class="stat-label">الإيرادات</div></div>
        </div>
        <div class="admin-table-wrap">
            <div class="admin-table-header"><h3>آخر الطلبات</h3></div>
            <table><thead><tr><th>الطلب</th><th>العميل</th><th>المبلغ</th><th>الحالة</th></tr></thead>
            <tbody>${orders.slice(0,5).map(o=>`
                <tr><td>${o.id}</td><td>${o.customer?.name||''}</td><td>${(o.total||0).toFixed(3)} د.ك</td>
                <td><span class="status-badge ${o.status||'new'}">${o.status||'جديد'}</span></td></tr>
            `).join('')}</tbody>
            </table>
        </div>
    `;
}

function init() {
    if (!checkAdmin()) return;
    loadDashboard();
}

document.addEventListener('DOMContentLoaded', init);
</script>

<!-- ========================================= -->
<!-- كود Firebase - يضاف في نهاية كل صفحة -->
<!-- ========================================= -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { 
  getFirestore,
  collection,
  addDoc,
  onSnapshot,
  doc,
  updateDoc,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCtHnYZT8yq9tp7xaA7AyJQV4Ag4Wi1Yks",
  authDomain: "gift-star-abf48.firebaseapp.com",
  projectId: "gift-star-abf48",
  storageBucket: "gift-star-abf48.firebasestorage.app",
  messagingSenderId: "546782076914",
  appId: "1:546782076914:web:3fb957a03c7e0501fc556b"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

window.db = db;
window.fb = {
  collection,
  addDoc,
  onSnapshot,
  doc,
  updateDoc,
  serverTimestamp
};

console.log('✅ Firebase loaded in admin/index.html');
</script>

<!-- Firebase Messaging -->
<script>
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/firebase-messaging-sw.js')
        .then((registration) => {
            console.log('✅ Service Worker registered:', registration);
        })
        .catch((error) => {
            console.error('❌ Service Worker registration failed:', error);
        });
}
</script>
</body>
</html>
