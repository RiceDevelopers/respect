<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>إنشاء حساب - Gift Star</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800;900&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="css/style.css">
</head>
<body>
<header class="site-header">
  <div class="header-main">
    <div class="container header-flex">
      <a href="index.html" class="logo">
        <div class="logo-star">★</div>
        <div class="logo-text">
          <span class="logo-gift">Gift</span>
          <span class="logo-star-word">Star</span>
        </div>
      </a>
    </div>
  </div>
</header>

<div class="auth-page">
  <!-- Step 1: Register form -->
  <div class="auth-card" id="step1">
    <h2>إنشاء حساب</h2>
    <p class="auth-sub">انضم إلى Gift Star واحصل على أفضل الهدايا</p>

    <div id="regError" class="alert alert-error" style="display:none"></div>

    <div class="form-group">
      <label class="form-label">الاسم الكامل</label>
      <input type="text" id="regName" class="form-input" placeholder="اسمك الكريم">
    </div>
    <div class="form-group">
      <label class="form-label">البريد الإلكتروني</label>
      <input type="email" id="regEmail" class="form-input" placeholder="example@email.com" dir="ltr">
    </div>
    <div class="form-group">
      <label class="form-label">كلمة المرور</label>
      <input type="password" id="regPass" class="form-input" placeholder="8 أحرف على الأقل" dir="ltr">
    </div>
    <div class="form-group">
      <label class="form-label">تأكيد كلمة المرور</label>
      <input type="password" id="regPass2" class="form-input" placeholder="أعد كتابة كلمة المرور" dir="ltr">
    </div>

    <button class="btn-submit" onclick="doRegister()">إنشاء الحساب</button>

    <div class="auth-footer">
      لديك حساب؟ <a href="login.html">تسجيل الدخول</a>
    </div>
  </div>

  <!-- Step 2: OTP Verification -->
  <div class="auth-card" id="step2" style="display:none">
    <h2>تحقق من الكود</h2>
    <p class="auth-sub" id="otpMsg">تم إرسال كود التحقق إلى بريدك الإلكتروني</p>

    <div id="otpError" class="alert alert-error" style="display:none"></div>

    <div class="form-group">
      <label class="form-label" style="text-align:center;display:block;margin-bottom:16px">أدخل الكود المكون من 6 أرقام</label>
      <div class="otp-inputs" id="otpInputs">
        <input type="text" class="otp-input" maxlength="1" oninput="otpMove(this, 0)">
        <input type="text" class="otp-input" maxlength="1" oninput="otpMove(this, 1)">
        <input type="text" class="otp-input" maxlength="1" oninput="otpMove(this, 2)">
        <input type="text" class="otp-input" maxlength="1" oninput="otpMove(this, 3)">
        <input type="text" class="otp-input" maxlength="1" oninput="otpMove(this, 4)">
        <input type="text" class="otp-input" maxlength="1" oninput="otpMove(this, 5)">
      </div>
    </div>

    <button class="btn-submit" onclick="doVerify()">تحقق</button>
    <button class="btn-submit" style="background:transparent;color:var(--primary);border:2px solid var(--primary);margin-top:10px" onclick="resendCode()">إعادة إرسال الكود</button>
  </div>
</div>

<script src="js/data.js"></script>
<script>
let pendingEmail = '';

function doRegister() {
  const name = document.getElementById('regName').value.trim();
  const email = document.getElementById('regEmail').value.trim();
  const pass = document.getElementById('regPass').value;
  const pass2 = document.getElementById('regPass2').value;
  const err = document.getElementById('regError');

  if (!name || !email || !pass) {
    err.textContent = 'يرجى ملء جميع الحقول';
    err.style.display = 'block';
    return;
  }
  if (pass.length < 8) {
    err.textContent = 'كلمة المرور يجب أن تكون 8 أحرف على الأقل';
    err.style.display = 'block';
    return;
  }
  if (pass !== pass2) {
    err.textContent = 'كلمتا المرور غير متطابقتين';
    err.style.display = 'block';
    return;
  }

  const result = register(name, email, pass);
  if (!result.success) {
    err.textContent = result.error;
    err.style.display = 'block';
    return;
  }

  pendingEmail = email;
  document.getElementById('step1').style.display = 'none';
  document.getElementById('step2').style.display = 'block';
  document.getElementById('otpMsg').textContent = `تم إرسال كود التحقق إلى ${email} - للتجربة الكود هو: ${result.code}`;
  document.querySelectorAll('.otp-input')[0].focus();
}

function otpMove(input, idx) {
  if (input.value.length === 1 && idx < 5) {
    document.querySelectorAll('.otp-input')[idx + 1].focus();
  }
  if (getOTPValue().length === 6) {
    doVerify();
  }
}

function getOTPValue() {
  return Array.from(document.querySelectorAll('.otp-input')).map(i => i.value).join('');
}

function doVerify() {
  const code = getOTPValue();
  const err = document.getElementById('otpError');
  if (code.length !== 6) {
    err.textContent = 'يرجى إدخال الكود كاملاً';
    err.style.display = 'block';
    return;
  }
  if (!verifyCode(pendingEmail, code)) {
    err.textContent = 'الكود غير صحيح أو منتهي الصلاحية';
    err.style.display = 'block';
    document.querySelectorAll('.otp-input').forEach(i => { i.value = ''; i.style.borderColor = 'var(--danger)'; });
    document.querySelectorAll('.otp-input')[0].focus();
    return;
  }
  window.location.href = 'index.html';
}

function resendCode() {
  const pending = JSON.parse(sessionStorage.getItem('giftstar_pending_verify') || '{}');
  document.getElementById('otpMsg').textContent = `كود التحقق: ${pending.code}`;
}
</script>
</body>
</html>
