<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>إنشاء حساب - Gift Star</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800;900&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="css/style.css">
<style>
.auth-page {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 40px 20px;
    background: linear-gradient(135deg, var(--secondary) 0%, #0a0e1a 100%);
}
.auth-card {
    background: linear-gradient(135deg, var(--secondary-light) 0%, #1a1f2f 100%);
    border-radius: 30px;
    padding: 50px;
    width: 100%;
    max-width: 480px;
    box-shadow: 0 30px 60px rgba(0,0,0,0.5);
    border: 1px solid var(--border);
}
.auth-card h2 {
    font-size: 36px;
    font-weight: 900;
    color: var(--text);
    margin-bottom: 10px;
    text-align: center;
    font-family: 'Playfair Display', serif;
}
.auth-sub {
    text-align: center;
    color: var(--text-muted);
    font-size: 16px;
    margin-bottom: 40px;
}
.form-group {
    margin-bottom: 25px;
}
.form-label {
    display: block;
    font-size: 14px;
    font-weight: 700;
    color: var(--text-muted);
    margin-bottom: 8px;
}
.form-input {
    width: 100%;
    padding: 16px 20px;
    border: 2px solid var(--border);
    border-radius: 15px;
    font-family: var(--font);
    font-size: 16px;
    color: var(--text);
    background: rgba(0,0,0,0.3);
    transition: all 0.3s ease;
}
.form-input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 4px rgba(200,169,110,0.1);
}
.btn-submit {
    width: 100%;
    background: linear-gradient(135deg, var(--primary), var(--primary-light));
    color: var(--secondary);
    border: none;
    padding: 18px;
    border-radius: 15px;
    font-size: 18px;
    font-weight: 800;
    transition: all 0.3s ease;
    cursor: pointer;
    margin-top: 20px;
}
.btn-submit:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 30px rgba(200,169,110,0.4);
}
.btn-submit:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}
.auth-footer {
    text-align: center;
    margin-top: 25px;
    font-size: 15px;
    color: var(--text-muted);
}
.auth-footer a {
    color: var(--primary);
    font-weight: 700;
    text-decoration: none;
}
.alert {
    padding: 16px 20px;
    border-radius: 15px;
    margin-bottom: 25px;
    font-size: 14px;
    font-weight: 600;
    text-align: center;
}
.alert-error {
    background: rgba(224,85,85,0.15);
    color: #ff6b6b;
    border: 1px solid rgba(224,85,85,0.3);
}
.otp-inputs {
    display: flex;
    gap: 10px;
    justify-content: center;
    margin-bottom: 30px;
}
.otp-input {
    width: 60px;
    height: 70px;
    text-align: center;
    font-size: 24px;
    font-weight: 800;
    border: 2px solid var(--border);
    border-radius: 15px;
    background: var(--secondary);
    color: var(--text);
}
.otp-input:focus {
    border-color: var(--primary);
    outline: none;
}
</style>
</head>
<body>
<header class="site-header">
    <div class="header-main">
        <div class="container header-flex">
            <a href="index.html" class="logo">
                <div class="logo-star">★</div>
                <div class="logo-text">
                    <span class="logo-gift">Gift</span>
                    <span class="logo-star-word">Star</span>
                </div>
            </a>
        </div>
    </div>
</header>

<div class="auth-page">
    <div class="auth-card" id="step1">
        <h2>إنشاء حساب</h2>
        <p class="auth-sub">انضم إلى Gift Star</p>

        <div id="regError" class="alert alert-error" style="display:none"></div>

        <div class="form-group">
            <label class="form-label">الاسم الكامل</label>
            <input type="text" id="regName" class="form-input" placeholder="اسمك الكريم">
        </div>
        <div class="form-group">
            <label class="form-label">البريد الإلكتروني</label>
            <input type="email" id="regEmail" class="form-input" placeholder="example@email.com" dir="ltr">
        </div>
        <div class="form-group">
            <label class="form-label">كلمة المرور</label>
            <input type="password" id="regPass" class="form-input" placeholder="8 أحرف على الأقل" dir="ltr">
        </div>
        <div class="form-group">
            <label class="form-label">تأكيد كلمة المرور</label>
            <input type="password" id="regPass2" class="form-input" placeholder="أعد كتابة كلمة المرور" dir="ltr">
        </div>

        <button class="btn-submit" onclick="doRegister()">إنشاء الحساب</button>

        <div class="auth-footer">
            لديك حساب؟ <a href="login.html">تسجيل الدخول</a>
        </div>
    </div>

    <div class="auth-card" id="step2" style="display:none">
        <h2>تحقق من الكود</h2>
        <p class="auth-sub" id="otpMsg">تم إرسال كود التحقق</p>

        <div id="otpError" class="alert alert-error" style="display:none"></div>

        <div class="form-group">
            <div class="otp-inputs" id="otpInputs">
                <input type="text" class="otp-input" maxlength="1" oninput="otpMove(this, 0)">
                <input type="text" class="otp-input" maxlength="1" oninput="otpMove(this, 1)">
                <input type="text" class="otp-input" maxlength="1" oninput="otpMove(this, 2)">
                <input type="text" class="otp-input" maxlength="1" oninput="otpMove(this, 3)">
                <input type="text" class="otp-input" maxlength="1" oninput="otpMove(this, 4)">
                <input type="text" class="otp-input" maxlength="1" oninput="otpMove(this, 5)">
            </div>
        </div>

        <button class="btn-submit" onclick="doVerify()">تحقق</button>
        <button class="btn-submit" style="background:transparent;color:var(--primary);border:2px solid var(--primary);margin-top:10px" onclick="resendCode()">إعادة إرسال الكود</button>
    </div>
</div>

<script src="js/data.js"></script>
<script src="js/main.js"></script>
<script>
let pendingEmail = '';

function doRegister() {
    const name = document.getElementById('regName').value.trim();
    const email = document.getElementById('regEmail').value.trim();
    const pass = document.getElementById('regPass').value;
    const pass2 = document.getElementById('regPass2').value;
    const err = document.getElementById('regError');

    if (!name || !email || !pass) {
        err.textContent = 'يرجى ملء جميع الحقول';
        err.style.display = 'block';
        return;
    }
    if (pass.length < 8) {
        err.textContent = 'كلمة المرور يجب أن تكون 8 أحرف على الأقل';
        err.style.display = 'block';
        return;
    }
    if (pass !== pass2) {
        err.textContent = 'كلمتا المرور غير متطابقتين';
        err.style.display = 'block';
        return;
    }

    const users = JSON.parse(localStorage.getItem('giftstar_users') || '[]');
    if (users.find(u => u.email === email)) {
        err.textContent = 'البريد الإلكتروني مسجل مسبقاً';
        err.style.display = 'block';
        return;
    }

    const code = Math.floor(100000 + Math.random() * 900000).toString();
    const newUser = {
        id: Date.now(),
        name, email, password: pass,
        role: 'customer', verified: false, verifyCode: code,
        createdAt: new Date().toISOString(), phone: ''
    };

    users.push(newUser);
    localStorage.setItem('giftstar_users', JSON.stringify(users));
    sessionStorage.setItem('giftstar_pending_verify', JSON.stringify({ email, code }));

    pendingEmail = email;
    document.getElementById('step1').style.display = 'none';
    document.getElementById('step2').style.display = 'block';
    document.getElementById('otpMsg').textContent = `تم إرسال الكود إلى ${email} - للاختبار: ${code}`;
    document.querySelectorAll('.otp-input')[0].focus();
}

function otpMove(input, idx) {
    if (input.value.length === 1 && idx < 5) {
        document.querySelectorAll('.otp-input')[idx + 1].focus();
    }
    if (getOTPValue().length === 6) doVerify();
}

function getOTPValue() {
    return Array.from(document.querySelectorAll('.otp-input')).map(i => i.value).join('');
}

function doVerify() {
    const code = getOTPValue();
    const err = document.getElementById('otpError');
    const pending = JSON.parse(sessionStorage.getItem('giftstar_pending_verify') || '{}');

    if (code.length !== 6) {
        err.textContent = 'يرجى إدخال الكود كاملاً';
        err.style.display = 'block';
        return;
    }

    if (pending.code !== code) {
        err.textContent = 'الكود غير صحيح';
        err.style.display = 'block';
        return;
    }

    const users = JSON.parse(localStorage.getItem('giftstar_users') || '[]');
    const userIndex = users.findIndex(u => u.email === pending.email);
    if (userIndex !== -1) {
        users[userIndex].verified = true;
        delete users[userIndex].verifyCode;
        localStorage.setItem('giftstar_users', JSON.stringify(users));

        const user = users[userIndex];
        sessionStorage.setItem('giftstar_user', JSON.stringify({
            id: user.id, name: user.name, email: user.email, role: user.role
        }));
    }

    sessionStorage.removeItem('giftstar_pending_verify');
    window.location.href = 'index.html';
}

function resendCode() {
    const pending = JSON.parse(sessionStorage.getItem('giftstar_pending_verify') || '{}');
    document.getElementById('otpMsg').textContent = `تم إعادة إرسال الكود: ${pending.code}`;
}
</script>

<!-- كود Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getFirestore } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyCtHnYZT8yq9tp7xaA7AyJQV4Ag4Wi1Yks",
    authDomain: "gift-star-abf48.firebaseapp.com",
    projectId: "gift-star-abf48",
    storageBucket: "gift-star-abf48.firebasestorage.app",
    messagingSenderId: "546782076914",
    appId: "1:546782076914:web:3fb957a03c7e0501fc556b"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

window.db = db;
console.log('✅ Firebase loaded');
</script>

<!-- Firebase Messaging -->
<script>
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/firebase-messaging-sw.js').catch(console.error);
}
</script>
</body>
</html>
