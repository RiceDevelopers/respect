<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ุงููุชุฌุฑ - Gift Star</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800;900&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="css/style.css">
</head>
<body>
<header class="site-header">
  <div class="header-top">
    <div class="container">
      <span class="header-tagline">ุชูุตูู ุฏุงุฎู ุงููููุช ููุท</span>
      <div class="header-links">
        <a href="cart.html" class="cart-link">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="9" cy="21" r="1"/>
            <circle cx="20" cy="21" r="1"/>
            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
          </svg>
          <span class="cart-count" id="cartCount">0</span>
        </a>
        <a href="login.html" class="btn-login" id="loginBtn">ุชุณุฌูู ุงูุฏุฎูู</a>
        <a href="#" class="btn-login" id="logoutBtn" style="display:none" onclick="logout()">ุฎุฑูุฌ</a>
      </div>
    </div>
  </div>
  <div class="header-main">
    <div class="container header-flex">
      <a href="index.html" class="logo">
        <div class="logo-star">โ</div>
        <div class="logo-text">
          <span class="logo-gift">Gift</span>
          <span class="logo-star-word">Star</span>
        </div>
      </a>
      <nav class="main-nav">
        <a href="index.html">ุงูุฑุฆูุณูุฉ</a>
        <a href="shop.html" class="active">ุงููุชุฌุฑ</a>
        <a href="shop.html?cat=cakes">ููู</a>
        <a href="shop.html?cat=flowers">ูุฑุฏ</a>
        <a href="shop.html?cat=gifts">ูุฏุงูุง</a>
      </nav>
    </div>
  </div>
</header>

<div class="page-hero">
  <h1>ุชุณูู ูุฏุงูุงู</h1>
  <p>ุงูุชุดู ุฃุฌูู ุชุดูููุฉ ูู ุงูููู ูุงููุฑุฏ ูุงููุฏุงูุง ุงููููุชูุฉ</p>
</div>

<div class="container">
  <div class="shop-layout">
    <aside class="shop-sidebar">
      <div class="sidebar-section">
        <h3>ุงููุฆุงุช</h3>
        <button class="filter-btn active" onclick="filterByCategory('all', this)">ุฌููุน ุงูููุชุฌุงุช</button>
        <button class="filter-btn" onclick="filterByCategory('cakes', this)">ููู</button>
        <button class="filter-btn" onclick="filterByCategory('flowers', this)">ูุฑุฏ</button>
        <button class="filter-btn" onclick="filterByCategory('gifts', this)">ูุฏุงูุง</button>
        <button class="filter-btn" onclick="filterByCategory('chocolate', this)">ุดููููุงุชุฉ</button>
      </div>
      <div class="sidebar-section" style="margin-top:24px">
        <h3>ุงูุณุนุฑ (ุฏ.ู)</h3>
        <div style="display:flex;gap:8px;margin-top:8px">
          <input type="number" id="priceMin" placeholder="ูู" class="form-input" style="padding:8px;font-size:13px">
          <input type="number" id="priceMax" placeholder="ุฅูู" class="form-input" style="padding:8px;font-size:13px">
        </div>
        <button class="btn-primary" style="margin-top:10px;width:100%;padding:9px" onclick="filterByPrice()">ุชุทุจูู</button>
      </div>
    </aside>

    <div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
        <span id="resultsCount" style="color:var(--text-muted);font-size:14px"></span>
        <select class="form-select" style="width:auto;padding:8px 14px;font-size:14px" onchange="sortProducts(this.value)" id="sortSelect">
          <option value="default">ุงูุชุฑุชูุจ ุงูุงูุชุฑุงุถู</option>
          <option value="price-asc">ุงูุณุนุฑ: ูู ุงูุฃูู ููุฃุนูู</option>
          <option value="price-desc">ุงูุณุนุฑ: ูู ุงูุฃุนูู ููุฃูู</option>
        </select>
      </div>
      <div class="products-grid" id="productsGrid">
        <div class="loading"><div class="spinner"></div>ุฌุงุฑู ุงูุชุญููู...</div>
      </div>
    </div>
  </div>
</div>

<footer class="site-footer">
  <div class="footer-bottom" style="padding:20px 0">
    <p>ยฉ 2024 Gift Star. ุฌููุน ุงูุญููู ูุญููุธุฉ - ุงููููุช</p>
  </div>
</footer>

<div class="stars-bg"></div>

<script src="js/data.js"></script>
<script>
let allProducts = [];
let filteredProducts = [];
let currentCategory = 'all';

// ุชููุฆุฉ ุงูุตูุญุฉ
function init() {
  // ุชุญุฏูุซ ุงูููุฏุฑ
  if (typeof giftstar !== 'undefined' && giftstar.updateHeader) {
    giftstar.updateHeader();
  } else {
    updateHeaderLocal();
  }
  
  // ุฌูุจ ุงูููุชุฌุงุช
  if (typeof giftstar !== 'undefined' && giftstar.getProducts) {
    allProducts = giftstar.getProducts({ active: true });
  } else {
    // Fallback
    allProducts = getData('products', []).filter(p => p.active);
  }
  
  console.log('Products loaded:', allProducts.length);
  
  // ุงูุชุญูู ูู ูุฌูุฏ ููุชุฑ ูู ุงูุฑุงุจุท
  const params = new URLSearchParams(window.location.search);
  const cat = params.get('cat');
  if (cat) {
    currentCategory = cat;
    // ุชุญุฏูุซ ุงูุฃุฒุฑุงุฑ
    document.querySelectorAll('.filter-btn').forEach(b => {
      b.classList.remove('active');
      if ((cat === 'cakes' && b.textContent.includes('ููู')) ||
          (cat === 'flowers' && b.textContent.includes('ูุฑุฏ')) ||
          (cat === 'gifts' && b.textContent.includes('ูุฏุงูุง')) ||
          (cat === 'chocolate' && b.textContent.includes('ุดููููุงุชุฉ'))) {
        b.classList.add('active');
      }
    });
  }
  
  // ุนุฑุถ ุงูููุชุฌุงุช
  renderShopProducts();
}

// ุนุฑุถ ุงูููุชุฌุงุช
function renderShopProducts() {
  const grid = document.getElementById('productsGrid');
  
  // ุชุตููุฉ ุงูููุชุฌุงุช ุญุณุจ ุงููุฆุฉ
  filteredProducts = currentCategory === 'all' 
    ? [...allProducts] 
    : allProducts.filter(p => p.category === currentCategory);

  // ุชุทุจูู ุงูุชุฑุชูุจ
  const sort = document.getElementById('sortSelect').value;
  if (sort === 'price-asc') {
    filteredProducts.sort((a,b) => a.price - b.price);
  } else if (sort === 'price-desc') {
    filteredProducts.sort((a,b) => b.price - a.price);
  }

  // ุชุญุฏูุซ ุนุฏุฏ ุงููุชุงุฆุฌ
  document.getElementById('resultsCount').textContent = `๐ฆ ${filteredProducts.length} ููุชุฌ`;

  // ุฅุฐุง ูุง ูู ููุชุฌุงุช
  if (!filteredProducts.length) {
    grid.innerHTML = '<div class="loading" style="grid-column:1/-1">ูุง ุชูุฌุฏ ููุชุฌุงุช ูู ูุฐู ุงููุฆุฉ</div>';
    return;
  }

  // ุนุฑุถ ุงูููุชุฌุงุช
  grid.innerHTML = filteredProducts.map(p => `
    <div class="product-card" onclick="window.location.href='product.html?id=${p.id}'" style="cursor:pointer">
      ${p.badge ? `<span class="product-badge">${p.badge}</span>` : ''}
      <img src="${p.image}" alt="${p.name}" class="product-img" loading="lazy" onerror="this.src='https://images.unsplash.com/photo-1549465220-1a8b9238cd48?w=400&h=300&fit=crop'">
      <div class="product-info">
        <h3 class="product-name">${p.name}</h3>
        <p class="product-desc">${p.description.substring(0,70)}...</p>
        <div class="product-footer">
          <div class="product-price">${formatPrice(p.price)}</div>
          <button class="btn-add-cart" onclick="event.stopPropagation();handleAddToCart(${p.id}, this)">ุฃุถู ููุณูุฉ</button>
        </div>
      </div>
    </div>
  `).join('');
}

// ุชุตููุฉ ุญุณุจ ุงููุฆุฉ
function filterByCategory(cat, btn) {
  currentCategory = cat;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderShopProducts();
}

// ุชุฑุชูุจ ุงูููุชุฌุงุช
function sortProducts(val) { 
  renderShopProducts(); 
}

// ุชุตููุฉ ุญุณุจ ุงูุณุนุฑ
function filterByPrice() {
  const min = parseFloat(document.getElementById('priceMin').value) || 0;
  const max = parseFloat(document.getElementById('priceMax').value) || Infinity;
  
  filteredProducts = allProducts.filter(p => 
    (currentCategory === 'all' || p.category === currentCategory) &&
    p.price >= min && p.price <= max
  );
  
  const grid = document.getElementById('productsGrid');
  document.getElementById('resultsCount').textContent = `๐ฆ ${filteredProducts.length} ููุชุฌ`;
  
  if (!filteredProducts.length) {
    grid.innerHTML = '<div class="loading" style="grid-column:1/-1">ูุง ุชูุฌุฏ ููุชุฌุงุช ุจูุฐุง ุงููุทุงู ุงูุณุนุฑู</div>';
    return;
  }
  
  grid.innerHTML = filteredProducts.map(p => `
    <div class="product-card" onclick="window.location.href='product.html?id=${p.id}'" style="cursor:pointer">
      ${p.badge ? `<span class="product-badge">${p.badge}</span>` : ''}
      <img src="${p.image}" alt="${p.name}" class="product-img" loading="lazy" onerror="this.src='https://images.unsplash.com/photo-1549465220-1a8b9238cd48?w=400&h=300&fit=crop'">
      <div class="product-info">
        <h3 class="product-name">${p.name}</h3>
        <p class="product-desc">${p.description.substring(0,70)}...</p>
        <div class="product-footer">
          <div class="product-price">${formatPrice(p.price)}</div>
          <button class="btn-add-cart" onclick="event.stopPropagation();handleAddToCart(${p.id}, this)">ุฃุถู ููุณูุฉ</button>
        </div>
      </div>
    </div>
  `).join('');
}

// ุฅุถุงูุฉ ููุณูุฉ
function handleAddToCart(productId, btn) {
  const user = giftstar ? giftstar.getCurrentUser() : getCurrentUser();
  
  if (!user) {
    sessionStorage.setItem('giftstar_redirect_after_login', window.location.href);
    window.location.href = 'login.html?msg=login_required';
    return;
  }
  
  if (giftstar && giftstar.addToCart) {
    giftstar.addToCart(productId);
  } else {
    addToCart(productId);
  }
  
  btn.textContent = 'โ ุชูุช ุงูุฅุถุงูุฉ';
  btn.style.background = 'var(--success)';
  
  setTimeout(() => {
    btn.textContent = 'ุฃุถู ููุณูุฉ';
    btn.style.background = '';
  }, 1500);
  
  if (giftstar && giftstar.showNotification) {
    giftstar.showNotification('ุชูุช ุฅุถุงูุฉ ุงูููุชุฌ ููุณูุฉ', 'success');
  } else {
    showNotification('ุชูุช ุฅุถุงูุฉ ุงูููุชุฌ ููุณูุฉ', 'success');
  }
}

// ุชูุณูู ุงูุณุนุฑ
function formatPrice(price) {
  if (giftstar && giftstar.formatKWD) {
    return giftstar.formatKWD(price);
  }
  return price.toFixed(3) + ' ุฏ.ู';
}

// ุฏูุงู ูุณุงุนุฏุฉ ูุญููุฉ (ูุดู safe)
function getData(key, fallback) {
  try {
    const v = localStorage.getItem('giftstar_' + key);
    return v ? JSON.parse(v) : fallback;
  } catch { return fallback; }
}

function getCurrentUser() {
  try {
    return JSON.parse(sessionStorage.getItem('giftstar_user'));
  } catch { return null; }
}

function addToCart(productId, qty = 1) {
  const products = getData('products', []);
  const product = products.find(p => p.id === productId);
  if (!product) return false;

  let cart = getData('cart', []);
  const existing = cart.find(i => i.id === productId);
  
  if (existing) {
    existing.qty += qty;
  } else {
    cart.push({ 
      id: productId, 
      qty, 
      name: product.name, 
      price: product.price, 
      image: product.image 
    });
  }
  
  localStorage.setItem('giftstar_cart', JSON.stringify(cart));
  updateCartBadgeLocal();
  return true;
}

function updateCartBadgeLocal() {
  try {
    const cart = JSON.parse(localStorage.getItem('giftstar_cart') || '[]');
    const total = cart.reduce((s, i) => s + i.qty, 0);
    document.querySelectorAll('.cart-count, #cartCount').forEach(el => {
      if (el) el.textContent = total;
    });
  } catch (e) {
    console.error('Error updating cart badge:', e);
  }
}

function updateHeaderLocal() {
  const user = getCurrentUser();
  const loginBtn = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  
  if (!loginBtn) return;
  
  if (user) {
    loginBtn.style.display = 'none';
    if (logoutBtn) logoutBtn.style.display = 'inline-block';
  } else {
    loginBtn.style.display = 'inline-block';
    if (logoutBtn) logoutBtn.style.display = 'none';
  }
  
  updateCartBadgeLocal();
}

function showNotification(msg, type) {
  const el = document.createElement('div');
  el.className = 'notification ' + (type || 'success');
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 3000);
}

function logout() {
  sessionStorage.removeItem('giftstar_user');
  window.location.href = 'index.html';
}

// ุชุดุบูู ุงูุชููุฆุฉ
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
