<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨ - Gift Star</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800;900&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="css/style.css">
</head>
<body>
<header class="site-header">
  <div class="header-top">
    <div class="container">
      <span class="header-tagline">ØªÙˆØµÙŠÙ„ Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒÙˆÙŠØª ÙÙ‚Ø·</span>
      <div class="header-links">
        <a href="cart.html" class="cart-link">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="9" cy="21" r="1"/>
            <circle cx="20" cy="21" r="1"/>
            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
          </svg>
          <span class="cart-count" id="cartCount">0</span>
        </a>
        <a href="login.html" class="btn-login" id="loginBtn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a>
        <a href="#" class="btn-login" id="logoutBtn" style="display:none" onclick="logout()">Ø®Ø±ÙˆØ¬</a>
      </div>
    </div>
  </div>
  <div class="header-main">
    <div class="container header-flex">
      <a href="index.html" class="logo">
        <div class="logo-star">â˜…</div>
        <div class="logo-text">
          <span class="logo-gift">Gift</span>
          <span class="logo-star-word">Star</span>
        </div>
      </a>
      <div class="checkout-steps">
        <span class="step active">1. Ø§Ù„Ø³Ù„Ø©</span>
        <span class="step active">2. Ø§Ù„ØªÙˆØµÙŠÙ„</span>
        <span class="step active">3. Ø§Ù„Ø¯ÙØ¹</span>
      </div>
      <nav class="main-nav">
        <a href="index.html">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
        <a href="shop.html">Ø§Ù„Ù…ØªØ¬Ø±</a>
      </nav>
    </div>
  </div>
</header>

<div class="container checkout-page">
  <div class="checkout-grid">
    <!-- Ø§Ù„Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø£ÙŠÙ…Ù† - Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙˆØµÙŠÙ„ ÙˆØ§Ù„Ø¯ÙØ¹ -->
    <div>
      <!-- Ù…Ø¤Ø´Ø± Ø§Ù„ØªÙ‚Ø¯Ù… -->
      <div class="checkout-progress">
        <div class="progress-bar">
          <div class="progress-fill" style="width: 100%"></div>
        </div>
      </div>

      <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙˆØµÙŠÙ„ -->
      <div class="checkout-section">
        <h3>
          <span class="section-icon">ğŸ“</span>
          Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙˆØµÙŠÙ„
        </h3>
        
        <div class="form-group">
          <label class="form-label">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ <span class="required">*</span></label>
          <input type="text" id="delivName" class="form-input" placeholder="Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ±ÙŠÙ…" required>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ <span class="required">*</span></label>
            <input type="tel" id="delivPhone" class="form-input" placeholder="05xxxxxxxx" dir="ltr" maxlength="10" required>
          </div>
          
          <div class="form-group">
            <label class="form-label">Ø§Ù„Ù…Ù†Ø·Ù‚Ø© <span class="required">*</span></label>
            <select id="delivArea" class="form-select" required>
              <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</option>
              <option value="Ø§Ù„Ø¹Ø§ØµÙ…Ø©">Ø§Ù„Ø¹Ø§ØµÙ…Ø©</option>
              <option value="Ø­ÙˆÙ„ÙŠ">Ø­ÙˆÙ„ÙŠ</option>
              <option value="Ø§Ù„ÙØ±ÙˆØ§Ù†ÙŠØ©">Ø§Ù„ÙØ±ÙˆØ§Ù†ÙŠØ©</option>
              <option value="Ù…Ø¨Ø§Ø±Ùƒ Ø§Ù„ÙƒØ¨ÙŠØ±">Ù…Ø¨Ø§Ø±Ùƒ Ø§Ù„ÙƒØ¨ÙŠØ±</option>
              <option value="Ø§Ù„Ø£Ø­Ù…Ø¯ÙŠ">Ø§Ù„Ø£Ø­Ù…Ø¯ÙŠ</option>
              <option value="Ø§Ù„Ø¬Ù‡Ø±Ø§Ø¡">Ø§Ù„Ø¬Ù‡Ø±Ø§Ø¡</option>
            </select>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙØµÙŠÙ„ÙŠ <span class="required">*</span></label>
          <textarea id="delivAddress" class="form-textarea" rows="2" placeholder="Ø§Ø³Ù… Ø§Ù„Ø´Ø§Ø±Ø¹ØŒ Ø±Ù‚Ù… Ø§Ù„Ù…Ø¨Ù†Ù‰ØŒ Ø±Ù‚Ù… Ø§Ù„Ø´Ù‚Ø©..." required></textarea>
        </div>
        
        <div class="form-group">
          <label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <textarea id="delivNotes" class="form-textarea" rows="2" placeholder="Ø£ÙŠ ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø®Ø§ØµØ© Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨..."></textarea>
        </div>
      </div>

      <!-- Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹ -->
      <div class="checkout-section">
        <h3>
          <span class="section-icon">ğŸ’³</span>
          Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹
        </h3>
        
        <div class="payment-methods" id="paymentMethods">
          <!-- ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø·Ø±Ù‚ Ø§Ù„Ø¯ÙØ¹ Ù‡Ù†Ø§ -->
          <div class="loading"><div class="spinner"></div>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø·Ø±Ù‚ Ø§Ù„Ø¯ÙØ¹...</div>
        </div>

        <!-- Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø§Ø¦ØªÙ…Ø§Ù†ÙŠØ© -->
        <div class="payment-form" id="cardForm" style="display:none;">
          <div class="form-group">
            <label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</label>
            <input type="text" id="cardNum" class="form-input" placeholder="xxxx xxxx xxxx xxxx" maxlength="19" dir="ltr" oninput="formatCard(this)">
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</label>
              <input type="text" id="cardExp" class="form-input" placeholder="MM/YY" maxlength="5" dir="ltr" oninput="formatExp(this)">
            </div>
            <div class="form-group">
              <label class="form-label">CVV</label>
              <input type="text" id="cardCvv" class="form-input" placeholder="â€¢â€¢â€¢" maxlength="3" dir="ltr">
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">Ø§Ø³Ù… Ø­Ø§Ù…Ù„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</label>
            <input type="text" id="cardName" class="form-input" placeholder="Ø§Ù„Ø§Ø³Ù… ÙƒÙ…Ø§ Ù‡Ùˆ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©" dir="ltr">
          </div>
        </div>

        <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨Ù†ÙƒÙŠ -->
        <div id="bankInfo" style="display:none;" class="bank-info">
          <div class="bank-details">
            <h4>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨Ù†ÙƒÙŠ:</h4>
            <p><strong>IBAN:</strong> KW91NBOK0000000000001000372151</p>
            <p><strong>Ø§Ù„Ø¨Ù†Ùƒ:</strong> Ø¨Ù†Ùƒ Ø§Ù„ÙƒÙˆÙŠØª Ø§Ù„ÙˆØ·Ù†ÙŠ</p>
            <p><strong>Ø§Ù„Ù…Ø³ØªÙÙŠØ¯:</strong> Ø´Ø±ÙƒØ© Ø¬ÙØª Ø³ØªØ§Ø±</p>
            <div class="bank-note">
              âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ ØµÙˆØ±Ø© Ø§Ù„Ø¥ÙŠØµØ§Ù„ Ø¹Ø¨Ø± Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­ÙˆÙŠÙ„
            </div>
          </div>
        </div>

        <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¯ÙØ¹ Ù†Ù‚Ø¯Ø§Ù‹ -->
        <div id="cashInfo" style="display:none;" class="cash-info">
          <div class="info-box">
            <p>ğŸ“¦ Ø³ÙŠØªÙ… Ø§Ù„Ø¯ÙØ¹ Ù†Ù‚Ø¯Ø§Ù‹ Ø¹Ù†Ø¯ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø·Ù„Ø¨</p>
            <p class="small">ÙŠØ±Ø¬Ù‰ ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</p>
          </div>
        </div>
      </div>

      <!-- Ø²Ø± Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨ -->
      <button class="btn-primary checkout-btn" onclick="placeOrder()" id="placeOrderBtn">
        <span>Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨</span>
        <span class="btn-total" id="btnTotal"></span>
      </button>

      <!-- Ø´Ø±ÙˆØ· ÙˆØ£Ø­ÙƒØ§Ù… -->
      <p class="checkout-terms">
        Ø¨Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ "Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨" ÙØ¥Ù†Ùƒ ØªÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ 
        <a href="#">Ø´Ø±ÙˆØ· Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…</a> Ùˆ <a href="#">Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©</a>
      </p>
    </div>

    <!-- Ø§Ù„Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø£ÙŠØ³Ø± - Ù…Ù„Ø®Øµ Ø§Ù„Ø·Ù„Ø¨ -->
    <div>
      <div class="checkout-section summary-section">
        <h3>
          <span class="section-icon">ğŸ›’</span>
          Ù…Ù„Ø®Øµ Ø§Ù„Ø·Ù„Ø¨
        </h3>
        
        <div id="orderItems" class="order-items-list"></div>
        
        <div class="summary-details">
          <div class="summary-row">
            <span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ</span>
            <span class="summary-value" id="chkSubtotal">0.000 Ø¯.Ùƒ</span>
          </div>
          <div class="summary-row">
            <span>Ø±Ø³ÙˆÙ… Ø§Ù„ØªÙˆØµÙŠÙ„</span>
            <span class="summary-value" id="chkDelivery">1.500 Ø¯.Ùƒ</span>
          </div>
          <div class="summary-row discount-row" id="discountRow" style="display:none;">
            <span>Ø®ØµÙ…</span>
            <span class="summary-value discount" id="chkDiscount">-0.000 Ø¯.Ùƒ</span>
          </div>
          <div class="summary-total">
            <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</span>
            <span class="total-value" id="chkTotal">0.000 Ø¯.Ùƒ</span>
          </div>
        </div>

        <!-- ÙƒÙˆØ¯ Ø®ØµÙ… -->
        <div class="promo-code">
          <input type="text" id="promoCode" class="form-input" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø®ØµÙ…">
          <button class="btn-outline small" onclick="applyPromo()">ØªØ·Ø¨ÙŠÙ‚</button>
        </div>

        <!-- Ø¶Ù…Ø§Ù†Ø§Øª -->
        <div class="checkout-guarantees">
          <div class="guarantee-item">
            <span class="guarantee-icon">âœ“</span>
            <span>Ø¯ÙØ¹ Ø¢Ù…Ù† 100%</span>
          </div>
          <div class="guarantee-item">
            <span class="guarantee-icon">âœ“</span>
            <span>ØªÙˆØµÙŠÙ„ ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ…</span>
          </div>
          <div class="guarantee-item">
            <span class="guarantee-icon">âœ“</span>
            <span>Ù…Ù†ØªØ¬Ø§Øª Ø·Ø§Ø²Ø¬Ø© ÙˆØ¬ÙˆØ¯Ø© Ù…Ø¶Ù…ÙˆÙ†Ø©</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ -->
<div class="modal-overlay" id="confirmModal">
  <div class="modal-card">
    <div class="modal-header">
      <h3>ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨</h3>
      <button class="modal-close" onclick="closeConfirmModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <p>Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨ØŸ</p>
      <div id="confirmDetails"></div>
    </div>
    <div class="modal-footer">
      <button class="btn-outline" onclick="closeConfirmModal()">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="btn-primary" onclick="processOrder()">ØªØ£ÙƒÙŠØ¯ ÙˆØ¥ØªÙ…Ø§Ù…</button>
    </div>
  </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ù†Ø¬Ø§Ø­ Ø§Ù„Ø·Ù„Ø¨ -->
<div class="modal-overlay" id="successModal">
  <div class="modal-card success-card">
    <div class="modal-body" style="text-align: center; padding: 40px;">
      <div class="success-icon">âœ“</div>
      <h3 style="color: var(--success); margin: 20px 0;">ØªÙ… Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­!</h3>
      <p>Ø³ÙŠØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ù‚Ø±ÙŠØ¨Ø§Ù‹ Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨</p>
      <div style="margin-top: 30px;">
        <a href="receipt.html" class="btn-primary">Ø¹Ø±Ø¶ Ø§Ù„Ø¥ÙŠØµØ§Ù„</a>
        <a href="index.html" class="btn-outline" style="margin-right: 10px;">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
      </div>
    </div>
  </div>
</div>

<footer class="site-footer">
  <div class="footer-bottom">
    <p>Â© 2024 Gift Star. Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© - Ø§Ù„ÙƒÙˆÙŠØª</p>
  </div>
</footer>

<div class="stars-bg"></div>

<script src="js/data.js"></script>
<script>
let selectedPayment = null;
let paymentMethods = [];
let appliedPromo = null;
let orderTotal = 0;

// ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø©
async function init() {
  const user = giftstar.getCurrentUser();
  
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
  if (!user) { 
    sessionStorage.setItem('giftstar_redirect_after_login', 'checkout.html');
    window.location.href = 'login.html?msg=login_required'; 
    return; 
  }

  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ø§Ù„Ø³Ù„Ø©
  const cart = giftstar.getCart();
  if (!cart.length) { 
    window.location.href = 'cart.html'; 
    return; 
  }

  // ØªØ¹Ø¨Ø¦Ø© Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
  document.getElementById('delivName').value = user.name || '';
  
  // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³Ù„Ø©
  updateCartCount();
  
  // Ø­Ø³Ø§Ø¨ ÙˆØ¹Ø±Ø¶ Ù…Ù„Ø®Øµ Ø§Ù„Ø·Ù„Ø¨
  calculateOrderTotal();
  
  // ØªØ­Ù…ÙŠÙ„ Ø·Ø±Ù‚ Ø§Ù„Ø¯ÙØ¹
  await loadPaymentMethods();
}

// Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨
function calculateOrderTotal() {
  const cart = giftstar.getCart();
  const subtotal = giftstar.getCartTotal();
  const delivery = subtotal > 15 ? 0 : 1.500;
  
  let discount = 0;
  if (appliedPromo) {
    discount = subtotal * 0.1; // 10% Ø®ØµÙ…
  }
  
  orderTotal = subtotal + delivery - discount;

  // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
  document.getElementById('orderItems').innerHTML = cart.map(item => `
    <div class="order-item">
      <div class="item-info">
        <img src="${item.image}" alt="${item.name}" class="item-image" onerror="this.src='https://images.unsplash.com/photo-1549465220-1a8b9238cd48?w=50&h=50&fit=crop'">
        <div class="item-details">
          <div class="item-name">${item.name}</div>
          <div class="item-quantity">Ø§Ù„ÙƒÙ…ÙŠØ©: ${item.qty}</div>
        </div>
      </div>
      <div class="item-price">${giftstar.formatKWD(item.price * item.qty)}</div>
    </div>
  `).join('');

  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª
  document.getElementById('chkSubtotal').textContent = giftstar.formatKWD(subtotal);
  document.getElementById('chkDelivery').textContent = delivery === 0 ? 'Ù…Ø¬Ø§Ù†ÙŠ' : giftstar.formatKWD(delivery);
  document.getElementById('chkTotal').textContent = giftstar.formatKWD(orderTotal);
  document.getElementById('btnTotal').textContent = giftstar.formatKWD(orderTotal);
  
  if (discount > 0) {
    document.getElementById('discountRow').style.display = 'flex';
    document.getElementById('chkDiscount').textContent = '-' + giftstar.formatKWD(discount);
  }
}

// ØªØ­Ù…ÙŠÙ„ Ø·Ø±Ù‚ Ø§Ù„Ø¯ÙØ¹
async function loadPaymentMethods() {
  try {
    paymentMethods = await giftstar.getData('payment_methods') || [];
    paymentMethods = paymentMethods.filter(m => m.active);
    
    const icons = {
      card: `<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="1" y="4" width="22" height="16" rx="2"/>
        <line x1="1" y1="10" x2="23" y2="10"/>
      </svg>`,
      bank: `<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M3 22V12M7 22V12M11 22V12M15 22V12M19 22V12M1 12l11-9 11 9"/>
      </svg>`,
      cash: `<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="2" y="7" width="20" height="14" rx="2"/>
        <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/>
      </svg>`,
      knet: `<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="2" y="5" width="20" height="14" rx="2"/>
        <path d="M2 10h20"/>
      </svg>`
    };

    document.getElementById('paymentMethods').innerHTML = paymentMethods.map(m => `
      <div class="payment-method" onclick="selectPayment('${m.icon}', this, ${m.id})" id="pm_${m.id}">
        <input type="radio" name="payment" value="${m.id}">
        <div class="payment-icon">${icons[m.icon] || icons.cash}</div>
        <div class="payment-method-label">
          <strong>${m.name}</strong>
          <span>${m.description}</span>
        </div>
      </div>
    `).join('');

    // Ø§Ø®ØªÙŠØ§Ø± Ø£ÙˆÙ„ Ø·Ø±ÙŠÙ‚Ø© Ø¯ÙØ¹ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹
    if (paymentMethods.length > 0) {
      selectPayment(
        paymentMethods[0].icon, 
        document.getElementById('pm_' + paymentMethods[0].id), 
        paymentMethods[0].id
      );
    }
  } catch (error) {
    console.error('Error loading payment methods:', error);
    document.getElementById('paymentMethods').innerHTML = `
      <div class="error-message">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø·Ø±Ù‚ Ø§Ù„Ø¯ÙØ¹</div>
    `;
  }
}

// Ø§Ø®ØªÙŠØ§Ø± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹
function selectPayment(icon, el, id) {
  selectedPayment = id;
  document.querySelectorAll('.payment-method').forEach(m => {
    m.classList.remove('selected');
    m.querySelector('input').checked = false;
  });
  el.classList.add('selected');
  el.querySelector('input').checked = true;

  // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨
  document.getElementById('cardForm').style.display = icon === 'card' ? 'block' : 'none';
  document.getElementById('bankInfo').style.display = icon === 'bank' ? 'block' : 'none';
  document.getElementById('cashInfo').style.display = icon === 'cash' ? 'block' : 'none';
}

// ØªÙ†Ø³ÙŠÙ‚ Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
function formatCard(input) {
  let v = input.value.replace(/\D/g, '').substring(0, 16);
  input.value = v.replace(/(.{4})/g, '$1 ').trim();
}

// ØªÙ†Ø³ÙŠÙ‚ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
function formatExp(input) {
  let v = input.value.replace(/\D/g, '');
  if (v.length >= 2) v = v.substring(0, 2) + '/' + v.substring(2, 4);
  input.value = v;
}

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
function validateForm() {
  const name = document.getElementById('delivName').value.trim();
  const phone = document.getElementById('delivPhone').value.trim();
  const area = document.getElementById('delivArea').value;
  const address = document.getElementById('delivAddress').value.trim();

  if (!name) {
    giftstar.showNotification('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù…', 'error');
    document.getElementById('delivName').focus();
    return false;
  }
  
  if (!phone) {
    giftstar.showNotification('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ', 'error');
    document.getElementById('delivPhone').focus();
    return false;
  }
  
  if (phone.length !== 10 || !phone.startsWith('05')) {
    giftstar.showNotification('Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 10 Ø£Ø±Ù‚Ø§Ù… ÙˆÙŠØ¨Ø¯Ø£ Ø¨Ù€ 05', 'error');
    document.getElementById('delivPhone').focus();
    return false;
  }
  
  if (!area) {
    giftstar.showNotification('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©', 'error');
    document.getElementById('delivArea').focus();
    return false;
  }
  
  if (!address) {
    giftstar.showNotification('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†', 'error');
    document.getElementById('delivAddress').focus();
    return false;
  }
  
  if (!selectedPayment) {
    giftstar.showNotification('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹', 'error');
    return false;
  }

  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø¥Ø°Ø§ ØªÙ… Ø§Ø®ØªÙŠØ§Ø±Ù‡Ø§
  const method = paymentMethods.find(m => m.id === selectedPayment);
  if (method && method.icon === 'card') {
    const cardNum = document.getElementById('cardNum').value.replace(/\s/g, '');
    const cardExp = document.getElementById('cardExp').value;
    const cardCvv = document.getElementById('cardCvv').value;
    const cardName = document.getElementById('cardName').value.trim();
    
    if (cardNum.length !== 16) {
      giftstar.showNotification('Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ØºÙŠØ± ØµØ­ÙŠØ­', 'error');
      return false;
    }
    
    if (!cardExp || !cardExp.includes('/')) {
      giftstar.showNotification('ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ ØºÙŠØ± ØµØ­ÙŠØ­', 'error');
      return false;
    }
    
    if (cardCvv.length !== 3) {
      giftstar.showNotification('Ø±Ù…Ø² CVV ØºÙŠØ± ØµØ­ÙŠØ­', 'error');
      return false;
    }
    
    if (!cardName) {
      giftstar.showNotification('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø­Ø§Ù…Ù„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©', 'error');
      return false;
    }
  }

  return true;
}

// Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨
async function placeOrder() {
  if (!validateForm()) return;
  
  // Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯
  const method = paymentMethods.find(m => m.id === selectedPayment);
  
  document.getElementById('confirmDetails').innerHTML = `
    <div style="margin-top: 20px; padding: 15px; background: var(--secondary); border-radius: var(--radius);">
      <p><strong>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹:</strong> ${method?.name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
      <p><strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</strong> ${giftstar.formatKWD(orderTotal)}</p>
    </div>
  `;
  
  document.getElementById('confirmModal').classList.add('open');
}

// Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯
function closeConfirmModal() {
  document.getElementById('confirmModal').classList.remove('open');
}

// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨
async function processOrder() {
  closeConfirmModal();
  
  // Ø¥Ø¸Ù‡Ø§Ø± Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
  const btn = document.getElementById('placeOrderBtn');
  const originalText = btn.innerHTML;
  btn.innerHTML = '<span class="spinner small"></span> Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨...';
  btn.disabled = true;

  try {
    const name = document.getElementById('delivName').value.trim();
    const phone = document.getElementById('delivPhone').value.trim();
    const area = document.getElementById('delivArea').value;
    const address = document.getElementById('delivAddress').value.trim();
    const notes = document.getElementById('delivNotes').value.trim();
    
    const user = giftstar.getCurrentUser();
    const cart = giftstar.getCart();
    const subtotal = giftstar.getCartTotal();
    const delivery = subtotal > 15 ? 0 : 1.500;
    
    const method = paymentMethods.find(m => m.id === selectedPayment);
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨
    const order = await giftstar.createOrder({
      customer: { 
        name, 
        phone, 
        area, 
        address, 
        notes 
      },
      items: cart,
      subtotal: subtotal,
      delivery: delivery,
      total: orderTotal,
      paymentMethod: method ? method.name : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
      paymentIcon: method ? method.icon : 'cash',
      userId: user.id,
      userEmail: user.email,
      status: 'new'
    });
    
    // ØªÙØ±ÙŠØº Ø§Ù„Ø³Ù„Ø©
    giftstar.clearCart();
    
    // Ø­ÙØ¸ Ø¢Ø®Ø± Ø·Ù„Ø¨
    sessionStorage.setItem('giftstar_last_order', JSON.stringify(order));
    
    // Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
    document.getElementById('successModal').classList.add('open');
    
  } catch (error) {
    console.error('Error placing order:', error);
    giftstar.showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨', 'error');
    
    // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø²Ø± Ù„Ø­Ø§Ù„ØªÙ‡ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠØ©
    btn.innerHTML = originalText;
    btn.disabled = false;
  }
}

// ØªØ·Ø¨ÙŠÙ‚ ÙƒÙˆØ¯ Ø®ØµÙ…
function applyPromo() {
  const code = document.getElementById('promoCode').value.trim();
  
  if (code === 'GIFT10' || code === 'STAR20') {
    appliedPromo = code;
    calculateOrderTotal();
    giftstar.showNotification('ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø®ØµÙ… Ø¨Ù†Ø¬Ø§Ø­', 'success');
  } else {
    giftstar.showNotification('ÙƒÙˆØ¯ Ø§Ù„Ø®ØµÙ… ØºÙŠØ± ØµØ§Ù„Ø­', 'error');
  }
}

// ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³Ù„Ø©
function updateCartCount() {
  const cart = giftstar.getCart();
  const total = cart.reduce((sum, item) => sum + item.qty, 0);
  document.querySelectorAll('.cart-count').forEach(el => {
    el.textContent = total;
  });
}

// ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
function logout() {
  giftstar.logout();
}

// Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
document.addEventListener('DOMContentLoaded', init);
</script>

<style>
/* Ø£Ù†Ù…Ø§Ø· Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ù€ Checkout */
.checkout-steps {
  display: flex;
  align-items: center;
  gap: 10px;
  color: var(--text-muted);
}

.checkout-steps .step {
  font-size: 14px;
  font-weight: 600;
  padding: 5px 10px;
  border-radius: 20px;
  background: var(--secondary);
}

.checkout-steps .step.active {
  background: var(--primary);
  color: var(--secondary);
}

.checkout-progress {
  margin-bottom: 20px;
}

.progress-bar {
  height: 4px;
  background: var(--border);
  border-radius: 2px;
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--primary), var(--primary-light));
  transition: width 0.3s ease;
}

.section-icon {
  font-size: 20px;
  margin-left: 8px;
}

.form-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 15px;
}

.required {
  color: var(--danger);
  margin-right: 3px;
}

.payment-method {
  display: flex;
  align-items: center;
  gap: 15px;
  padding: 15px;
  border: 2px solid var(--border);
  border-radius: var(--radius);
  margin-bottom: 10px;
  cursor: pointer;
  transition: var(--transition);
}

.payment-method:hover {
  border-color: var(--primary);
  transform: translateX(-5px);
}

.payment-method.selected {
  border-color: var(--primary);
  background: linear-gradient(135deg, rgba(200,169,110,0.1), rgba(226,201,142,0.1));
}

.payment-icon {
  color: var(--primary);
}

.bank-info, .cash-info {
  margin-top: 20px;
  padding: 20px;
  background: var(--secondary);
  border-radius: var(--radius);
  border: 1px solid var(--border);
}

.bank-details h4 {
  color: var(--primary);
  margin-bottom: 10px;
}

.bank-details p {
  margin: 8px 0;
  font-size: 14px;
}

.bank-note {
  margin-top: 15px;
  padding: 10px;
  background: rgba(243,156,18,0.1);
  border-radius: var(--radius-sm);
  color: #f39c12;
  font-size: 13px;
}

.info-box {
  padding: 15px;
  background: rgba(200,169,110,0.1);
  border-radius: var(--radius);
}

.info-box .small {
  font-size: 13px;
  color: var(--text-muted);
  margin-top: 5px;
}

.checkout-btn {
  width: 100%;
  padding: 18px !important;
  font-size: 18px !important;
  margin: 20px 0 15px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.btn-total {
  background: rgba(0,0,0,0.2);
  padding: 5px 15px;
  border-radius: 30px;
  font-size: 16px;
}

.checkout-terms {
  text-align: center;
  font-size: 13px;
  color: var(--text-muted);
}

.checkout-terms a {
  color: var(--primary);
  text-decoration: underline;
}

.summary-section {
  position: sticky;
  top: 100px;
}

.order-items-list {
  max-height: 300px;
  overflow-y: auto;
  margin-bottom: 20px;
  padding-left: 10px;
}

.order-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 0;
  border-bottom: 1px solid var(--border);
}

.item-info {
  display: flex;
  align-items: center;
  gap: 10px;
}

.item-image {
  width: 50px;
  height: 50px;
  border-radius: 8px;
  object-fit: cover;
}

.item-details {
  flex: 1;
}

.item-name {
  font-weight: 600;
  color: var(--text);
  font-size: 14px;
}

.item-quantity {
  font-size: 12px;
  color: var(--text-muted);
}

.item-price {
  font-weight: 700;
  color: var(--primary);
}

.summary-details {
  background: var(--secondary);
  padding: 15px;
  border-radius: var(--radius);
  margin: 15px 0;
}

.summary-row {
  display: flex;
  justify-content: space-between;
  padding: 8px 0;
  color: var(--text-muted);
}

.discount-row {
  color: var(--success);
}

.summary-total {
  display: flex;
  justify-content: space-between;
  padding: 15px 0 0;
  margin-top: 10px;
  border-top: 2px solid var(--border);
  font-size: 18px;
  font-weight: 700;
  color: var(--text);
}

.total-value {
  color: var(--primary);
  font-size: 20px;
}

.promo-code {
  display: flex;
  gap: 10px;
  margin: 20px 0;
}

.promo-code .form-input {
  flex: 1;
}

.promo-code .btn-outline {
  padding: 10px 20px;
  font-size: 14px;
}

.checkout-guarantees {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
  margin-top: 20px;
  padding-top: 20px;
  border-top: 1px solid var(--border);
}

.guarantee-item {
  display: flex;
  align-items: center;
  gap: 5px;
  font-size: 12px;
  color: var(--text-muted);
}

.guarantee-icon {
  color: var(--success);
  font-weight: 700;
}

.spinner.small {
  width: 20px;
  height: 20px;
  border-width: 2px;
  display: inline-block;
  margin-left: 8px;
  vertical-align: middle;
}

.success-card {
  max-width: 400px;
}

.success-icon {
  width: 80px;
  height: 80px;
  background: var(--success);
  color: white;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 40px;
  margin: 0 auto;
  animation: scaleIn 0.5s ease;
}

@keyframes scaleIn {
  from { transform: scale(0); }
  to { transform: scale(1); }
}

@media (max-width: 768px) {
  .form-row {
    grid-template-columns: 1fr;
  }
  
  .checkout-guarantees {
    grid-template-columns: 1fr;
    gap: 5px;
  }
  
  .checkout-btn {
    font-size: 16px !important;
    padding: 15px !important;
  }
}
</style>
</body>
</html>
