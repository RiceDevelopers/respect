<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>إتمام الطلب - Gift Star</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800;900&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="css/style.css">
</head>
<body>
<header class="site-header">
  <div class="header-main">
    <div class="container header-flex">
      <a href="index.html" class="logo">
        <div class="logo-star">★</div>
        <div class="logo-text"><span class="logo-gift">Gift</span><span class="logo-star-word">Star</span></div>
      </a>
      <div style="color:var(--text-muted);font-size:14px;display:flex;align-items:center;gap:8px">
        <span style="font-weight:600;color:var(--primary)">1 السلة</span> &rsaquo;
        <span style="font-weight:600;color:var(--primary)">2 التوصيل</span> &rsaquo;
        <span style="font-weight:600;color:var(--primary)">3 الدفع</span>
      </div>
    </div>
  </div>
</header>

<div class="container checkout-page">
  <div class="checkout-grid">
    <div>
      <!-- Delivery Info -->
      <div class="checkout-section">
        <h3>معلومات التوصيل</h3>
        <div class="form-group">
          <label class="form-label">الاسم الكامل</label>
          <input type="text" id="delivName" class="form-input" placeholder="اسمك الكريم">
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
          <div class="form-group">
            <label class="form-label">رقم الهاتف</label>
            <input type="tel" id="delivPhone" class="form-input" placeholder="05xxxxxxxx" dir="ltr">
          </div>
          <div class="form-group">
            <label class="form-label">المنطقة</label>
            <select id="delivArea" class="form-select">
              <option value="">اختر المنطقة</option>
              <option>العاصمة</option>
              <option>حولي</option>
              <option>الفروانية</option>
              <option>مبارك الكبير</option>
              <option>الأحمدي</option>
              <option>الجهراء</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">العنوان التفصيلي</label>
          <textarea id="delivAddress" class="form-textarea" rows="2" placeholder="اسم الشارع، رقم المبنى، رقم الشقة..."></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">ملاحظات إضافية (اختياري)</label>
          <textarea id="delivNotes" class="form-textarea" rows="2" placeholder="أي تعليمات خاصة للمندوب..."></textarea>
        </div>
      </div>

      <!-- Payment Methods -->
      <div class="checkout-section">
        <h3>طريقة الدفع</h3>
        <div class="payment-methods" id="paymentMethods">
          <!-- Loaded dynamically -->
        </div>

        <!-- Card form -->
        <div class="payment-form" id="cardForm" style="display:none;margin-top:20px;padding-top:20px;border-top:1px solid var(--border)">
          <div class="form-group">
            <label class="form-label">رقم البطاقة</label>
            <input type="text" id="cardNum" class="form-input" placeholder="xxxx xxxx xxxx xxxx" maxlength="19" dir="ltr" oninput="formatCard(this)">
          </div>
          <div class="card-row">
            <div class="form-group">
              <label class="form-label">تاريخ الانتهاء</label>
              <input type="text" id="cardExp" class="form-input" placeholder="MM/YY" maxlength="5" dir="ltr" oninput="formatExp(this)">
            </div>
            <div class="form-group">
              <label class="form-label">CVV</label>
              <input type="text" id="cardCvv" class="form-input" placeholder="•••" maxlength="3" dir="ltr">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">اسم حامل البطاقة</label>
            <input type="text" id="cardName" class="form-input" placeholder="الاسم كما هو على البطاقة" dir="ltr">
          </div>
        </div>

        <!-- Bank Transfer -->
        <div id="bankInfo" style="display:none;margin-top:16px;background:#f8f5f0;border-radius:8px;padding:16px;font-size:14px">
          <strong style="display:block;margin-bottom:8px">بيانات التحويل البنكي:</strong>
          <div>IBAN: KW91NBOK0000000000001000372151</div>
          <div>البنك: بنك الكويت الوطني</div>
          <div>الاسم: شركة جفت ستار</div>
          <div style="margin-top:8px;color:var(--primary);font-weight:600">يرجى إرسال إيصال التحويل على الواتساب</div>
        </div>
      </div>

      <button class="btn-primary" style="width:100%;padding:16px;font-size:17px;border-radius:30px" onclick="placeOrder()">
        ادفع الآن وأكمل الطلب
      </button>
    </div>

    <!-- Order Summary -->
    <div>
      <div class="checkout-section">
        <h3>ملخص الطلب</h3>
        <div id="orderItems"></div>
        <div class="summary-row" style="margin-top:16px">
          <span>المجموع الفرعي</span>
          <span id="chkSubtotal"></span>
        </div>
        <div class="summary-row">
          <span>التوصيل</span>
          <span id="chkDelivery"></span>
        </div>
        <div class="summary-total">
          <span>الإجمالي</span>
          <span id="chkTotal"></span>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="js/data.js"></script>
<script>
let selectedPayment = null;

function init() {
  const user = getCurrentUser();
  if (!user) { window.location.href = 'login.html'; return; }

  const cart = getCart();
  if (!cart.length) { window.location.href = 'cart.html'; return; }

  // Fill user name
  document.getElementById('delivName').value = user.name || '';

  // Render cart items
  const subTotal = getCartTotal();
  const delivery = subTotal > 15 ? 0 : 1.500;
  const total = subTotal + delivery;

  document.getElementById('orderItems').innerHTML = cart.map(i => `
    <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);font-size:14px">
      <span>${i.name} x${i.qty}</span>
      <span style="font-weight:700">${(i.price * i.qty).toFixed(3)} د.ك</span>
    </div>
  `).join('');

  document.getElementById('chkSubtotal').textContent = subTotal.toFixed(3) + ' د.ك';
  document.getElementById('chkDelivery').textContent = delivery === 0 ? 'مجاني' : delivery.toFixed(3) + ' د.ك';
  document.getElementById('chkTotal').textContent = total.toFixed(3) + ' د.ك';

  // Load payment methods
  const methods = getData('payment_methods', []).filter(m => m.active && m.id !== 2);
  const icons = {
    card: `<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>`,
    bank: `<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 22V12M7 22V12M11 22V12M15 22V12M19 22V12M1 12l11-9 11 9"/></svg>`,
    cash: `<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>`,
    knet: `<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="5" width="20" height="14" rx="2"/><path d="M2 10h20"/></svg>`
  };

  document.getElementById('paymentMethods').innerHTML = methods.map(m => `
    <div class="payment-method" onclick="selectPayment('${m.icon}', this, ${m.id})" id="pm_${m.id}">
      <input type="radio" name="payment" value="${m.id}">
      <div class="payment-icon">${icons[m.icon] || icons.cash}</div>
      <div class="payment-method-label">
        <strong>${m.name}</strong>
        <span>${m.description}</span>
      </div>
    </div>
  `).join('');

  if (methods.length > 0) {
    selectPayment(methods[0].icon, document.getElementById('pm_' + methods[0].id), methods[0].id);
  }
}

function selectPayment(icon, el, id) {
  selectedPayment = id;
  document.querySelectorAll('.payment-method').forEach(m => {
    m.classList.remove('selected');
    m.querySelector('input').checked = false;
  });
  el.classList.add('selected');
  el.querySelector('input').checked = true;

  document.getElementById('cardForm').style.display = icon === 'card' ? 'block' : 'none';
  document.getElementById('bankInfo').style.display = icon === 'bank' ? 'block' : 'none';
}

function formatCard(input) {
  let v = input.value.replace(/\D/g, '').substring(0, 16);
  input.value = v.replace(/(.{4})/g, '$1 ').trim();
}

function formatExp(input) {
  let v = input.value.replace(/\D/g, '');
  if (v.length >= 2) v = v.substring(0, 2) + '/' + v.substring(2, 4);
  input.value = v;
}

function placeOrder() {
  const name = document.getElementById('delivName').value.trim();
  const phone = document.getElementById('delivPhone').value.trim();
  const area = document.getElementById('delivArea').value;
  const address = document.getElementById('delivAddress').value.trim();

  if (!name || !phone || !area || !address) {
    showNotification('يرجى ملء جميع بيانات التوصيل', 'error');
    return;
  }
  if (!selectedPayment) {
    showNotification('يرجى اختيار طريقة الدفع', 'error');
    return;
  }

  const methods = getData('payment_methods', []);
  const method = methods.find(m => m.id === selectedPayment);

  // Validate card
  if (method && method.icon === 'card') {
    const cardNum = document.getElementById('cardNum').value.replace(/\s/g, '');
    const cardExp = document.getElementById('cardExp').value;
    const cardCvv = document.getElementById('cardCvv').value;
    if (cardNum.length !== 16 || !cardExp || cardCvv.length !== 3) {
      showNotification('يرجى إدخال بيانات البطاقة كاملة', 'error');
      return;
    }
  }

  const cart = getCart();
  const user = getCurrentUser();
  const subTotal = getCartTotal();
  const delivery = subTotal > 15 ? 0 : 1.500;

  const order = createOrder({
    customer: { name, phone, area, address, notes: document.getElementById('delivNotes').value },
    items: cart,
    subtotal: subTotal,
    delivery,
    total: subTotal + delivery,
    paymentMethod: method ? method.name : 'غير محدد',
    userId: user.id,
    userEmail: user.email
  });

  sessionStorage.setItem('giftstar_last_order', JSON.stringify(order));
  window.location.href = 'receipt.html';
}

function showNotification(msg, type) {
  const el = document.createElement('div');
  el.className = 'notification ' + (type || '');
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 3500);
}

init();
</script>
</body>
</html>
