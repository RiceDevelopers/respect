<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨ - Gift Star</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800;900&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="css/style.css">
<style>
/* Ø£Ù†Ù…Ø§Ø· ØµÙØ­Ø© Ø§Ù„Ø¯ÙØ¹ */
.checkout-page { padding: 50px 0; }
.checkout-grid { display: grid; grid-template-columns: 1fr 420px; gap: 40px; }
.checkout-section {
    background: var(--secondary-light);
    border-radius: var(--radius-lg);
    padding: 35px;
    border: 1px solid var(--border);
    margin-bottom: 25px;
}
.payment-methods { display: flex; flex-direction: column; gap: 15px; }
.payment-method {
    display: flex; align-items: center; gap: 15px; padding: 15px;
    border: 2px solid var(--border); border-radius: var(--radius);
    cursor: pointer; transition: all 0.3s ease;
}
.payment-method:hover { border-color: var(--primary); transform: translateX(-5px); }
.payment-method.selected {
    border-color: var(--primary);
    background: linear-gradient(135deg, rgba(200,169,110,0.1), rgba(226,201,142,0.1));
}
.payment-icon { color: var(--primary); font-size: 24px; width: 40px; text-align: center; }
.payment-form, .bank-info, .cash-info {
    margin-top: 20px; padding: 20px;
    background: var(--secondary); border-radius: var(--radius);
    border: 1px solid var(--border);
}
</style>
</head>
<body>
<header class="site-header">[Ù†ÙØ³ Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø³Ø§Ø¨Ù‚]</header>

<div class="container checkout-page">
    <div class="checkout-grid">
        <div>
            <div class="checkout-section">
                <h3>ğŸ“ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙˆØµÙŠÙ„</h3>
                <div class="form-group">
                    <label class="form-label">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ *</label>
                    <input type="text" id="delivName" class="form-input" required>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                    <div class="form-group">
                        <label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ *</label>
                        <input type="tel" id="delivPhone" class="form-input" maxlength="8" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ø§Ù„Ù…Ù†Ø·Ù‚Ø© *</label>
                        <select id="delivArea" class="form-select" required>
                            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</option>
                            <option value="Ø§Ù„Ø¹Ø§ØµÙ…Ø©">Ø§Ù„Ø¹Ø§ØµÙ…Ø©</option>
                            <option value="Ø­ÙˆÙ„ÙŠ">Ø­ÙˆÙ„ÙŠ</option>
                            <option value="Ø§Ù„ÙØ±ÙˆØ§Ù†ÙŠØ©">Ø§Ù„ÙØ±ÙˆØ§Ù†ÙŠØ©</option>
                            <option value="Ù…Ø¨Ø§Ø±Ùƒ Ø§Ù„ÙƒØ¨ÙŠØ±">Ù…Ø¨Ø§Ø±Ùƒ Ø§Ù„ÙƒØ¨ÙŠØ±</option>
                            <option value="Ø§Ù„Ø£Ø­Ù…Ø¯ÙŠ">Ø§Ù„Ø£Ø­Ù…Ø¯ÙŠ</option>
                            <option value="Ø§Ù„Ø¬Ù‡Ø±Ø§Ø¡">Ø§Ù„Ø¬Ù‡Ø±Ø§Ø¡</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙØµÙŠÙ„ÙŠ *</label>
                    <textarea id="delivAddress" class="form-textarea" rows="2" required></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</label>
                    <textarea id="delivNotes" class="form-textarea" rows="2"></textarea>
                </div>
            </div>

            <div class="checkout-section">
                <h3>ğŸ’³ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</h3>
                <div class="payment-methods" id="paymentMethods"></div>

                <div class="payment-form" id="cardForm" style="display:none;">
                    <h4>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</h4>
                    <div class="form-group">
                        <label>Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</label>
                        <input type="text" id="cardNum" class="form-input" maxlength="19" dir="ltr">
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                        <div class="form-group">
                            <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</label>
                            <input type="text" id="cardExp" class="form-input" maxlength="5" dir="ltr">
                        </div>
                        <div class="form-group">
                            <label>CVV</label>
                            <input type="text" id="cardCvv" class="form-input" maxlength="3" dir="ltr">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Ø§Ø³Ù… Ø­Ø§Ù…Ù„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</label>
                        <input type="text" id="cardName" class="form-input" dir="ltr">
                    </div>
                </div>

                <div class="bank-info" id="bankInfo" style="display:none;">
                    <h4>ğŸ¦ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨Ù†ÙƒÙŠ</h4>
                    <p><strong>IBAN:</strong> KW91NBOK0000000000001000372151</p>
                    <p><strong>Ø§Ù„Ø¨Ù†Ùƒ:</strong> Ø¨Ù†Ùƒ Ø§Ù„ÙƒÙˆÙŠØª Ø§Ù„ÙˆØ·Ù†ÙŠ</p>
                    <p><strong>Ø§Ù„Ù…Ø³ØªÙÙŠØ¯:</strong> Ø´Ø±ÙƒØ© Ø¬ÙØª Ø³ØªØ§Ø±</p>
                    <p><strong>Ø§Ù„Ù…Ø¨Ù„Øº:</strong> <span id="bankAmount">0.000 Ø¯.Ùƒ</span></p>
                </div>

                <div class="cash-info" id="cashInfo" style="display:none;">
                    <h4>ğŸ’° Ø§Ù„Ø¯ÙØ¹ Ù†Ù‚Ø¯Ø§Ù‹</h4>
                    <p>Ø³ÙŠØªÙ… Ø§Ù„Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</p>
                    <p>Ø§Ù„Ù…Ø¨Ù„Øº: <strong id="cashAmount">0.000 Ø¯.Ùƒ</strong></p>
                </div>
            </div>

            <button class="btn-primary" style="width:100%; padding:18px; font-size:18px;" onclick="placeOrder()" id="placeOrderBtn">
                Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨ <span style="background:rgba(0,0,0,0.2); padding:5px 15px; border-radius:30px; margin-right:10px;" id="btnTotal"></span>
            </button>
        </div>

        <div>
            <div class="checkout-section">
                <h3>ğŸ›’ Ù…Ù„Ø®Øµ Ø§Ù„Ø·Ù„Ø¨</h3>
                <div id="orderItems" style="max-height:300px; overflow-y:auto; margin-bottom:20px;"></div>
                <div style="background:var(--secondary); padding:15px; border-radius:var(--radius);">
                    <div style="display:flex; justify-content:space-between; padding:8px 0;">
                        <span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ</span><span id="chkSubtotal">0.000 Ø¯.Ùƒ</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; padding:8px 0;">
                        <span>Ø±Ø³ÙˆÙ… Ø§Ù„ØªÙˆØµÙŠÙ„</span><span id="chkDelivery">1.500 Ø¯.Ùƒ</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; padding:15px 0 0; margin-top:10px; border-top:2px solid var(--border); font-size:18px; font-weight:700;">
                        <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span>
                        <span style="color:var(--primary);" id="chkTotal">0.000 Ø¯.Ùƒ</span>
                    </div>
                </div>
                <div style="display:flex; gap:10px; margin:20px 0;">
                    <input type="text" id="promoCode" class="form-input" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ø®ØµÙ…">
                    <button class="btn-outline" onclick="applyPromo()">ØªØ·Ø¨ÙŠÙ‚</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© -->
<div class="modal-overlay" id="confirmModal" style="display:none;">
    <div class="modal-card">
        <div class="modal-header"><h3>ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨</h3><button class="modal-close" onclick="closeConfirmModal()">âœ•</button></div>
        <div class="modal-body">
            <p>Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ</p>
            <div id="confirmDetails" style="margin-top:20px; padding:15px; background:var(--secondary);"></div>
        </div>
        <div class="modal-footer">
            <button class="btn-outline" onclick="closeConfirmModal()">Ø¥Ù„ØºØ§Ø¡</button>
            <button class="btn-primary" onclick="processOrder()">ØªØ£ÙƒÙŠØ¯</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="successModal" style="display:none;">
    <div class="modal-card" style="max-width:400px;">
        <div class="modal-body" style="text-align:center; padding:40px;">
            <div style="width:80px; height:80px; background:var(--success); color:white; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:40px; margin:0 auto;">âœ“</div>
            <h3 style="color:var(--success); margin:20px 0;">ØªÙ… Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­!</h3>
            <div style="margin-top:30px;">
                <a href="receipt.html" class="btn-primary">Ø¹Ø±Ø¶ Ø§Ù„Ø¥ÙŠØµØ§Ù„</a>
                <a href="index.html" class="btn-outline" style="margin-right:10px;">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
            </div>
        </div>
    </div>
</div>

<footer class="site-footer"><div class="footer-bottom"><p>Â© 2024 Gift Star</p></div></footer>
<div class="stars-bg"></div>

<script src="js/data.js"></script>
<script src="js/main.js"></script>
<script>
let selectedPayment = null, paymentMethods = [], appliedPromo = null, orderTotal = 0;

document.addEventListener('DOMContentLoaded', () => {
    if (window.updateHeader) window.updateHeader();

    const user = window.getCurrentUser ? window.getCurrentUser() : null;
    if (!user) {
        sessionStorage.setItem('giftstar_redirect_after_login', 'checkout.html');
        window.location.href = 'login.html?msg=login_required';
        return;
    }

    const cart = window.getCart ? window.getCart() : [];
    if (!cart || cart.length === 0) {
        window.location.href = 'cart.html';
        return;
    }

    const nameInput = document.getElementById('delivName');
    if (nameInput && user.name) nameInput.value = user.name;

    loadPaymentMethods();
    calculateOrderTotal();
});

function loadPaymentMethods() {
    paymentMethods = window.getPaymentMethods ? window.getPaymentMethods() : [
        { id: 1, name: "Ø¨Ø·Ø§Ù‚Ø© Ø§Ø¦ØªÙ…Ø§Ù†ÙŠØ©", description: "Visa, Mastercard", icon: "card" },
        { id: 2, name: "ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ", description: "ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ", icon: "bank" },
        { id: 3, name: "Ù†Ù‚Ø¯Ø§Ù‹", description: "Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…", icon: "cash" }
    ];

    const icons = {
        card: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>',
        bank: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 22V12M7 22V12M11 22V12M15 22V12M19 22V12M1 12l11-9 11 9"/></svg>',
        cash: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>'
    };

    document.getElementById('paymentMethods').innerHTML = paymentMethods.map(m => `
        <div class="payment-method" onclick="selectPayment('${m.icon}', this, ${m.id})" id="pm_${m.id}">
            <input type="radio" name="payment">
            <div class="payment-icon">${icons[m.icon]}</div>
            <div class="payment-method-label">
                <strong>${m.name}</strong>
                <span>${m.description}</span>
            </div>
        </div>
    `).join('');

    if (paymentMethods.length) {
        setTimeout(() => selectPayment(paymentMethods[0].icon, document.getElementById('pm_' + paymentMethods[0].id), paymentMethods[0].id), 100);
    }
}

window.selectPayment = (icon, element, id) => {
    selectedPayment = id;
    document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('selected'));
    element.classList.add('selected');
    element.querySelector('input[type="radio"]').checked = true;

    document.getElementById('cardForm').style.display = icon === 'card' ? 'block' : 'none';
    document.getElementById('bankInfo').style.display = icon === 'bank' ? 'block' : 'none';
    document.getElementById('cashInfo').style.display = icon === 'cash' ? 'block' : 'none';
}

function calculateOrderTotal() {
    const cart = window.getCart ? window.getCart() : [];
    const subtotal = cart.reduce((s, i) => s + (i.price || 0) * (i.qty || 0), 0);
    const delivery = subtotal > 15 ? 0 : 1.5;
    const discount = appliedPromo ? subtotal * 0.1 : 0;
    orderTotal = subtotal + delivery - discount;
    const format = window.formatKWD || (a => a.toFixed(3) + ' Ø¯.Ùƒ');

    document.getElementById('orderItems').innerHTML = cart.map(item => `
        <div style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid var(--border);">
            <div><strong>${item.name}</strong> x${item.qty}</div>
            <div>${format(item.price * item.qty)}</div>
        </div>
    `).join('');

    document.getElementById('chkSubtotal').textContent = format(subtotal);
    document.getElementById('chkDelivery').textContent = delivery === 0 ? 'Ù…Ø¬Ø§Ù†ÙŠ' : format(delivery);
    document.getElementById('chkTotal').textContent = format(orderTotal);
    document.getElementById('btnTotal').textContent = format(orderTotal);

    if (document.getElementById('bankAmount')) document.getElementById('bankAmount').textContent = format(orderTotal);
    if (document.getElementById('cashAmount')) document.getElementById('cashAmount').textContent = format(orderTotal);
}

function validateForm() {
    const name = document.getElementById('delivName')?.value.trim();
    const phone = document.getElementById('delivPhone')?.value.trim();
    const area = document.getElementById('delivArea')?.value;
    const address = document.getElementById('delivAddress')?.value.trim();

    if (!name || !phone || !area || !address || !selectedPayment) {
        alert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©');
        return false;
    }
    if (phone.length !== 8 || !/^[569]\d{7}$/.test(phone)) {
        alert('Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± ØµØ­ÙŠØ­');
        return false;
    }
    return true;
}

window.placeOrder = () => {
    if (!validateForm()) return;
    document.getElementById('confirmModal').style.display = 'flex';
}

window.closeConfirmModal = () => document.getElementById('confirmModal').style.display = 'none';

window.processOrder = async () => {
    closeConfirmModal();
    const btn = document.getElementById('placeOrderBtn');
    btn.innerHTML = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...';
    btn.disabled = true;

    try {
        const orderData = {
            customer: {
                name: document.getElementById('delivName').value,
                phone: document.getElementById('delivPhone').value,
                area: document.getElementById('delivArea').value,
                address: document.getElementById('delivAddress').value,
                notes: document.getElementById('delivNotes').value
            },
            items: window.getCart(),
            total: orderTotal,
            paymentMethod: paymentMethods.find(m => m.id === selectedPayment)?.name
        };

        const result = window.createOrder ? await window.createOrder(orderData) : null;
        if (result?.success) {
            document.getElementById('successModal').style.display = 'flex';
        }
    } catch (e) {
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£');
        btn.innerHTML = 'Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨';
        btn.disabled = false;
    }
}

window.applyPromo = () => {
    const code = document.getElementById('promoCode').value;
    if (['GIFT10', 'STAR20', 'WELCOME15'].includes(code)) {
        appliedPromo = code;
        calculateOrderTotal();
        alert('ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø®ØµÙ…');
    } else alert('ÙƒÙˆØ¯ ØºÙŠØ± ØµØ§Ù„Ø­');
}

window.logout = () => { if (window.logout) window.logout(); }
</script>

<!-- ÙƒÙˆØ¯ Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getFirestore } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyCtHnYZT8yq9tp7xaA7AyJQV4Ag4Wi1Yks",
    authDomain: "gift-star-abf48.firebaseapp.com",
    projectId: "gift-star-abf48",
    storageBucket: "gift-star-abf48.firebasestorage.app",
    messagingSenderId: "546782076914",
    appId: "1:546782076914:web:3fb957a03c7e0501fc556b"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

window.db = db;
console.log('âœ… Firebase loaded');
</script>

<!-- Firebase Messaging -->
<script>
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/firebase-messaging-sw.js').catch(console.error);
}
</script>
</body>
</html>
